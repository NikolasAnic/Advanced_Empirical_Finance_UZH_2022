<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Factor Models | Advanced Empirical Finance</title>
  <meta name="description" content="Chapter 8 Factor Models | Advanced Empirical Finance" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Factor Models | Advanced Empirical Finance" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Factor Models | Advanced Empirical Finance" />
  
  
  

<meta name="author" content="Nikolas Anic &amp; Lorenz Gassmann" />


<meta name="date" content="2022-02-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="portfolio-theory-mean-variance-optimisation-and-the-capm.html"/>

<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.10.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Advanced Empirical Finance - Lab Course</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction to the course objectives and organisation of the course</a></li>
<li class="chapter" data-level="2" data-path="the-programming-environment.html"><a href="the-programming-environment.html"><i class="fa fa-check"></i><b>2</b> The Programming Environment</a>
<ul>
<li class="chapter" data-level="2.1" data-path="the-programming-environment.html"><a href="the-programming-environment.html#markdown-files"><i class="fa fa-check"></i><b>2.1</b> Markdown Files</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="the-programming-environment.html"><a href="the-programming-environment.html#how-to-create-a-markdown-file"><i class="fa fa-check"></i><b>2.1.1</b> How to create a Markdown File</a></li>
<li class="chapter" data-level="2.1.2" data-path="the-programming-environment.html"><a href="the-programming-environment.html#the-r-markdown-structure"><i class="fa fa-check"></i><b>2.1.2</b> The R Markdown Structure</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="the-programming-environment.html"><a href="the-programming-environment.html#coding-in-r---a-concise-overview"><i class="fa fa-check"></i><b>2.2</b> Coding In R - A concise overview</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="the-programming-environment.html"><a href="the-programming-environment.html#introduction"><i class="fa fa-check"></i><b>2.2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2.2" data-path="the-programming-environment.html"><a href="the-programming-environment.html#vectors"><i class="fa fa-check"></i><b>2.2.2</b> Vectors</a></li>
<li class="chapter" data-level="2.2.3" data-path="the-programming-environment.html"><a href="the-programming-environment.html#data-types"><i class="fa fa-check"></i><b>2.2.3</b> Data Types</a></li>
<li class="chapter" data-level="2.2.4" data-path="the-programming-environment.html"><a href="the-programming-environment.html#data-frames"><i class="fa fa-check"></i><b>2.2.4</b> Data Frames</a></li>
<li class="chapter" data-level="2.2.5" data-path="the-programming-environment.html"><a href="the-programming-environment.html#importing-data"><i class="fa fa-check"></i><b>2.2.5</b> Importing Data</a></li>
<li class="chapter" data-level="2.2.6" data-path="the-programming-environment.html"><a href="the-programming-environment.html#data-manipulation"><i class="fa fa-check"></i><b>2.2.6</b> Data Manipulation</a></li>
<li class="chapter" data-level="2.2.7" data-path="the-programming-environment.html"><a href="the-programming-environment.html#data-reshaping"><i class="fa fa-check"></i><b>2.2.7</b> Data Reshaping</a></li>
<li class="chapter" data-level="2.2.8" data-path="the-programming-environment.html"><a href="the-programming-environment.html#beautiful-graphs-with-ggplot2"><i class="fa fa-check"></i><b>2.2.8</b> Beautiful Graphs with <code>ggplot2</code></a></li>
<li class="chapter" data-level="2.2.9" data-path="the-programming-environment.html"><a href="the-programming-environment.html#dates-and-times"><i class="fa fa-check"></i><b>2.2.9</b> Dates and Times</a></li>
<li class="chapter" data-level="2.2.10" data-path="the-programming-environment.html"><a href="the-programming-environment.html#string-manipulations-in-r-the-stringr-package"><i class="fa fa-check"></i><b>2.2.10</b> String Manipulations in R: The <code>stringr()</code> package</a></li>
<li class="chapter" data-level="2.2.11" data-path="the-programming-environment.html"><a href="the-programming-environment.html#database-queries"><i class="fa fa-check"></i><b>2.2.11</b> Database Queries</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="statistical-properties.html"><a href="statistical-properties.html"><i class="fa fa-check"></i><b>3</b> Statistical Properties</a>
<ul>
<li class="chapter" data-level="3.1" data-path="statistical-properties.html"><a href="statistical-properties.html#random-variables-and-probability-distributions-introdcution"><i class="fa fa-check"></i><b>3.1</b> Random Variables and Probability Distributions: Introdcution</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="statistical-properties.html"><a href="statistical-properties.html#the-concept-of-probability-important-notions-and-definitions"><i class="fa fa-check"></i><b>3.1.1</b> The concept of Probability: Important Notions and Definitions</a></li>
<li class="chapter" data-level="3.1.2" data-path="statistical-properties.html"><a href="statistical-properties.html#random-variables"><i class="fa fa-check"></i><b>3.1.2</b> Random Variables</a></li>
<li class="chapter" data-level="3.1.3" data-path="statistical-properties.html"><a href="statistical-properties.html#discrete-random-variables-and-distributions"><i class="fa fa-check"></i><b>3.1.3</b> Discrete Random Variables and Distributions</a></li>
<li class="chapter" data-level="3.1.4" data-path="statistical-properties.html"><a href="statistical-properties.html#continuous-random-variables-and-distributions"><i class="fa fa-check"></i><b>3.1.4</b> Continuous Random Variables and Distributions</a></li>
<li class="chapter" data-level="3.1.5" data-path="statistical-properties.html"><a href="statistical-properties.html#the-cumulative-distribution"><i class="fa fa-check"></i><b>3.1.5</b> The cumulative Distribution</a></li>
<li class="chapter" data-level="3.1.6" data-path="statistical-properties.html"><a href="statistical-properties.html#continuous-distributions-with-appealing-properties"><i class="fa fa-check"></i><b>3.1.6</b> Continuous Distributions with Appealing Properties</a></li>
<li class="chapter" data-level="3.1.7" data-path="statistical-properties.html"><a href="statistical-properties.html#moments-and-properties-of-bivariate-distributions"><i class="fa fa-check"></i><b>3.1.7</b> Moments and Properties of bivariate distributions</a></li>
<li class="chapter" data-level="3.1.8" data-path="statistical-properties.html"><a href="statistical-properties.html#moments-of-probability-distributions"><i class="fa fa-check"></i><b>3.1.8</b> Moments of Probability Distributions</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="statistical-properties.html"><a href="statistical-properties.html#matrix-algebra-introduction"><i class="fa fa-check"></i><b>3.2</b> Matrix Algebra: Introduction</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="statistical-properties.html"><a href="statistical-properties.html#matrices-and-vectors"><i class="fa fa-check"></i><b>3.2.1</b> Matrices and Vectors</a></li>
<li class="chapter" data-level="3.2.2" data-path="statistical-properties.html"><a href="statistical-properties.html#basic-matrix-operations"><i class="fa fa-check"></i><b>3.2.2</b> Basic Matrix Operations</a></li>
<li class="chapter" data-level="3.2.3" data-path="statistical-properties.html"><a href="statistical-properties.html#summation-notation-in-matrix-form"><i class="fa fa-check"></i><b>3.2.3</b> Summation Notation in Matrix Form</a></li>
<li class="chapter" data-level="3.2.4" data-path="statistical-properties.html"><a href="statistical-properties.html#systems-of-linear-equations"><i class="fa fa-check"></i><b>3.2.4</b> Systems of Linear Equations</a></li>
<li class="chapter" data-level="3.2.5" data-path="statistical-properties.html"><a href="statistical-properties.html#positive-definite-pd-matrix"><i class="fa fa-check"></i><b>3.2.5</b> Positive Definite (PD) Matrix</a></li>
<li class="chapter" data-level="3.2.6" data-path="statistical-properties.html"><a href="statistical-properties.html#multivariate-probability-distributions"><i class="fa fa-check"></i><b>3.2.6</b> Multivariate Probability Distributions</a></li>
<li class="chapter" data-level="3.2.7" data-path="statistical-properties.html"><a href="statistical-properties.html#portfolio-construction-and-mathematical-properties-using-matrix-algebra"><i class="fa fa-check"></i><b>3.2.7</b> Portfolio Construction and Mathematical Properties using Matrix Algebra</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html"><i class="fa fa-check"></i><b>4</b> Inductive Statistics and Regression Analysis Fundamentals</a>
<ul>
<li class="chapter" data-level="4.1" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#inductive-statistics"><i class="fa fa-check"></i><b>4.1</b> Inductive Statistics</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#point-estimators"><i class="fa fa-check"></i><b>4.1.1</b> Point Estimators</a></li>
<li class="chapter" data-level="4.1.2" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#confidence-intervals"><i class="fa fa-check"></i><b>4.1.2</b> Confidence Intervals</a></li>
<li class="chapter" data-level="4.1.3" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#hypothesis-testing"><i class="fa fa-check"></i><b>4.1.3</b> Hypothesis Testing</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#introduction-to-regression-analysis"><i class="fa fa-check"></i><b>4.2</b> Introduction to Regression Analysis</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#the-role-of-correlation"><i class="fa fa-check"></i><b>4.2.1</b> The role of correlation</a></li>
<li class="chapter" data-level="4.2.2" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#the-simple-univariate-regression-model"><i class="fa fa-check"></i><b>4.2.2</b> The simple / univariate regression model</a></li>
<li class="chapter" data-level="4.2.3" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#the-multivariate-regression-model"><i class="fa fa-check"></i><b>4.2.3</b> The multivariate regression model</a></li>
<li class="chapter" data-level="4.2.4" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#goodness-of-fit"><i class="fa fa-check"></i><b>4.2.4</b> Goodness of Fit</a></li>
<li class="chapter" data-level="4.2.5" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#assumption-and-diagnostic-tests-of-ols"><i class="fa fa-check"></i><b>4.2.5</b> Assumption and diagnostic tests of OLS</a></li>
<li class="chapter" data-level="4.2.6" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#properties-of-the-ols-estimator"><i class="fa fa-check"></i><b>4.2.6</b> Properties of the OLS Estimator</a></li>
<li class="chapter" data-level="4.2.7" data-path="inductive-statistics-and-regression-analysis-fundamentals.html"><a href="inductive-statistics-and-regression-analysis-fundamentals.html#expected-value-and-variance-of-the-multivarite-ols-estimator-if-the-assumptions-hold"><i class="fa fa-check"></i><b>4.2.7</b> Expected Value and Variance of the multivarite OLS estimator if the assumptions hold:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="risk-and-return.html"><a href="risk-and-return.html"><i class="fa fa-check"></i><b>5</b> Risk and Return</a>
<ul>
<li class="chapter" data-level="5.1" data-path="risk-and-return.html"><a href="risk-and-return.html#the-time-series-of-returns---transformations-in-r-1"><i class="fa fa-check"></i><b>5.1</b> The time-series of Returns - Transformations in R</a></li>
<li class="chapter" data-level="5.2" data-path="risk-and-return.html"><a href="risk-and-return.html#security-returns"><i class="fa fa-check"></i><b>5.2</b> Security Returns</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="risk-and-return.html"><a href="risk-and-return.html#simple-returns"><i class="fa fa-check"></i><b>5.2.1</b> Simple Returns</a></li>
<li class="chapter" data-level="5.2.2" data-path="risk-and-return.html"><a href="risk-and-return.html#logarithmic-returns"><i class="fa fa-check"></i><b>5.2.2</b> Logarithmic Returns</a></li>
<li class="chapter" data-level="5.2.3" data-path="risk-and-return.html"><a href="risk-and-return.html#accounting-for-dividends-total-returns"><i class="fa fa-check"></i><b>5.2.3</b> Accounting for Dividends: Total Returns</a></li>
<li class="chapter" data-level="5.2.4" data-path="risk-and-return.html"><a href="risk-and-return.html#truncating-the-data"><i class="fa fa-check"></i><b>5.2.4</b> Truncating the data</a></li>
<li class="chapter" data-level="5.2.5" data-path="risk-and-return.html"><a href="risk-and-return.html#arithmetic-vs.-geometric-returns"><i class="fa fa-check"></i><b>5.2.5</b> Arithmetic vs. Geometric Returns</a></li>
<li class="chapter" data-level="5.2.6" data-path="risk-and-return.html"><a href="risk-and-return.html#cumulative-returns"><i class="fa fa-check"></i><b>5.2.6</b> Cumulative Returns</a></li>
<li class="chapter" data-level="5.2.7" data-path="risk-and-return.html"><a href="risk-and-return.html#periodic-transformation-of-returns"><i class="fa fa-check"></i><b>5.2.7</b> Periodic Transformation of Returns</a></li>
<li class="chapter" data-level="5.2.8" data-path="risk-and-return.html"><a href="risk-and-return.html#annualising-returns"><i class="fa fa-check"></i><b>5.2.8</b> Annualising Returns</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="risk-and-return.html"><a href="risk-and-return.html#portfolio-returns"><i class="fa fa-check"></i><b>5.3</b> Portfolio Returns</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="risk-and-return.html"><a href="risk-and-return.html#equal-weighted-returns"><i class="fa fa-check"></i><b>5.3.1</b> Equal-weighted Returns</a></li>
<li class="chapter" data-level="5.3.2" data-path="risk-and-return.html"><a href="risk-and-return.html#value-weighted-returns"><i class="fa fa-check"></i><b>5.3.2</b> Value-weighted Returns</a></li>
<li class="chapter" data-level="5.3.3" data-path="risk-and-return.html"><a href="risk-and-return.html#timing-of-returns"><i class="fa fa-check"></i><b>5.3.3</b> Timing of Returns</a></li>
<li class="chapter" data-level="5.3.4" data-path="risk-and-return.html"><a href="risk-and-return.html#nominal-vs.-real-returns"><i class="fa fa-check"></i><b>5.3.4</b> Nominal vs. Real Returns</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="risk-and-return.html"><a href="risk-and-return.html#individual-security-risk"><i class="fa fa-check"></i><b>5.4</b> Individual Security Risk</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="risk-and-return.html"><a href="risk-and-return.html#standard-deviation-and-variance"><i class="fa fa-check"></i><b>5.4.1</b> Standard Deviation and Variance</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="risk-and-return.html"><a href="risk-and-return.html#rolling-risk-characteristics"><i class="fa fa-check"></i><b>5.5</b> Rolling Risk Characteristics</a></li>
<li class="chapter" data-level="5.6" data-path="risk-and-return.html"><a href="risk-and-return.html#portfolio-risk"><i class="fa fa-check"></i><b>5.6</b> Portfolio Risk</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="risk-and-return.html"><a href="risk-and-return.html#portfolio-risk-of-two-securities"><i class="fa fa-check"></i><b>5.6.1</b> Portfolio Risk of two securities</a></li>
<li class="chapter" data-level="5.6.2" data-path="risk-and-return.html"><a href="risk-and-return.html#portfolio-risk-for-multiple-assets"><i class="fa fa-check"></i><b>5.6.2</b> Portfolio Risk for Multiple Assets</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="risk-and-return.html"><a href="risk-and-return.html#risk-in-extremes-and-alternative-risk-measures"><i class="fa fa-check"></i><b>5.7</b> Risk in Extremes and Alternative Risk Measures</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="risk-and-return.html"><a href="risk-and-return.html#value-at-risk-var"><i class="fa fa-check"></i><b>5.7.1</b> Value at Risk (VaR)</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="risk-and-return.html"><a href="risk-and-return.html#market-efficiency-and-independence-of-risk-and-return"><i class="fa fa-check"></i><b>5.8</b> Market Efficiency and independence of risk and return</a>
<ul>
<li class="chapter" data-level="5.8.1" data-path="risk-and-return.html"><a href="risk-and-return.html#variance-ratio-test"><i class="fa fa-check"></i><b>5.8.1</b> Variance Ratio Test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="beta.html"><a href="beta.html"><i class="fa fa-check"></i><b>6</b> Beta</a>
<ul>
<li class="chapter" data-level="6.1" data-path="beta.html"><a href="beta.html#application-of-regression-analysis-beta-analysis-in-financial-market-settings"><i class="fa fa-check"></i><b>6.1</b> Application of Regression Analysis: <span class="math inline">\(\beta\)</span> analysis in Financial Market Settings</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="beta.html"><a href="beta.html#the-single-index-model"><i class="fa fa-check"></i><b>6.1.1</b> The Single Index Model</a></li>
<li class="chapter" data-level="6.1.2" data-path="beta.html"><a href="beta.html#estimation-of-the-sim"><i class="fa fa-check"></i><b>6.1.2</b> Estimation of the SIM</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><i class="fa fa-check"></i><b>7</b> Portfolio Theory: Mean-Variance Optimisation and the CAPM</a>
<ul>
<li class="chapter" data-level="7.1" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#markowitz-portfolio-theory-with-two-risky-assets"><i class="fa fa-check"></i><b>7.1</b> Markowitz Portfolio Theory with two Risky Assets</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-case-of-portfolios"><i class="fa fa-check"></i><b>7.1.1</b> The case of portfolios</a></li>
<li class="chapter" data-level="7.1.2" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-set-of-attainable-portfolios"><i class="fa fa-check"></i><b>7.1.2</b> The set of attainable portfolios</a></li>
<li class="chapter" data-level="7.1.3" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-minimum-variance-portfolio"><i class="fa fa-check"></i><b>7.1.3</b> The Minimum-Variance Portfolio</a></li>
<li class="chapter" data-level="7.1.4" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-role-of-correlation-on-the-frontier-of-portfolios"><i class="fa fa-check"></i><b>7.1.4</b> The role of correlation on the frontier of portfolios</a></li>
<li class="chapter" data-level="7.1.5" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#efficient-portfolios-with-two-risky-assets"><i class="fa fa-check"></i><b>7.1.5</b> Efficient Portfolios with two risky assets</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#markowitz-portfolio-theory-with-a-risky-and-a-risk-free-asset"><i class="fa fa-check"></i><b>7.2</b> Markowitz Portfolio Theory with a Risky and a Risk-Free Asset</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-capital-allocation-line-cal"><i class="fa fa-check"></i><b>7.2.1</b> The Capital Allocation Line (CAL)</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#markowitz-portfolio-theory-with-two-risky-and-a-risk-free-asset"><i class="fa fa-check"></i><b>7.3</b> Markowitz Portfolio Theory with two Risky and a Risk-Free Asset</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#tangency-portfolio"><i class="fa fa-check"></i><b>7.3.1</b> Tangency Portfolio</a></li>
<li class="chapter" data-level="7.3.2" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#mutual-fund-theorem-and-derivation-of-the-capital-market-line-cml"><i class="fa fa-check"></i><b>7.3.2</b> Mutual Fund Theorem and Derivation of the Capital Market Line (CML)</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#markowitz-portfolio-theory-with-n-risky-assets"><i class="fa fa-check"></i><b>7.4</b> Markowitz Portfolio Theory with N Risky Assets</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-theoretical-foundations-of-n-assets"><i class="fa fa-check"></i><b>7.4.1</b> The theoretical foundations of N Assets</a></li>
<li class="chapter" data-level="7.4.2" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-minimum-variance-portfolio-for-n-assets"><i class="fa fa-check"></i><b>7.4.2</b> The Minimum Variance Portfolio for N assets</a></li>
<li class="chapter" data-level="7.4.3" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-efficient-frontier-for-n-assets"><i class="fa fa-check"></i><b>7.4.3</b> The Efficient Frontier for N assets</a></li>
<li class="chapter" data-level="7.4.4" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-efficient-and-feasible-portfolio-cal-of-n-risky-assets-and-a-risk-free-asset"><i class="fa fa-check"></i><b>7.4.4</b> The Efficient and Feasible Portfolio CAL of N risky Assets and a risk-free Asset</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#the-capital-asset-pricing-model"><i class="fa fa-check"></i><b>7.5</b> The Capital Asset Pricing Model</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#intuition-of-the-capm"><i class="fa fa-check"></i><b>7.5.1</b> Intuition of the CAPM</a></li>
<li class="chapter" data-level="7.5.2" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#mathematical-derivation-of-the-security-market-line-sml"><i class="fa fa-check"></i><b>7.5.2</b> Mathematical Derivation of the Security Market Line (SML)</a></li>
<li class="chapter" data-level="7.5.3" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#similarity-of-the-cml-and-sml"><i class="fa fa-check"></i><b>7.5.3</b> Similarity of the CML and SML</a></li>
<li class="chapter" data-level="7.5.4" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#diagnostic-tests-of-the-capm"><i class="fa fa-check"></i><b>7.5.4</b> Diagnostic Tests of the CAPM</a></li>
<li class="chapter" data-level="7.5.5" data-path="portfolio-theory-mean-variance-optimisation-and-the-capm.html"><a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html#fama-macbeth-1973-approach"><i class="fa fa-check"></i><b>7.5.5</b> Fama-MacBeth (1973) approach</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="factor-models.html"><a href="factor-models.html"><i class="fa fa-check"></i><b>8</b> Factor Models</a>
<ul>
<li class="chapter" data-level="8.1" data-path="factor-models.html"><a href="factor-models.html#the-idea-behind-factor-models"><i class="fa fa-check"></i><b>8.1</b> The idea behind factor models</a></li>
<li class="chapter" data-level="8.2" data-path="factor-models.html"><a href="factor-models.html#the-quest-of-detecting-anomalies"><i class="fa fa-check"></i><b>8.2</b> The quest of detecting anomalies</a></li>
<li class="chapter" data-level="8.3" data-path="factor-models.html"><a href="factor-models.html#the-fama-french-three-factor-model"><i class="fa fa-check"></i><b>8.3</b> The Fama-French Three Factor Model</a></li>
<li class="chapter" data-level="8.4" data-path="factor-models.html"><a href="factor-models.html#testing-for-factor-validity"><i class="fa fa-check"></i><b>8.4</b> Testing for factor validity</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="factor-models.html"><a href="factor-models.html#portfolio-sorts"><i class="fa fa-check"></i><b>8.4.1</b> Portfolio Sorts</a></li>
<li class="chapter" data-level="8.4.2" data-path="factor-models.html"><a href="factor-models.html#factor-construction"><i class="fa fa-check"></i><b>8.4.2</b> Factor Construction</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="factor-models.html"><a href="factor-models.html#create-your-own-factors-a-step-by-step-example"><i class="fa fa-check"></i><b>8.5</b> Create your own factors: A step-by-step example</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="factor-models.html"><a href="factor-models.html#setting-up-the-wrds-proxy"><i class="fa fa-check"></i><b>8.5.1</b> Setting up the WRDS proxy</a></li>
<li class="chapter" data-level="8.5.2" data-path="factor-models.html"><a href="factor-models.html#factors-of-interest"><i class="fa fa-check"></i><b>8.5.2</b> Factors of interest</a></li>
<li class="chapter" data-level="8.5.3" data-path="factor-models.html"><a href="factor-models.html#get-the-data-to-construct-the-factors"><i class="fa fa-check"></i><b>8.5.3</b> Get the data to construct the factors</a></li>
<li class="chapter" data-level="8.5.4" data-path="factor-models.html"><a href="factor-models.html#portfolio-sorts-for-different-factors"><i class="fa fa-check"></i><b>8.5.4</b> Portfolio Sorts for different factors</a></li>
<li class="chapter" data-level="8.5.5" data-path="factor-models.html"><a href="factor-models.html#double-sorted-portfolios"><i class="fa fa-check"></i><b>8.5.5</b> Double-sorted Portfolios</a></li>
<li class="chapter" data-level="8.5.6" data-path="factor-models.html"><a href="factor-models.html#the-importance-of-data-selection"><i class="fa fa-check"></i><b>8.5.6</b> The importance of data selection</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced Empirical Finance</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="factor-models" class="section level1" number="8">
<h1><span class="header-section-number">Chapter 8</span> Factor Models</h1>
<div id="the-idea-behind-factor-models" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> The idea behind factor models</h2>
<p>In the previous chapter, we looked at the Markowitz Mean-Variance optimisation and introduced its composition. Therein, we derived the model under the consideration of the mean, variance as well as covariance matrix between the individual, observed assets. In the case of n assets, we thus stated that we require n means, n variances and n(n-1)/2 covariances, resulting in a total of <strong>2n + n(n-1)/2</strong> parameters to describe the model. For instance, if we have 1000 assets, then we would require 501’500 parameters to describe the model inherently. Furthermore, we can show that attempting to estimate the model parameters with a sufficient precision is nearly unfeasible using historical price data over time. This is due to the fact that the precision of any variable within an iid setting depends on the square root of the number of observations. Consequently, if the number of observations is insufficiently large, confidence intervals to determine the accuracy of any expected variable value would be deemed redundant. Given the large number of parameters required to describe the model and the number of observations required to estimate the model parameters with sufficient precision, we understand that the Markowitz model is deemed to be a very <strong>data intensive</strong> model. As a consequence, we need to find simpler models which are less data intensive but can still capture a sufficient amount of the underlying, true asset variation.</p>
<p>Based on this notion, the term <strong>Factor Models</strong> was primed. These models assume that the <strong>correlation between any two assets is explained by systematic factors</strong>. That is, the underlying return structure of multiple assets depends on common components which can be represented by quantifiable proxies. Using this assumption, one can <strong>restrict attention to only K (non-diversifiable) factors.</strong></p>
<p>Factor models have the advantage that they drastically reduce the number of input variables. Further, they allow to estimate systematic risk components by analysing expected return structures. However, they are purely statistical models and rely on past data. Further, they all assume stationarity.</p>
<p>The aim of factor models is to understand the drivers of asset prices. Broadly speaking, the main concept behind factor investing is that the financial performance of firms depends on distinct factors, whether they are latent or macroeconomic, or related to intrinsic, firm-specific characteristics. Cochrane (2011) states that the first essential question is which characteristics really provide independent information about average returns. Understanding whether the exposure of assets towards common variable(s) can be used to help explain the cross-sectional variation in returns is therein the main emphasis of factor investing.</p>
<p>As we have covered in the lecture, factor models are natural extensions of the <strong>Arbitrage Pricing Theory</strong> model (APT) introduced by Ross (1976), who assumes that security returns return can be modeled as a linear combination of underlying factors <span class="math inline">\(f_k\)</span> and that investors operate in functioning security markets which do not allow for the persistence of arbitrage opportunities:</p>
<p><span class="math display">\[
r_{i,t} = \alpha_i + \sum_{i=1}^K \beta_{i,k}f_{t,k} + \epsilon_{i,t}
\]</span></p>
<p>Here, the usual IID setting econometric assumptions hold, implying that <span class="math inline">\(cov(\epsilon_{i,t},\epsilon_{j,t}) = 0\)</span> and <span class="math inline">\(cov(\epsilon_{i},f_{i}) = 0\)</span>.</p>
<p>A quasi factor-based model is The CAPM. The CAPM is a commonly used model to assess asset returns. Previously, we introduced both the theoretical intuition as well as the practical implementation of the model. We derived how the exposure towards market movements influence stock returns and showed how to compute the underlying framework. Further, we derived options to test the model’s validity and showed that the CAPM does not hold empirically. Consequently, we were able to present that the theoretical foundations of the CAPM are not sufficient to effectively explain the variation in asset returns. This implies that other factors are needed to help explain the remaining variation in asset returns unexplained by the market. To put it in other words, the existence of factors that can explain asset returns further contradicts the validity of the CAPM, which assumes that the variation solely depends on the market portfolio. Consequently, factors are also regarded as <strong>anomalies</strong>.
A quasi factor-based model is The CAPM. The CAPM is a commonly used model to assess asset returns. Previously, we introduced both the theoretical intuition as well as the practical implementation of the model. We derived how the exposure towards market movements influence stock returns and showed how to compute the underlying framework. Further, we derived options to test the model’s validity and showed that the CAPM does not hold empirically. Consequently, we were able to present that the theoretical foundations of the CAPM are not sufficient to effectively explain the variation in asset returns. This implies that other factors are needed to help explain the remaining variation in asset returns unexplained by the market. To put it in other words, the existence of factors that can explain asset returns further contradicts the validity of the CAPM, which assumes that the variation solely depends on the market portfolio. Consequently, factors are also regarded as <strong>anomalies</strong>.</p>
<p>Importantly, each factor portfolio is a tracking portfolio. That is, the returns on such a portfolio are tracked by the evolution of one particular source of risk but are uncorrelated with other sources of risk.</p>
</div>
<div id="the-quest-of-detecting-anomalies" class="section level2" number="8.2">
<h2><span class="header-section-number">8.2</span> The quest of detecting anomalies</h2>
<p>How can we thus find such anomalies? As we already mentioned, there is no clear theoretical foundation to the use of certain factors. Mostly, researchers or industry experts consider market movements and attempt to pin down these movements based on correlating characteristics (either micro- or macro-oriented) of the firms under consideration. Usually then, based on these observations, theoretical arguments which suit the given movements are constructed around the anomalies. For instance, Chen Roll and Ross introduced one of the most fundamental multifactor models in 1986 by incorporating macroeconomic variables such as Growth in industrial productiion, inflation expected changes or corporate rated bonds and found a significant effect in the cross-section of returns. Based on their research, Fama and French (1993) created their famous Size and Value portfolio strategies on the observations that small size (measured by market capitalisation) as well as value (measured by high book-to-market ratios) securities outperform their opposite counterparts. Further notable examples include the Momentum strategy (by Jegadeesh and Titman (1993) and Carhart (1997)), Profitability (by Fama and French (2015) and Bouchaud et al. (2019)), Investment (by Fama and French (2015) as well as Hou, Xue, and Zhang (2015)) as well as low-risk (by Frazzini and Pedersen (2014)) or Liquidity factor (by Acharya and Pedersen (2005)).While these factors (i.e., long-short portfolios) exhibit time-varying risk premia and are magnified by corporate news and announcements, it is well-documented (and accepted) that they deliver positive returns over long horizons.</p>
<p>In essence, factors that are shown to hold empirically are manifold. For instance, Chen and Zimmermann (2019) attempt to replicate the 300 most commonly cited factors introduced during the last 40 years and publish the final factors on their website called . Although their work greatly facilitates an improved accessibility of factor investment opportunities, they also show the inherent challenges associated with factor investing. These include, among others:</p>
<ul>
<li>The limited possibility to replicate the factor exposure</li>
<li>The dependence of the variational properties on data-specific idiosyncracies</li>
<li>The likelihood of p-hacking strategies</li>
<li>The time-wise dependence on factor exposure</li>
<li>The destruction of potentially valid factor premia may be due to herding</li>
<li>The fading of anomalies due to the publication and subsequent reduction of arbitrage opportunities (through re-investment of multiple market participants)</li>
</ul>
<p>Consequently, although the pool of potentially valid factors is quite large, several of these factors suffer from one or multiple of the aforementioned issues, thereby rendering their empirical validity at least partially questionable. As such, although a multitude of potential characteristics are able to explain asset returns both time-series wise and cross-sectionally, the large-scale use of high-dimensional factor models must be addressed critically.</p>
</div>
<div id="the-fama-french-three-factor-model" class="section level2" number="8.3">
<h2><span class="header-section-number">8.3</span> The Fama-French Three Factor Model</h2>
<p>The perhaps most famous factor model is the Fama-French three-factor model (1993). It was based on observations by the researchers which found that small size (measured by market capitalisation) as well as value (measured by high book-to-market ratios) securities outperform their opposite counterparts. The theoretical reasoning for this were mostly pinned down to risk-based anomalies. For instance, it was argued that small companies outperform their larger counterparts because they are exposed towards a higher liquidation, operational as well as credit based risk, implying that they need to compensate for said risk throughout a higher return structure. Furthermore, the value factor was usually explained through perceptions of future performance based on financing activities, which might also constitute as financial distress assessments.</p>
<p>Fama and French do not only highlight the importance of size and value, but they also <strong>develop a method to generate factor portfolios.</strong></p>
<p>Their main strategy is the following. They construct a portfolio of large firms and one of small firms. As break point they use the median size of the firms listed on NYSE to classify all stocks traded on NYSE, Amex and Nasdaq. These portfolios are value weighted. They then construct a zero net investment <strong>size factor portfolio</strong> by going long the small and going short the big stock portfolio. Further, they construct a Book-to-Market (B2M) exposure by sorting the stocks into low (bottom 30%), medium (middle 40%) and high (top 30%) groups based on B2M.</p>
<p>Based on this, they construct six portfolios based on the intersection of size and B/M sorts:</p>
<ul>
<li><p>S/L: Small Stocks with Low B2M</p></li>
<li><p>S/M: Small Stocks with Medium B2M</p></li>
<li><p>S/H: Small Stocks with High B2M</p></li>
<li><p>B/L: Big Stocks with Low B2M</p></li>
<li><p>B/M: Big Stocks with Medium B2M</p></li>
<li><p>B/H: Big Stocks with High B2M</p></li>
</ul>
<p>The returns of the zero-net-investment factors SMB (Small minus Big) and HML (High minus Low) are created from these portfolios</p>
<p><span class="math display">\[
\begin{align}
R_{SMB} &amp;= 1/3(R_{S/L} + R_{S/M} + R_{S/H}) - 1/3(R_{B/L} + R_{B/M} + R_{B/H}) \\
R_{HML} &amp;= 1/2(R_{S/H} + R_{B/H}) - 1/2(R_{S/L} + R_{B/L})
\end{align}
\]</span></p>
<p>Based on these factors, the factor betas of the stocks are calculated in a First Pass regression:</p>
<p><span class="math display">\[
E(R_i) - r_f = \alpha_i + \beta_i(E(R_M) - r_f) + \gamma_iE[R_{SMB}] + \delta_iE[R_{HML}]
\]</span></p>
<p>The method used of Fama-French to construct the factors is the most widely adopted approach to create factors. Most of the subsequent factors were created using said approach of sorting stocks into either <span class="math inline">\(2 \times 3\)</span> or <span class="math inline">\(2 \times 2\)</span> portfolios. For instance, to construct the Momentum Factor by Jegadeesh and Titman (1996) as well as Carhart (1997), you can use the same approach as for the HML factor, but just double-sort it based on size and the previous Up/Down movements.</p>
</div>
<div id="testing-for-factor-validity" class="section level2" number="8.4">
<h2><span class="header-section-number">8.4</span> Testing for factor validity</h2>
<p>As we discovered, factor investing describes an investment strategy in which quantifiable corporate or macroeconomic data is considered. Therein, the variation in security returns is poised to depend collectively on these characteristics. In order to test for the validity of the underlying characteristic in determining asset returns, we thus need to set the asset returns in a relation to the factor under consideration. The industry surrounding this investment style poses several methods to test said validity, both within time-series as well as cross-sectional settings.</p>
<p>Throughout the subsequent chapter, we will go over the most common techniques to test for factor validity. Throughout, we will cover the theoretical underpinnings, the actual testing strategy as well as the intuition behind each approach. Further, we will illustrate each testing strategy by using code-based examples on the <strong>Size Factor</strong> first introduced by Fama and French (1993).</p>
<div id="portfolio-sorts" class="section level3" number="8.4.1">
<h3><span class="header-section-number">8.4.1</span> Portfolio Sorts</h3>
<p>This is the simplest and most widely applied form of factor testing. The idea is straight-forward: We sort portfolios based on the risk factor under consideration into percentiles (e.g. deciles, quintiles). Then, we look at the return and variance structure of each portfolio and compare their structure throughout the individual percentiles to observe whether we see significant differences between them.</p>
<p>In essence, on each date t, we perform the following steps:</p>
<ol style="list-style-type: decimal">
<li>Rank firms according to a criterion (e.g. Market Capitalisation)</li>
<li>Sort the firms into portfolios based on the criterion (e.g 10 portfolios for decile portfolios)</li>
<li>Calculate the weights (either equally or value-weighted)</li>
<li>Calculate the portfolio returns at t+1</li>
</ol>
<p>The resulting outcome is a time series of portfolio returns for each portfolio j, <span class="math inline">\(r_t^j\)</span>. Then, we identify an anomaly in the following way:</p>
<ol start="5" style="list-style-type: decimal">
<li>Construct a Long-Short portfolio strategy by buying the highest and selling the lowest portfolio percentile group</li>
<li>Conduct a t-test of the long-short strategy</li>
</ol>
<p>In essence, what we want to observe is the following:</p>
<ul>
<li>A monotonous (possibly significant) change (either increase or decrease) in average returns throughout the portfolio sorts</li>
<li>A significant t-value for the long-short strategy</li>
</ul>
<p>Based on the literature, if we can observe both, then we can strengthen our assumption that the factor materially affects security returns. The reasoning is the following. We hypothesise that asset returns depend on a common factor. As such, the larger the exposure of a security towards said factor is, the stronger the returns should be affected by the factor. Consequently, the return of assets in higher portfolios should behave differently to that in lower portfolios. Further, if we assume that the factor under consideration influences the return structure of all assets, then we would expect that the effect grows continuously when moving from one portfolio to the other, inducing a monotonous effect throughout our assets.</p>
<p>First, let’s calculate quintile portfolios based on the characteristic</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb466-1"><a href="factor-models.html#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the datasets</span></span>
<span id="cb466-2"><a href="factor-models.html#cb466-2" aria-hidden="true" tabindex="-1"></a>Prices_Adj <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_01.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb466-3"><a href="factor-models.html#cb466-3" aria-hidden="true" tabindex="-1"></a>Prices_Unadj <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb466-4"><a href="factor-models.html#cb466-4" aria-hidden="true" tabindex="-1"></a>Shares <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_03.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb466-5"><a href="factor-models.html#cb466-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-6"><a href="factor-models.html#cb466-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Time-Series objects</span></span>
<span id="cb466-7"><a href="factor-models.html#cb466-7" aria-hidden="true" tabindex="-1"></a>Prices_Adj_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Prices_Adj[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Adj[,<span class="dv">1</span>])))</span>
<span id="cb466-8"><a href="factor-models.html#cb466-8" aria-hidden="true" tabindex="-1"></a>Prices_Unadj_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Prices_Unadj[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Unadj[,<span class="dv">1</span>])))</span>
<span id="cb466-9"><a href="factor-models.html#cb466-9" aria-hidden="true" tabindex="-1"></a>Shares_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Shares[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Shares[,<span class="dv">1</span>])))</span>
<span id="cb466-10"><a href="factor-models.html#cb466-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-11"><a href="factor-models.html#cb466-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the Returns</span></span>
<span id="cb466-12"><a href="factor-models.html#cb466-12" aria-hidden="true" tabindex="-1"></a>Returns_Adj_ts <span class="ot">&lt;-</span> <span class="fu">Return.calculate</span>(Prices_Adj_ts, <span class="at">method =</span> <span class="st">&quot;discrete&quot;</span>)</span>
<span id="cb466-13"><a href="factor-models.html#cb466-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-14"><a href="factor-models.html#cb466-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the market cap Time-Series</span></span>
<span id="cb466-15"><a href="factor-models.html#cb466-15" aria-hidden="true" tabindex="-1"></a>Market_Cap_ts <span class="ot">&lt;-</span> Shares_ts <span class="sc">*</span> Prices_Unadj_ts</span>
<span id="cb466-16"><a href="factor-models.html#cb466-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-17"><a href="factor-models.html#cb466-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform the decile portfolio sorts</span></span>
<span id="cb466-18"><a href="factor-models.html#cb466-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Take the quintile values</span></span>
<span id="cb466-19"><a href="factor-models.html#cb466-19" aria-hidden="true" tabindex="-1"></a>quintiles <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>)</span>
<span id="cb466-20"><a href="factor-models.html#cb466-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Create variables indicating the respective 20&#39;th, 40&#39;th, 60&#39;th, 80&#39;th quintile for each month</span></span>
<span id="cb466-21"><a href="factor-models.html#cb466-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> quintiles){</span>
<span id="cb466-22"><a href="factor-models.html#cb466-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assign</span>(<span class="fu">paste0</span>(<span class="st">&quot;Market_Cap_Cutoff_&quot;</span>, i, <span class="st">&quot;_ts&quot;</span>), matrixStats<span class="sc">::</span><span class="fu">rowQuantiles</span>(<span class="fu">as.matrix</span>(Market_Cap_ts), <span class="at">probs =</span> i, <span class="at">na.rm =</span> T))</span>
<span id="cb466-23"><a href="factor-models.html#cb466-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb466-24"><a href="factor-models.html#cb466-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-25"><a href="factor-models.html#cb466-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the portfolio returns for each quintile </span></span>
<span id="cb466-26"><a href="factor-models.html#cb466-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(Market_Cap_ts)){</span>
<span id="cb466-27"><a href="factor-models.html#cb466-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First create the market capitalisation of each quintile</span></span>
<span id="cb466-28"><a href="factor-models.html#cb466-28" aria-hidden="true" tabindex="-1"></a>  Market_Cap_Q1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(Market_Cap_ts[,i] <span class="sc">&lt;=</span> Market_Cap_Cutoff_0<span class="fl">.2</span>_ts, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb466-29"><a href="factor-models.html#cb466-29" aria-hidden="true" tabindex="-1"></a>  Market_Cap_Q2 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[,i] <span class="sc">&gt;</span> Market_Cap_Cutoff_0<span class="fl">.2</span>_ts) <span class="sc">&amp;</span> (Market_Cap_ts[,i] <span class="sc">&lt;=</span> Market_Cap_Cutoff_0<span class="fl">.4</span>_ts), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb466-30"><a href="factor-models.html#cb466-30" aria-hidden="true" tabindex="-1"></a>  Market_Cap_Q3 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[,i] <span class="sc">&gt;</span> Market_Cap_Cutoff_0<span class="fl">.4</span>_ts) <span class="sc">&amp;</span> (Market_Cap_ts[,i] <span class="sc">&lt;=</span> Market_Cap_Cutoff_0<span class="fl">.6</span>_ts), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb466-31"><a href="factor-models.html#cb466-31" aria-hidden="true" tabindex="-1"></a>  Market_Cap_Q4 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[,i] <span class="sc">&gt;</span> Market_Cap_Cutoff_0<span class="fl">.6</span>_ts) <span class="sc">&amp;</span> (Market_Cap_ts[,i] <span class="sc">&lt;=</span> Market_Cap_Cutoff_0<span class="fl">.8</span>_ts), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb466-32"><a href="factor-models.html#cb466-32" aria-hidden="true" tabindex="-1"></a>  Market_Cap_Q5 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(Market_Cap_ts[,i] <span class="sc">&gt;</span> Market_Cap_Cutoff_0<span class="fl">.8</span>_ts, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb466-33"><a href="factor-models.html#cb466-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then multiply the Market Cap quintile indicators with the secutity returns</span></span>
<span id="cb466-34"><a href="factor-models.html#cb466-34" aria-hidden="true" tabindex="-1"></a>  Return_Market_Cap_Q1  <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Market_Cap_Q1, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb466-35"><a href="factor-models.html#cb466-35" aria-hidden="true" tabindex="-1"></a>  Return_Market_Cap_Q2  <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Market_Cap_Q2, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb466-36"><a href="factor-models.html#cb466-36" aria-hidden="true" tabindex="-1"></a>  Return_Market_Cap_Q3  <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Market_Cap_Q3, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb466-37"><a href="factor-models.html#cb466-37" aria-hidden="true" tabindex="-1"></a>  Return_Market_Cap_Q4  <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Market_Cap_Q4, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb466-38"><a href="factor-models.html#cb466-38" aria-hidden="true" tabindex="-1"></a>  Return_Market_Cap_Q5  <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Market_Cap_Q5, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb466-39"><a href="factor-models.html#cb466-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb466-40"><a href="factor-models.html#cb466-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="st">&quot;NESN&quot;</span>){ </span>
<span id="cb466-41"><a href="factor-models.html#cb466-41" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q1_final <span class="ot">&lt;-</span> Return_Market_Cap_Q1</span>
<span id="cb466-42"><a href="factor-models.html#cb466-42" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q2_final <span class="ot">&lt;-</span> Return_Market_Cap_Q2</span>
<span id="cb466-43"><a href="factor-models.html#cb466-43" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q3_final <span class="ot">&lt;-</span> Return_Market_Cap_Q3</span>
<span id="cb466-44"><a href="factor-models.html#cb466-44" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q4_final <span class="ot">&lt;-</span> Return_Market_Cap_Q4</span>
<span id="cb466-45"><a href="factor-models.html#cb466-45" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q5_final <span class="ot">&lt;-</span> Return_Market_Cap_Q5</span>
<span id="cb466-46"><a href="factor-models.html#cb466-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb466-47"><a href="factor-models.html#cb466-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb466-48"><a href="factor-models.html#cb466-48" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q1_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Market_Cap_Q1_final, Return_Market_Cap_Q1)</span>
<span id="cb466-49"><a href="factor-models.html#cb466-49" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q2_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Market_Cap_Q2_final, Return_Market_Cap_Q2)</span>
<span id="cb466-50"><a href="factor-models.html#cb466-50" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q3_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Market_Cap_Q3_final, Return_Market_Cap_Q3)</span>
<span id="cb466-51"><a href="factor-models.html#cb466-51" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q4_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Market_Cap_Q4_final, Return_Market_Cap_Q4)</span>
<span id="cb466-52"><a href="factor-models.html#cb466-52" aria-hidden="true" tabindex="-1"></a>    Return_Market_Cap_Q5_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Market_Cap_Q5_final, Return_Market_Cap_Q5)</span>
<span id="cb466-53"><a href="factor-models.html#cb466-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb466-54"><a href="factor-models.html#cb466-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb466-55"><a href="factor-models.html#cb466-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-56"><a href="factor-models.html#cb466-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns of each portfolio</span></span>
<span id="cb466-57"><a href="factor-models.html#cb466-57" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_Q1_final <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Market_Cap_Q1_final, <span class="at">na.rm =</span> T)</span>
<span id="cb466-58"><a href="factor-models.html#cb466-58" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_Q2_final <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Market_Cap_Q2_final, <span class="at">na.rm =</span> T)</span>
<span id="cb466-59"><a href="factor-models.html#cb466-59" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_Q3_final <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Market_Cap_Q3_final, <span class="at">na.rm =</span> T)</span>
<span id="cb466-60"><a href="factor-models.html#cb466-60" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_Q4_final <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Market_Cap_Q4_final, <span class="at">na.rm =</span> T)</span>
<span id="cb466-61"><a href="factor-models.html#cb466-61" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_Q5_final <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Market_Cap_Q5_final, <span class="at">na.rm =</span> T)</span>
<span id="cb466-62"><a href="factor-models.html#cb466-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-63"><a href="factor-models.html#cb466-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the entire datatframe to one </span></span>
<span id="cb466-64"><a href="factor-models.html#cb466-64" aria-hidden="true" tabindex="-1"></a>Dates <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Adj[,<span class="dv">1</span>][<span class="dv">14</span><span class="sc">:</span><span class="dv">361</span>]))</span>
<span id="cb466-65"><a href="factor-models.html#cb466-65" aria-hidden="true" tabindex="-1"></a><span class="do">## For the normal returns</span></span>
<span id="cb466-66"><a href="factor-models.html#cb466-66" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_quintiles <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Dates, </span>
<span id="cb466-67"><a href="factor-models.html#cb466-67" aria-hidden="true" tabindex="-1"></a>                                                Mean_Return_EW_Q1_final, </span>
<span id="cb466-68"><a href="factor-models.html#cb466-68" aria-hidden="true" tabindex="-1"></a>                                                Mean_Return_EW_Q2_final, </span>
<span id="cb466-69"><a href="factor-models.html#cb466-69" aria-hidden="true" tabindex="-1"></a>                                                Mean_Return_EW_Q3_final, </span>
<span id="cb466-70"><a href="factor-models.html#cb466-70" aria-hidden="true" tabindex="-1"></a>                                                Mean_Return_EW_Q4_final, </span>
<span id="cb466-71"><a href="factor-models.html#cb466-71" aria-hidden="true" tabindex="-1"></a>                                                Mean_Return_EW_Q5_final))</span>
<span id="cb466-72"><a href="factor-models.html#cb466-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-73"><a href="factor-models.html#cb466-73" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_quintiles_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Mean_Return_EW_quintiles[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> Dates)</span>
<span id="cb466-74"><a href="factor-models.html#cb466-74" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Mean_Return_EW_quintiles_ts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Quintile 1&quot;</span>, <span class="st">&quot;Quintile 2&quot;</span>, <span class="st">&quot;Quintile 3&quot;</span>, <span class="st">&quot;Quintile 4&quot;</span>, <span class="st">&quot;Quintile 5&quot;</span>)</span>
<span id="cb466-75"><a href="factor-models.html#cb466-75" aria-hidden="true" tabindex="-1"></a><span class="do">## For the cumulative returns</span></span>
<span id="cb466-76"><a href="factor-models.html#cb466-76" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_quintiles_cp <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Dates, </span>
<span id="cb466-77"><a href="factor-models.html#cb466-77" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>Mean_Return_EW_Q1_final), </span>
<span id="cb466-78"><a href="factor-models.html#cb466-78" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>Mean_Return_EW_Q2_final), </span>
<span id="cb466-79"><a href="factor-models.html#cb466-79" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>Mean_Return_EW_Q3_final), </span>
<span id="cb466-80"><a href="factor-models.html#cb466-80" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>Mean_Return_EW_Q4_final), </span>
<span id="cb466-81"><a href="factor-models.html#cb466-81" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>Mean_Return_EW_Q5_final)))</span>
<span id="cb466-82"><a href="factor-models.html#cb466-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-83"><a href="factor-models.html#cb466-83" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_quintiles_cp_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Mean_Return_EW_quintiles_cp[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> Dates)</span>
<span id="cb466-84"><a href="factor-models.html#cb466-84" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Mean_Return_EW_quintiles_cp_ts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Quintile 1&quot;</span>, <span class="st">&quot;Quintile 2&quot;</span>, <span class="st">&quot;Quintile 3&quot;</span>, <span class="st">&quot;Quintile 4&quot;</span>, <span class="st">&quot;Quintile 5&quot;</span>)</span>
<span id="cb466-85"><a href="factor-models.html#cb466-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-86"><a href="factor-models.html#cb466-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Finally, we can plot the relationship </span></span>
<span id="cb466-87"><a href="factor-models.html#cb466-87" aria-hidden="true" tabindex="-1"></a>plot_ret <span class="ot">&lt;-</span> <span class="fu">tidy</span>(Mean_Return_EW_quintiles_ts) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>index,<span class="at">y=</span>value, <span class="at">color=</span>series)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb466-88"><a href="factor-models.html#cb466-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;tomato3&quot;</span>, <span class="st">&quot;khaki3&quot;</span>, <span class="st">&quot;lightsteelblue3&quot;</span>, <span class="st">&quot;dodgerblue4&quot;</span>, <span class="st">&quot;violetred4&quot;</span>)) <span class="sc">+</span></span>
<span id="cb466-89"><a href="factor-models.html#cb466-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Relationship of Normal Returns on Quintile PF based on Market Cap&quot;</span>) <span class="sc">+</span></span>
<span id="cb466-90"><a href="factor-models.html#cb466-90" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb466-91"><a href="factor-models.html#cb466-91" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb466-92"><a href="factor-models.html#cb466-92" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb466-93"><a href="factor-models.html#cb466-93" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb466-94"><a href="factor-models.html#cb466-94" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb466-95"><a href="factor-models.html#cb466-95" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb466-96"><a href="factor-models.html#cb466-96" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb466-97"><a href="factor-models.html#cb466-97" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb466-98"><a href="factor-models.html#cb466-98" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span>
<span id="cb466-99"><a href="factor-models.html#cb466-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-100"><a href="factor-models.html#cb466-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Finally, we can plot the relationship </span></span>
<span id="cb466-101"><a href="factor-models.html#cb466-101" aria-hidden="true" tabindex="-1"></a>plot_cumret <span class="ot">&lt;-</span> <span class="fu">tidy</span>(Mean_Return_EW_quintiles_cp_ts) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>index,<span class="at">y=</span>value, <span class="at">color=</span>series)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb466-102"><a href="factor-models.html#cb466-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;tomato3&quot;</span>, <span class="st">&quot;khaki3&quot;</span>, <span class="st">&quot;lightsteelblue3&quot;</span>, <span class="st">&quot;dodgerblue4&quot;</span>, <span class="st">&quot;violetred4&quot;</span>)) <span class="sc">+</span></span>
<span id="cb466-103"><a href="factor-models.html#cb466-103" aria-hidden="true" tabindex="-1"></a><span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Relationship of Cumulative Returns on Quintile PF based on Market Cap&quot;</span>) <span class="sc">+</span></span>
<span id="cb466-104"><a href="factor-models.html#cb466-104" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb466-105"><a href="factor-models.html#cb466-105" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb466-106"><a href="factor-models.html#cb466-106" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb466-107"><a href="factor-models.html#cb466-107" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb466-108"><a href="factor-models.html#cb466-108" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb466-109"><a href="factor-models.html#cb466-109" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb466-110"><a href="factor-models.html#cb466-110" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb466-111"><a href="factor-models.html#cb466-111" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb466-112"><a href="factor-models.html#cb466-112" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span>
<span id="cb466-113"><a href="factor-models.html#cb466-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-114"><a href="factor-models.html#cb466-114" aria-hidden="true" tabindex="-1"></a>plot_ret</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-259-1.png" width="672" /></p>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb467-1"><a href="factor-models.html#cb467-1" aria-hidden="true" tabindex="-1"></a>plot_cumret</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-259-2.png" width="672" /></p>
<p>As we can see, there appears to be a strictly increasing trend based on the quintile portfolios. We can confirm this trend by looking at the average returns and their standard deviations.</p>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb468-1"><a href="factor-models.html#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean returns</span></span>
<span id="cb468-2"><a href="factor-models.html#cb468-2" aria-hidden="true" tabindex="-1"></a>Mean_Return_EW_quintiles_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Mean_Return_EW_quintiles[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> Dates)</span>
<span id="cb468-3"><a href="factor-models.html#cb468-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-4"><a href="factor-models.html#cb468-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(Mean_Return_EW_quintiles_ts)){</span>
<span id="cb468-5"><a href="factor-models.html#cb468-5" aria-hidden="true" tabindex="-1"></a>  Mean_Return_EW <span class="ot">&lt;-</span> <span class="fu">mean</span>(Mean_Return_EW_quintiles_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i])</span>
<span id="cb468-6"><a href="factor-models.html#cb468-6" aria-hidden="true" tabindex="-1"></a>  SD_Return_EW <span class="ot">&lt;-</span> <span class="fu">sd</span>(Mean_Return_EW_quintiles_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i])</span>
<span id="cb468-7"><a href="factor-models.html#cb468-7" aria-hidden="true" tabindex="-1"></a>  n_Return_EW <span class="ot">&lt;-</span> <span class="fu">length</span>(Mean_Return_EW_quintiles_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i])</span>
<span id="cb468-8"><a href="factor-models.html#cb468-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb468-9"><a href="factor-models.html#cb468-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="st">&quot;Mean_Return_EW_Q1_final&quot;</span>){</span>
<span id="cb468-10"><a href="factor-models.html#cb468-10" aria-hidden="true" tabindex="-1"></a>    Mean_Return_EW_final <span class="ot">&lt;-</span> Mean_Return_EW</span>
<span id="cb468-11"><a href="factor-models.html#cb468-11" aria-hidden="true" tabindex="-1"></a>    SD_Return_EW_final <span class="ot">&lt;-</span> SD_Return_EW</span>
<span id="cb468-12"><a href="factor-models.html#cb468-12" aria-hidden="true" tabindex="-1"></a>    n_Return_EW_final <span class="ot">&lt;-</span> n_Return_EW</span>
<span id="cb468-13"><a href="factor-models.html#cb468-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb468-14"><a href="factor-models.html#cb468-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb468-15"><a href="factor-models.html#cb468-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb468-16"><a href="factor-models.html#cb468-16" aria-hidden="true" tabindex="-1"></a>    Mean_Return_EW_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Mean_Return_EW_final, Mean_Return_EW)</span>
<span id="cb468-17"><a href="factor-models.html#cb468-17" aria-hidden="true" tabindex="-1"></a>    SD_Return_EW_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(SD_Return_EW_final, SD_Return_EW)</span>
<span id="cb468-18"><a href="factor-models.html#cb468-18" aria-hidden="true" tabindex="-1"></a>    n_Return_EW_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(n_Return_EW_final, n_Return_EW)</span>
<span id="cb468-19"><a href="factor-models.html#cb468-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb468-20"><a href="factor-models.html#cb468-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb468-21"><a href="factor-models.html#cb468-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-22"><a href="factor-models.html#cb468-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the final dataframe</span></span>
<span id="cb468-23"><a href="factor-models.html#cb468-23" aria-hidden="true" tabindex="-1"></a>Mean_SD_Size_EW_Quintile_PF <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(Mean_Return_EW_final, SD_Return_EW_final, n_Return_EW_final))</span>
<span id="cb468-24"><a href="factor-models.html#cb468-24" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Mean_SD_Size_EW_Quintile_PF) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Quintile_1&quot;</span>, <span class="st">&quot;Quintile_2&quot;</span>, <span class="st">&quot;Quintile_3&quot;</span>, <span class="st">&quot;Quintile_4&quot;</span>, <span class="st">&quot;Quintile_5&quot;</span>)</span>
<span id="cb468-25"><a href="factor-models.html#cb468-25" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(Mean_SD_Size_EW_Quintile_PF) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Average Return&quot;</span>, <span class="st">&quot;SD Return&quot;</span>, <span class="st">&quot;N Observations&quot;</span>)</span>
<span id="cb468-26"><a href="factor-models.html#cb468-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-27"><a href="factor-models.html#cb468-27" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(Mean_SD_Size_EW_Quintile_PF,<span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                Quintile_1 Quintile_2 Quintile_3 Quintile_4 Quintile_5
## Average Return     0.0060     0.0054     0.0066     0.0067     0.0075
## SD Return          0.0436     0.0406     0.0450     0.0446     0.0482
## N Observations   348.0000   348.0000   348.0000   348.0000   348.0000</code></pre>
<p>Finally, we can compute the t-test to check if the average return is statistically different</p>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb470-1"><a href="factor-models.html#cb470-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s create a simple function to calculate the t-test for the average difference</span></span>
<span id="cb470-2"><a href="factor-models.html#cb470-2" aria-hidden="true" tabindex="-1"></a>t_test_mean_diff <span class="ot">&lt;-</span> <span class="cf">function</span>(mean_a, mean_b, sd_a, sd_b, n_a, n_b) {</span>
<span id="cb470-3"><a href="factor-models.html#cb470-3" aria-hidden="true" tabindex="-1"></a>  t_test <span class="ot">&lt;-</span> (mean_a <span class="sc">-</span> mean_b) <span class="sc">/</span> <span class="fu">sqrt</span>(sd_a<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>n_a <span class="sc">+</span> sd_b<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>n_b)</span>
<span id="cb470-4"><a href="factor-models.html#cb470-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(t_test)</span>
<span id="cb470-5"><a href="factor-models.html#cb470-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb470-6"><a href="factor-models.html#cb470-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb470-7"><a href="factor-models.html#cb470-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Try out the formula</span></span>
<span id="cb470-8"><a href="factor-models.html#cb470-8" aria-hidden="true" tabindex="-1"></a><span class="fu">t_test_mean_diff</span>(Mean_SD_Size_EW_Quintile_PF<span class="sc">$</span>Quintile_5[<span class="dv">1</span>], </span>
<span id="cb470-9"><a href="factor-models.html#cb470-9" aria-hidden="true" tabindex="-1"></a>                 Mean_SD_Size_EW_Quintile_PF<span class="sc">$</span>Quintile_1[<span class="dv">1</span>], </span>
<span id="cb470-10"><a href="factor-models.html#cb470-10" aria-hidden="true" tabindex="-1"></a>                 Mean_SD_Size_EW_Quintile_PF<span class="sc">$</span>Quintile_5[<span class="dv">2</span>], </span>
<span id="cb470-11"><a href="factor-models.html#cb470-11" aria-hidden="true" tabindex="-1"></a>                 Mean_SD_Size_EW_Quintile_PF<span class="sc">$</span>Quintile_1[<span class="dv">2</span>], </span>
<span id="cb470-12"><a href="factor-models.html#cb470-12" aria-hidden="true" tabindex="-1"></a>                 Mean_SD_Size_EW_Quintile_PF<span class="sc">$</span>Quintile_5[<span class="dv">3</span>], </span>
<span id="cb470-13"><a href="factor-models.html#cb470-13" aria-hidden="true" tabindex="-1"></a>                 Mean_SD_Size_EW_Quintile_PF<span class="sc">$</span>Quintile_1[<span class="dv">3</span>])</span></code></pre></div>
<pre><code>## [1] 0.444822</code></pre>
<p>As we can see, there is no significant difference between the average returns of the high and the low portfolio. This implies, given the IID considerations and the baseline statistical properties assumed, the difference in average returns between the smallest and largest stock portfolio is statistically indistinguishable from zero at conventional levels. Thus, the hypothesis that the average returns are not different from each other cannot be rejected.</p>
</div>
<div id="factor-construction" class="section level3" number="8.4.2">
<h3><span class="header-section-number">8.4.2</span> Factor Construction</h3>
<p>The second approach constitutes the creation of so-called <strong>risk-factor mimicking portfolios</strong>. These are portfolios which are sorted based on the risk factor of interest but are put relative to each other, depending on the exposure towards the characteristic under consideration. Consequently, we follow a quite similar approach to the portfolio sorts. That is, we:</p>
<ul>
<li>First single-sort the assts based on specific characteristics in usually 2 or 3 portfolios</li>
<li>Double-sort the assets based on the portfolio allocations of the first sort (e.g. Small and Low B2M assets) to obtain the risk-factor mimicking portfolios</li>
<li>Take the difference between the double-sorted portfolios which are more and which are less exposed towards the given risk factor</li>
</ul>
<p>The most usual approaches include forming bivariate sorts and aggregating several portfolios together, as in the original contribution of Fama and French (1993). However, some papers also only single-sort the portfolios based on only the respective risk factor. Seldomly, but sometimes appearing, practitioners use n-fold sorting approaches, implying they sort the assets according to n-folds. However, an important caveat with this strategy is the scalability. For instance, let’s look at the n = 3 case, in which we would sort portfolios based on Size, B2M and previous return (used for the Momentum factor). Let’s assume we would sort portfolios based on each characteristics according to above and below median values. In that case, we would create <span class="math inline">\(2 \times 2 \times 2 = 8\)</span> sorts. For instance, the SMB factor would be:</p>
<p><span class="math display">\[
\begin{equation}
SMB = 1/4(R_{SLU} + R_{SHU} + R_{SLD} + R_{SHD}) -  1/4(R_{BLU} + R_{BHU} + R_{BLD} + R_{BHD})
\end{equation}
\]</span></p>
<p>With this strategy, we now interacted the assets based on each characteristic under consideration. For instance, <span class="math inline">\(R_{SHU}\)</span> is the return of the Small-High-Up portfolio, implying lower than median market capitalisation, higher than median B2M ratio and higher than average past return. It is easy to see that operating on high-dimensional regression settings would quickly render this approach infeasible as the resulting number of created portfolios grows by a factor of <span class="math inline">\(2^n\)</span> if a complete interaction is to be maintained. And this is if we only keep to sort the portfolios based on median values. Given the large amount of factors that have been proposed throughout the last two decades (currently there are over 300 factors that are argued to explain the return structure of US equities), such an approach would require substantial computational power to enable a high-dimensional factor analysis.</p>
<p>Consequently, let’s follow two approaches in the subsequent factor creation.</p>
<ul>
<li>First, we single-sort portfolios based on their market capitalisation and then take their difference to create a Long-Short (LS) Size Portfolio</li>
<li>Then, we recreate the Fama-French SMB factor for the Swiss market by using the formula that was discussed in the lecture</li>
</ul>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb472-1"><a href="factor-models.html#cb472-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the datasets</span></span>
<span id="cb472-2"><a href="factor-models.html#cb472-2" aria-hidden="true" tabindex="-1"></a>Prices_Adj <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_01.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb472-3"><a href="factor-models.html#cb472-3" aria-hidden="true" tabindex="-1"></a>Prices_Unadj <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb472-4"><a href="factor-models.html#cb472-4" aria-hidden="true" tabindex="-1"></a>Shares <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_03.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb472-5"><a href="factor-models.html#cb472-5" aria-hidden="true" tabindex="-1"></a>Book <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_02.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb472-6"><a href="factor-models.html#cb472-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-7"><a href="factor-models.html#cb472-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Time-Series objects</span></span>
<span id="cb472-8"><a href="factor-models.html#cb472-8" aria-hidden="true" tabindex="-1"></a>Prices_Adj_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Prices_Adj[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Adj[,<span class="dv">1</span>])))</span>
<span id="cb472-9"><a href="factor-models.html#cb472-9" aria-hidden="true" tabindex="-1"></a>Prices_Unadj_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Prices_Unadj[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Unadj[,<span class="dv">1</span>])))</span>
<span id="cb472-10"><a href="factor-models.html#cb472-10" aria-hidden="true" tabindex="-1"></a>Shares_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Shares[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Shares[,<span class="dv">1</span>])))</span>
<span id="cb472-11"><a href="factor-models.html#cb472-11" aria-hidden="true" tabindex="-1"></a>Book_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> Book[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Book[,<span class="dv">1</span>])))</span>
<span id="cb472-12"><a href="factor-models.html#cb472-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-13"><a href="factor-models.html#cb472-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the Returns</span></span>
<span id="cb472-14"><a href="factor-models.html#cb472-14" aria-hidden="true" tabindex="-1"></a>Returns_Adj_ts <span class="ot">&lt;-</span> <span class="fu">Return.calculate</span>(Prices_Adj_ts, <span class="at">method =</span> <span class="st">&quot;discrete&quot;</span>)</span>
<span id="cb472-15"><a href="factor-models.html#cb472-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-16"><a href="factor-models.html#cb472-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the market cap Time-Series</span></span>
<span id="cb472-17"><a href="factor-models.html#cb472-17" aria-hidden="true" tabindex="-1"></a>Market_Cap_ts <span class="ot">&lt;-</span> Shares_ts <span class="sc">*</span> Prices_Unadj_ts</span>
<span id="cb472-18"><a href="factor-models.html#cb472-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-19"><a href="factor-models.html#cb472-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Book-to-Market ratio</span></span>
<span id="cb472-20"><a href="factor-models.html#cb472-20" aria-hidden="true" tabindex="-1"></a>B2M_ts <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Book_ts, <span class="dv">6</span>) <span class="sc">/</span> Market_Cap_ts</span>
<span id="cb472-21"><a href="factor-models.html#cb472-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-22"><a href="factor-models.html#cb472-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the cut-off points of each factor composite </span></span>
<span id="cb472-23"><a href="factor-models.html#cb472-23" aria-hidden="true" tabindex="-1"></a>Market_Cap_ts_Median_Cutoff <span class="ot">&lt;-</span> matrixStats<span class="sc">::</span><span class="fu">rowMedians</span>(Market_Cap_ts, <span class="at">na.rm =</span> T)</span>
<span id="cb472-24"><a href="factor-models.html#cb472-24" aria-hidden="true" tabindex="-1"></a>B2M_Low_Cutoff <span class="ot">&lt;-</span> matrixStats<span class="sc">::</span><span class="fu">rowQuantiles</span>(<span class="fu">as.matrix</span>(B2M_ts), <span class="at">probs =</span> <span class="fl">0.3</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb472-25"><a href="factor-models.html#cb472-25" aria-hidden="true" tabindex="-1"></a>B2M_High_Cutoff <span class="ot">&lt;-</span> matrixStats<span class="sc">::</span><span class="fu">rowQuantiles</span>(<span class="fu">as.matrix</span>(B2M_ts), <span class="at">probs =</span> <span class="fl">0.7</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb472-26"><a href="factor-models.html#cb472-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-27"><a href="factor-models.html#cb472-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on the Cutoff values, generate dummies that indicate whether a certain data point is within a given cutoff level</span></span>
<span id="cb472-28"><a href="factor-models.html#cb472-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-29"><a href="factor-models.html#cb472-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(Market_Cap_ts)){</span>
<span id="cb472-30"><a href="factor-models.html#cb472-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create the indicator variables</span></span>
<span id="cb472-31"><a href="factor-models.html#cb472-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For the Market Cap</span></span>
<span id="cb472-32"><a href="factor-models.html#cb472-32" aria-hidden="true" tabindex="-1"></a>  Market_Cap_Small <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(Market_Cap_ts[, i] <span class="sc">&lt;=</span> Market_Cap_ts_Median_Cutoff, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-33"><a href="factor-models.html#cb472-33" aria-hidden="true" tabindex="-1"></a>  Market_Cap_Big <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(Market_Cap_ts[, i] <span class="sc">&gt;</span> Market_Cap_ts_Median_Cutoff, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-34"><a href="factor-models.html#cb472-34" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For the B2M Ratio</span></span>
<span id="cb472-35"><a href="factor-models.html#cb472-35" aria-hidden="true" tabindex="-1"></a>  B2M_Low <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(B2M_ts[, i] <span class="sc">&lt;=</span> B2M_Low_Cutoff, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-36"><a href="factor-models.html#cb472-36" aria-hidden="true" tabindex="-1"></a>  B2M_Mid <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((B2M_ts[, i] <span class="sc">&gt;</span> B2M_Low_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&lt;=</span> B2M_High_Cutoff), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-37"><a href="factor-models.html#cb472-37" aria-hidden="true" tabindex="-1"></a>  B2M_High <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(B2M_ts[, i] <span class="sc">&gt;</span> B2M_High_Cutoff, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-38"><a href="factor-models.html#cb472-38" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For the interaction indicator variables to get S/L, S/M, S/H &amp; B/L, B/M, B/H</span></span>
<span id="cb472-39"><a href="factor-models.html#cb472-39" aria-hidden="true" tabindex="-1"></a>  Assets_SL <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[, i] <span class="sc">&lt;=</span> Market_Cap_ts_Median_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&lt;=</span> B2M_Low_Cutoff), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-40"><a href="factor-models.html#cb472-40" aria-hidden="true" tabindex="-1"></a>  Assets_SM <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[, i] <span class="sc">&lt;=</span> Market_Cap_ts_Median_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&gt;</span> B2M_Low_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&lt;=</span> B2M_High_Cutoff), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-41"><a href="factor-models.html#cb472-41" aria-hidden="true" tabindex="-1"></a>  Assets_SH <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[, i] <span class="sc">&lt;=</span> Market_Cap_ts_Median_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&gt;</span> B2M_High_Cutoff), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-42"><a href="factor-models.html#cb472-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb472-43"><a href="factor-models.html#cb472-43" aria-hidden="true" tabindex="-1"></a>  Assets_BL <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[, i] <span class="sc">&gt;</span> Market_Cap_ts_Median_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&lt;=</span> B2M_Low_Cutoff), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-44"><a href="factor-models.html#cb472-44" aria-hidden="true" tabindex="-1"></a>  Assets_BM <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[, i] <span class="sc">&gt;</span> Market_Cap_ts_Median_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&gt;</span> B2M_Low_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&lt;=</span> B2M_High_Cutoff), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-45"><a href="factor-models.html#cb472-45" aria-hidden="true" tabindex="-1"></a>  Assets_BH <span class="ot">&lt;-</span> <span class="fu">ifelse</span>((Market_Cap_ts[, i] <span class="sc">&gt;</span> Market_Cap_ts_Median_Cutoff) <span class="sc">&amp;</span> (B2M_ts[, i] <span class="sc">&gt;</span> B2M_High_Cutoff), <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb472-46"><a href="factor-models.html#cb472-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb472-47"><a href="factor-models.html#cb472-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the returns</span></span>
<span id="cb472-48"><a href="factor-models.html#cb472-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For the Market Cap</span></span>
<span id="cb472-49"><a href="factor-models.html#cb472-49" aria-hidden="true" tabindex="-1"></a>  Return_Small <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Market_Cap_Small, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-50"><a href="factor-models.html#cb472-50" aria-hidden="true" tabindex="-1"></a>  Return_Big <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Market_Cap_Big, <span class="dv">1</span>)<span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-51"><a href="factor-models.html#cb472-51" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For the B2M Ratio</span></span>
<span id="cb472-52"><a href="factor-models.html#cb472-52" aria-hidden="true" tabindex="-1"></a>  Return_Low <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(B2M_Low, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-53"><a href="factor-models.html#cb472-53" aria-hidden="true" tabindex="-1"></a>  Return_Mid <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(B2M_Mid, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-54"><a href="factor-models.html#cb472-54" aria-hidden="true" tabindex="-1"></a>  Return_High <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(B2M_High, <span class="dv">1</span>)<span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-55"><a href="factor-models.html#cb472-55" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For the interaction indicator variables to get S/L, S/M, S/H &amp; B/L, B/M, B/H returns</span></span>
<span id="cb472-56"><a href="factor-models.html#cb472-56" aria-hidden="true" tabindex="-1"></a>  Returns_SL <span class="ot">&lt;-</span>  stats<span class="sc">::</span><span class="fu">lag</span>(Assets_SL, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-57"><a href="factor-models.html#cb472-57" aria-hidden="true" tabindex="-1"></a>  Returns_SM <span class="ot">&lt;-</span>  stats<span class="sc">::</span><span class="fu">lag</span>(Assets_SM, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-58"><a href="factor-models.html#cb472-58" aria-hidden="true" tabindex="-1"></a>  Returns_SH <span class="ot">&lt;-</span>  stats<span class="sc">::</span><span class="fu">lag</span>(Assets_SH, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-59"><a href="factor-models.html#cb472-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb472-60"><a href="factor-models.html#cb472-60" aria-hidden="true" tabindex="-1"></a>  Returns_BL <span class="ot">&lt;-</span>  stats<span class="sc">::</span><span class="fu">lag</span>(Assets_BL, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-61"><a href="factor-models.html#cb472-61" aria-hidden="true" tabindex="-1"></a>  Returns_BM <span class="ot">&lt;-</span>  stats<span class="sc">::</span><span class="fu">lag</span>(Assets_BM, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-62"><a href="factor-models.html#cb472-62" aria-hidden="true" tabindex="-1"></a>  Returns_BH <span class="ot">&lt;-</span>  stats<span class="sc">::</span><span class="fu">lag</span>(Assets_BH, <span class="dv">1</span>) <span class="sc">*</span> Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>, i]</span>
<span id="cb472-63"><a href="factor-models.html#cb472-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb472-64"><a href="factor-models.html#cb472-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="st">&quot;NESN&quot;</span>){</span>
<span id="cb472-65"><a href="factor-models.html#cb472-65" aria-hidden="true" tabindex="-1"></a>    Returns_SL_final <span class="ot">&lt;-</span> Returns_SL</span>
<span id="cb472-66"><a href="factor-models.html#cb472-66" aria-hidden="true" tabindex="-1"></a>    Returns_SM_final <span class="ot">&lt;-</span> Returns_SM</span>
<span id="cb472-67"><a href="factor-models.html#cb472-67" aria-hidden="true" tabindex="-1"></a>    Returns_SH_final <span class="ot">&lt;-</span> Returns_SH</span>
<span id="cb472-68"><a href="factor-models.html#cb472-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-69"><a href="factor-models.html#cb472-69" aria-hidden="true" tabindex="-1"></a>    Returns_BL_final <span class="ot">&lt;-</span> Returns_BL</span>
<span id="cb472-70"><a href="factor-models.html#cb472-70" aria-hidden="true" tabindex="-1"></a>    Returns_BM_final <span class="ot">&lt;-</span> Returns_BM</span>
<span id="cb472-71"><a href="factor-models.html#cb472-71" aria-hidden="true" tabindex="-1"></a>    Returns_BH_final <span class="ot">&lt;-</span> Returns_BH</span>
<span id="cb472-72"><a href="factor-models.html#cb472-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-73"><a href="factor-models.html#cb472-73" aria-hidden="true" tabindex="-1"></a>    Return_Small_final <span class="ot">&lt;-</span> Return_Small</span>
<span id="cb472-74"><a href="factor-models.html#cb472-74" aria-hidden="true" tabindex="-1"></a>    Return_Big_final <span class="ot">&lt;-</span> Return_Big</span>
<span id="cb472-75"><a href="factor-models.html#cb472-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-76"><a href="factor-models.html#cb472-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb472-77"><a href="factor-models.html#cb472-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb472-78"><a href="factor-models.html#cb472-78" aria-hidden="true" tabindex="-1"></a>    Returns_SL_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Returns_SL_final, Returns_SL)</span>
<span id="cb472-79"><a href="factor-models.html#cb472-79" aria-hidden="true" tabindex="-1"></a>    Returns_SM_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Returns_SM_final, Returns_SM)</span>
<span id="cb472-80"><a href="factor-models.html#cb472-80" aria-hidden="true" tabindex="-1"></a>    Returns_SH_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Returns_SH_final, Returns_SH)</span>
<span id="cb472-81"><a href="factor-models.html#cb472-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-82"><a href="factor-models.html#cb472-82" aria-hidden="true" tabindex="-1"></a>    Returns_BL_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Returns_BL_final, Returns_BL)</span>
<span id="cb472-83"><a href="factor-models.html#cb472-83" aria-hidden="true" tabindex="-1"></a>    Returns_BM_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Returns_BM_final, Returns_BM)</span>
<span id="cb472-84"><a href="factor-models.html#cb472-84" aria-hidden="true" tabindex="-1"></a>    Returns_BH_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Returns_BH_final, Returns_BH)</span>
<span id="cb472-85"><a href="factor-models.html#cb472-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-86"><a href="factor-models.html#cb472-86" aria-hidden="true" tabindex="-1"></a>    Return_Small_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Small_final, Return_Small)</span>
<span id="cb472-87"><a href="factor-models.html#cb472-87" aria-hidden="true" tabindex="-1"></a>    Return_Big_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Big_final, Return_Big)</span>
<span id="cb472-88"><a href="factor-models.html#cb472-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb472-89"><a href="factor-models.html#cb472-89" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb472-90"><a href="factor-models.html#cb472-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-91"><a href="factor-models.html#cb472-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, we create average, equally weighted returns</span></span>
<span id="cb472-92"><a href="factor-models.html#cb472-92" aria-hidden="true" tabindex="-1"></a>EW_Returns_SL <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Returns_SL_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-93"><a href="factor-models.html#cb472-93" aria-hidden="true" tabindex="-1"></a>EW_Returns_SM <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Returns_SM_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-94"><a href="factor-models.html#cb472-94" aria-hidden="true" tabindex="-1"></a>EW_Returns_SH <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Returns_SH_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-95"><a href="factor-models.html#cb472-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-96"><a href="factor-models.html#cb472-96" aria-hidden="true" tabindex="-1"></a>EW_Returns_BL <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Returns_BL_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-97"><a href="factor-models.html#cb472-97" aria-hidden="true" tabindex="-1"></a>EW_Returns_BM <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Returns_BM_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-98"><a href="factor-models.html#cb472-98" aria-hidden="true" tabindex="-1"></a>EW_Returns_BH <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Returns_BH_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-99"><a href="factor-models.html#cb472-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-100"><a href="factor-models.html#cb472-100" aria-hidden="true" tabindex="-1"></a>EW_Returns_Big <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Big_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-101"><a href="factor-models.html#cb472-101" aria-hidden="true" tabindex="-1"></a>EW_Returns_Small <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Small_final, <span class="at">na.rm =</span> T)</span>
<span id="cb472-102"><a href="factor-models.html#cb472-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-103"><a href="factor-models.html#cb472-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on this, we can use the formula to compute the SMB and HML factors</span></span>
<span id="cb472-104"><a href="factor-models.html#cb472-104" aria-hidden="true" tabindex="-1"></a>SMB <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span><span class="sc">*</span>(EW_Returns_SL <span class="sc">+</span> EW_Returns_SM <span class="sc">+</span> EW_Returns_SH) <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span><span class="sc">*</span>(EW_Returns_BL <span class="sc">+</span> EW_Returns_BM <span class="sc">+</span> EW_Returns_BH)</span>
<span id="cb472-105"><a href="factor-models.html#cb472-105" aria-hidden="true" tabindex="-1"></a>LS_Size <span class="ot">&lt;-</span> EW_Returns_Small <span class="sc">-</span> EW_Returns_Big</span>
<span id="cb472-106"><a href="factor-models.html#cb472-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-107"><a href="factor-models.html#cb472-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the Cumulative Product</span></span>
<span id="cb472-108"><a href="factor-models.html#cb472-108" aria-hidden="true" tabindex="-1"></a>Dates <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Adj[,<span class="dv">1</span>][<span class="dv">14</span><span class="sc">:</span><span class="dv">361</span>]))</span>
<span id="cb472-109"><a href="factor-models.html#cb472-109" aria-hidden="true" tabindex="-1"></a>SMB_cp <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Dates,<span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>SMB), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>LS_Size)))</span>
<span id="cb472-110"><a href="factor-models.html#cb472-110" aria-hidden="true" tabindex="-1"></a>SMB_cp_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> SMB_cp[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> Dates)</span>
<span id="cb472-111"><a href="factor-models.html#cb472-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-112"><a href="factor-models.html#cb472-112" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(SMB_cp_ts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Cumulative Return LS SMB&quot;</span>, <span class="st">&quot;Cumulative Return LS Size&quot;</span>)</span></code></pre></div>
<div id="cumulative-returns-of-the-factor-mimicking-portfolios" class="section level4" number="8.4.2.1">
<h4><span class="header-section-number">8.4.2.1</span> Cumulative Returns of the Factor-mimicking Portfolios</h4>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb473-1"><a href="factor-models.html#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb473-2"><a href="factor-models.html#cb473-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb473-3"><a href="factor-models.html#cb473-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(SMB_cp_ts) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>index,<span class="at">y=</span>value, <span class="at">color=</span>series)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb473-4"><a href="factor-models.html#cb473-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;tomato3&quot;</span>, <span class="st">&quot;khaki3&quot;</span>, <span class="st">&quot;lightsteelblue3&quot;</span>, <span class="st">&quot;dodgerblue4&quot;</span>, <span class="st">&quot;violetred4&quot;</span>)) <span class="sc">+</span></span>
<span id="cb473-5"><a href="factor-models.html#cb473-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Relationship of Cumulative Returns on SMB LS PF&quot;</span>) <span class="sc">+</span></span>
<span id="cb473-6"><a href="factor-models.html#cb473-6" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb473-7"><a href="factor-models.html#cb473-7" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb473-8"><a href="factor-models.html#cb473-8" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb473-9"><a href="factor-models.html#cb473-9" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb473-10"><a href="factor-models.html#cb473-10" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb473-11"><a href="factor-models.html#cb473-11" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb473-12"><a href="factor-models.html#cb473-12" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb473-13"><a href="factor-models.html#cb473-13" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb473-14"><a href="factor-models.html#cb473-14" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-263-1.png" width="672" /></p>
<p>Great! We were able to construct the size factor based on both single- and double-sorting strategy. Interestingly, we observe that the Fama-French factor shows lower cumulative returns compared to the single-sorted factor. We can assess this observation analytically. For instance, we could deconstruct the factor again into its individual constituents. Note that the main difference between both was the inclusion of a value characteristic through a B2M ratio. Apparently, this inclusion decreases the cumulative returns quite considerably from the 2000’s on. Let’s visualise this as well:</p>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb474-1"><a href="factor-models.html#cb474-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the Cumulative Product</span></span>
<span id="cb474-2"><a href="factor-models.html#cb474-2" aria-hidden="true" tabindex="-1"></a>Dates <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Adj[,<span class="dv">1</span>][<span class="dv">14</span><span class="sc">:</span><span class="dv">361</span>]))</span>
<span id="cb474-3"><a href="factor-models.html#cb474-3" aria-hidden="true" tabindex="-1"></a>SMB_cp_components <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Dates,</span>
<span id="cb474-4"><a href="factor-models.html#cb474-4" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Returns_SL), </span>
<span id="cb474-5"><a href="factor-models.html#cb474-5" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Returns_SM), </span>
<span id="cb474-6"><a href="factor-models.html#cb474-6" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Returns_SH), </span>
<span id="cb474-7"><a href="factor-models.html#cb474-7" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Returns_BL), </span>
<span id="cb474-8"><a href="factor-models.html#cb474-8" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Returns_BM), </span>
<span id="cb474-9"><a href="factor-models.html#cb474-9" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Returns_BH)))</span>
<span id="cb474-10"><a href="factor-models.html#cb474-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb474-11"><a href="factor-models.html#cb474-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the xts object</span></span>
<span id="cb474-12"><a href="factor-models.html#cb474-12" aria-hidden="true" tabindex="-1"></a>SMB_cp_components_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="at">x =</span> SMB_cp_components[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> Dates)</span>
<span id="cb474-13"><a href="factor-models.html#cb474-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(SMB_cp_components_ts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Cumulative Return S/L&quot;</span>, <span class="st">&quot;Cumulative Return S/M&quot;</span>, <span class="st">&quot;Cumulative Return S/H&quot;</span>, <span class="st">&quot;Cumulative Return B/L&quot;</span>, <span class="st">&quot;Cumulative Return B/M&quot;</span>, <span class="st">&quot;Cumulative Return B/H&quot;</span>)</span>
<span id="cb474-14"><a href="factor-models.html#cb474-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb474-15"><a href="factor-models.html#cb474-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot for the double-sorted SMB Factor</span></span>
<span id="cb474-16"><a href="factor-models.html#cb474-16" aria-hidden="true" tabindex="-1"></a>SMB_plot_comp <span class="ot">&lt;-</span> <span class="fu">tidy</span>(SMB_cp_components_ts) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>index,<span class="at">y=</span>value, <span class="at">color=</span>series)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb474-17"><a href="factor-models.html#cb474-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>( <span class="st">&quot;khaki3&quot;</span>, <span class="st">&quot;lightsteelblue3&quot;</span>, <span class="st">&quot;dodgerblue4&quot;</span>, <span class="st">&quot;tomato3&quot;</span>, <span class="st">&quot;violetred4&quot;</span>, <span class="st">&quot;darkorange2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb474-18"><a href="factor-models.html#cb474-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Relationship of Cumulative Returns on SMB LS PF - Components&quot;</span>) <span class="sc">+</span></span>
<span id="cb474-19"><a href="factor-models.html#cb474-19" aria-hidden="true" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">color=</span><span class="st">&#39;Factor Portfolios&#39;</span>) <span class="sc">+</span></span>
<span id="cb474-20"><a href="factor-models.html#cb474-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;lightsteelblue3&quot;</span>,<span class="st">&quot;dodgerblue4&quot;</span>, <span class="st">&quot;darkorange2&quot;</span>, <span class="st">&quot;springgreen4&quot;</span>, <span class="st">&quot;violetred4&quot;</span>, <span class="st">&quot;goldenrod&quot;</span>,  <span class="st">&quot;khaki3&quot;</span>)) <span class="sc">+</span></span>
<span id="cb474-21"><a href="factor-models.html#cb474-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb474-22"><a href="factor-models.html#cb474-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">hjust=</span><span class="fl">0.3</span>,<span class="at">lineheight=</span><span class="fl">2.4</span>, <span class="at">margin=</span><span class="fu">margin</span>(<span class="dv">15</span>,<span class="dv">0</span>,<span class="dv">15</span>,<span class="dv">0</span>)), </span>
<span id="cb474-23"><a href="factor-models.html#cb474-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb474-24"><a href="factor-models.html#cb474-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb474-25"><a href="factor-models.html#cb474-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb474-26"><a href="factor-models.html#cb474-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb474-27"><a href="factor-models.html#cb474-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), </span>
<span id="cb474-28"><a href="factor-models.html#cb474-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>, <span class="at">margin=</span><span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">0</span>,<span class="dv">10</span>)),</span>
<span id="cb474-29"><a href="factor-models.html#cb474-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>, <span class="at">margin=</span><span class="fu">margin</span>(<span class="dv">10</span>,<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">0</span>)),</span>
<span id="cb474-30"><a href="factor-models.html#cb474-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;grey&quot;</span>)) </span></code></pre></div>
<pre><code>## Scale for &#39;colour&#39; is already present. Adding another scale for &#39;colour&#39;, which will replace the existing scale.</code></pre>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="factor-models.html#cb476-1" aria-hidden="true" tabindex="-1"></a>SMB_plot_comp</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-264-1.png" width="672" /></p>
<p>As we can observe, by distributing the average return into its constituents, we see that average returns are mainly driven by High B2M ratios. Furthermore, we can observe that, throughout all B2M characteristics, assets with larger than median market caps outperform their smaller counterparts. Given this mononous behaviour, it is apparent that the Size factor appears to no longer hold, at least when considering the last 30 years. Furthermore, it can be shown that, although the value factor is still valid, its magnitude depends on the market capitalisation of the securities under consideration, as higher B2M ratios outperform their lower counterparts only when we control for size (for instance, the second best performing portfolio is small and high, and it greatly outperforms the big and medium B2M ratio portfolio).</p>
</div>
<div id="fama-macbeth-regression" class="section level4" number="8.4.2.2">
<h4><span class="header-section-number">8.4.2.2</span> Fama-MacBeth Regression</h4>
<p>We have seen the strength of the Fama-MacBeth (1973) procedure in assessing the ability of a covariate to explain movements in the cross-section of dependent returns during the application of the CAPM, where we were able to empirically prove that the movements of the market returns are unable to sufficiently explain the cross-sectional variation in asset returns. Given that the Market Return in the CAPM is nothing more than a factor itself, it is straight-forward to assume that we can replicate the procedure to include the factors under consideration.</p>
<p>However, since we are working with multiple factors, we need to generalise the formula we encountered in the previous chapter. As such, we first run a time-series regression of each asset’s excess return on the factors under consideration. That is, we run:</p>
<p><span class="math display">\[
r_{i,t} - r_{ft} = \alpha_i + \sum_{k=1}^K \beta_{i,k}f_k + \epsilon_{it}
\]</span></p>
<p>whereas <span class="math inline">\(f_k\)</span> is the k’th factor in the model.</p>
<p>Based on that, retrieve the factor loadings of each factor and perform a cross-sectional regression at each date, in which we regress the (excess) returns of each asset on the factor loadings. That is, we run:</p>
<p><span class="math display">\[
r_{i,t} - r_{ft} = \lambda_{i,0} + \sum_{k=1}^K \lambda_{i,k}\hat{\beta}_{i,k} + u_{it}
\]</span></p>
<p>This is identical to what we have seen in the previous chapter. The only difference is now that we have multiple factors. This is represented by the sum sign. This means that we take factor loading 1 to k and run, at each date, the cross-section of asset returns on the asset returns.</p>
<p>Let’s recreate the FM (1973) approach and apply it to the SMB factor.</p>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb477-1"><a href="factor-models.html#cb477-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the risk free rate as well as the Market Index</span></span>
<span id="cb477-2"><a href="factor-models.html#cb477-2" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A2_dataset_02.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb477-3"><a href="factor-models.html#cb477-3" aria-hidden="true" tabindex="-1"></a>rf_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(rf, (Date <span class="sc">&gt;=</span> <span class="st">&#39;1989-12-01&#39;</span>) <span class="sc">&amp;</span> (Date <span class="sc">&lt;=</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb477-4"><a href="factor-models.html#cb477-4" aria-hidden="true" tabindex="-1"></a>rf_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(rf_sub[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Adj[,<span class="dv">1</span>])))</span>
<span id="cb477-5"><a href="factor-models.html#cb477-5" aria-hidden="true" tabindex="-1"></a>rf_ts_yearly <span class="ot">&lt;-</span> rf_ts<span class="sc">$</span>SWISS.CONFEDERATION.BOND.<span class="fl">1.</span>YEAR...RED..YIELD <span class="sc">/</span> <span class="dv">100</span></span>
<span id="cb477-6"><a href="factor-models.html#cb477-6" aria-hidden="true" tabindex="-1"></a>rf_ts_monthly <span class="ot">&lt;-</span> ((<span class="dv">1</span> <span class="sc">+</span> rf_ts_yearly)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>) <span class="sc">-</span> <span class="dv">1</span>)[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>]</span>
<span id="cb477-7"><a href="factor-models.html#cb477-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(rf_ts_monthly) <span class="ot">&lt;-</span> <span class="st">&quot;rf&quot;</span></span>
<span id="cb477-8"><a href="factor-models.html#cb477-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-9"><a href="factor-models.html#cb477-9" aria-hidden="true" tabindex="-1"></a>SMI <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A2_dataset_03.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb477-10"><a href="factor-models.html#cb477-10" aria-hidden="true" tabindex="-1"></a>SMI_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(SMI, (Date <span class="sc">&gt;=</span> <span class="st">&#39;1989-12-01&#39;</span>) <span class="sc">&amp;</span> (Date <span class="sc">&lt;=</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb477-11"><a href="factor-models.html#cb477-11" aria-hidden="true" tabindex="-1"></a>SMI_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(SMI_sub[,<span class="dv">2</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(<span class="fu">dmy</span>(Prices_Adj[,<span class="dv">1</span>])))</span>
<span id="cb477-12"><a href="factor-models.html#cb477-12" aria-hidden="true" tabindex="-1"></a>SMI_ts_ret <span class="ot">&lt;-</span> <span class="fu">Return.calculate</span>(SMI_ts, <span class="at">method =</span> <span class="st">&quot;discrete&quot;</span>)</span>
<span id="cb477-13"><a href="factor-models.html#cb477-13" aria-hidden="true" tabindex="-1"></a>Mkt_rf_SMI <span class="ot">&lt;-</span> SMI_ts_ret[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>] <span class="sc">-</span> rf_ts_monthly[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>]</span>
<span id="cb477-14"><a href="factor-models.html#cb477-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Mkt_rf_SMI) <span class="ot">&lt;-</span> <span class="st">&quot;Index&quot;</span></span>
<span id="cb477-15"><a href="factor-models.html#cb477-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-16"><a href="factor-models.html#cb477-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the X and y variables for the regression</span></span>
<span id="cb477-17"><a href="factor-models.html#cb477-17" aria-hidden="true" tabindex="-1"></a>SPI_Index_ts <span class="ot">&lt;-</span> <span class="fu">merge.xts</span>(Returns_Adj_ts[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>], rf_ts_monthly[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>], Mkt_rf_SMI[<span class="st">&#39;1991-01-01/2019-12-01&#39;</span>], SMB)</span>
<span id="cb477-18"><a href="factor-models.html#cb477-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-19"><a href="factor-models.html#cb477-19" aria-hidden="true" tabindex="-1"></a><span class="co"># First Pass Regression</span></span>
<span id="cb477-20"><a href="factor-models.html#cb477-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(SPI_Index_ts)[<span class="dv">1</span><span class="sc">:</span><span class="dv">384</span>]){</span>
<span id="cb477-21"><a href="factor-models.html#cb477-21" aria-hidden="true" tabindex="-1"></a>  col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(i)</span>
<span id="cb477-22"><a href="factor-models.html#cb477-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the rolling window coefficients</span></span>
<span id="cb477-23"><a href="factor-models.html#cb477-23" aria-hidden="true" tabindex="-1"></a>  fit_roll_coefs <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>(SPI_Index_ts[,i] <span class="sc">-</span> SPI_Index_ts[,<span class="dv">385</span>] <span class="sc">~</span> SPI_Index_ts[,<span class="dv">386</span>] <span class="sc">+</span> SPI_Index_ts[,<span class="dv">387</span>]))<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb477-24"><a href="factor-models.html#cb477-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-25"><a href="factor-models.html#cb477-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="st">&#39;NESN&#39;</span>){</span>
<span id="cb477-26"><a href="factor-models.html#cb477-26" aria-hidden="true" tabindex="-1"></a>    col_name_final <span class="ot">&lt;-</span> col_name</span>
<span id="cb477-27"><a href="factor-models.html#cb477-27" aria-hidden="true" tabindex="-1"></a>    fit_roll_coefs_final <span class="ot">&lt;-</span> fit_roll_coefs</span>
<span id="cb477-28"><a href="factor-models.html#cb477-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb477-29"><a href="factor-models.html#cb477-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb477-30"><a href="factor-models.html#cb477-30" aria-hidden="true" tabindex="-1"></a>    col_name_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(col_name_final, col_name)</span>
<span id="cb477-31"><a href="factor-models.html#cb477-31" aria-hidden="true" tabindex="-1"></a>    fit_roll_coefs_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(fit_roll_coefs_final, fit_roll_coefs)</span>
<span id="cb477-32"><a href="factor-models.html#cb477-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb477-33"><a href="factor-models.html#cb477-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb477-34"><a href="factor-models.html#cb477-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-35"><a href="factor-models.html#cb477-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the column names</span></span>
<span id="cb477-36"><a href="factor-models.html#cb477-36" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fit_roll_coefs_final) <span class="ot">&lt;-</span> col_name_final</span>
<span id="cb477-37"><a href="factor-models.html#cb477-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-38"><a href="factor-models.html#cb477-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the coefficients at each time period</span></span>
<span id="cb477-39"><a href="factor-models.html#cb477-39" aria-hidden="true" tabindex="-1"></a>beta_smb <span class="ot">&lt;-</span> <span class="fu">t</span>(fit_roll_coefs_final)</span>
<span id="cb477-40"><a href="factor-models.html#cb477-40" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(beta_smb) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;MKT_RF&quot;</span>, <span class="st">&quot;SMB&quot;</span>)</span>
<span id="cb477-41"><a href="factor-models.html#cb477-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-42"><a href="factor-models.html#cb477-42" aria-hidden="true" tabindex="-1"></a>avg_ret <span class="ot">&lt;-</span> <span class="fu">t</span>(SPI_Index_ts[,<span class="dv">1</span><span class="sc">:</span><span class="dv">384</span>])</span>
<span id="cb477-43"><a href="factor-models.html#cb477-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-44"><a href="factor-models.html#cb477-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind them together</span></span>
<span id="cb477-45"><a href="factor-models.html#cb477-45" aria-hidden="true" tabindex="-1"></a>second_pass_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(beta_smb, avg_ret))</span>
<span id="cb477-46"><a href="factor-models.html#cb477-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-47"><a href="factor-models.html#cb477-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform the second pass regression</span></span>
<span id="cb477-48"><a href="factor-models.html#cb477-48" aria-hidden="true" tabindex="-1"></a>factors <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb477-49"><a href="factor-models.html#cb477-49" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">paste</span>(<span class="st">&quot;`&quot;</span>,<span class="fu">names</span>(second_pass_data[,<span class="dv">2</span><span class="sc">:</span><span class="dv">350</span>]) , <span class="st">&quot;`&quot;</span>, <span class="st">&#39; ~ MKT_RF + SMB&#39;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>),</span>
<span id="cb477-50"><a href="factor-models.html#cb477-50" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(f){ <span class="fu">lm</span>(<span class="fu">as.formula</span>(f), <span class="at">data =</span> second_pass_data) <span class="sc">%&gt;%</span>               <span class="co"># Call lm(.)</span></span>
<span id="cb477-51"><a href="factor-models.html#cb477-51" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">summary</span>() <span class="sc">%&gt;%</span>                                    <span class="co"># Gather the output</span></span>
<span id="cb477-52"><a href="factor-models.html#cb477-52" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;$&quot;</span>(coef) <span class="sc">%&gt;%</span>                                    <span class="co"># Keep only the coefs</span></span>
<span id="cb477-53"><a href="factor-models.html#cb477-53" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span>                                 <span class="co"># Convert to dataframe</span></span>
<span id="cb477-54"><a href="factor-models.html#cb477-54" aria-hidden="true" tabindex="-1"></a>                         dplyr<span class="sc">::</span><span class="fu">select</span>(Estimate)}                         <span class="co"># Keep only estimates</span></span>
<span id="cb477-55"><a href="factor-models.html#cb477-55" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb477-56"><a href="factor-models.html#cb477-56" aria-hidden="true" tabindex="-1"></a>lambdas <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(models), <span class="at">ncol =</span> factors <span class="sc">+</span> <span class="dv">1</span>, <span class="at">byrow =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb477-57"><a href="factor-models.html#cb477-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb477-58"><a href="factor-models.html#cb477-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb477-59"><a href="factor-models.html#cb477-59" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(lambdas) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Constant&quot;</span>, <span class="st">&quot;MKT_RF&quot;</span>, <span class="st">&quot;SMB&quot;</span>)</span>
<span id="cb477-60"><a href="factor-models.html#cb477-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-61"><a href="factor-models.html#cb477-61" aria-hidden="true" tabindex="-1"></a><span class="co"># We can now calculate the respective t statistics</span></span>
<span id="cb477-62"><a href="factor-models.html#cb477-62" aria-hidden="true" tabindex="-1"></a>T_Period <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">names</span>(second_pass_data[,<span class="dv">2</span><span class="sc">:</span><span class="dv">350</span>]))</span>
<span id="cb477-63"><a href="factor-models.html#cb477-63" aria-hidden="true" tabindex="-1"></a>average <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(lambdas, <span class="at">na.rm =</span> T)</span>
<span id="cb477-64"><a href="factor-models.html#cb477-64" aria-hidden="true" tabindex="-1"></a>sd <span class="ot">&lt;-</span> <span class="fu">colStdevs</span>(lambdas, <span class="at">na.rm =</span> T)</span>
<span id="cb477-65"><a href="factor-models.html#cb477-65" aria-hidden="true" tabindex="-1"></a>se <span class="ot">&lt;-</span> sd <span class="sc">/</span> <span class="fu">sqrt</span>(T_Period)</span>
<span id="cb477-66"><a href="factor-models.html#cb477-66" aria-hidden="true" tabindex="-1"></a>t_value <span class="ot">&lt;-</span> average<span class="sc">/</span>se</span>
<span id="cb477-67"><a href="factor-models.html#cb477-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-68"><a href="factor-models.html#cb477-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a final data frame</span></span>
<span id="cb477-69"><a href="factor-models.html#cb477-69" aria-hidden="true" tabindex="-1"></a>second_pass <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(average, se, t_value))</span>
<span id="cb477-70"><a href="factor-models.html#cb477-70" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(second_pass) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Risk Premia Estimate&quot;</span>, <span class="st">&quot;Standard Error&quot;</span>, <span class="st">&quot;T-Stat&quot;</span>)</span>
<span id="cb477-71"><a href="factor-models.html#cb477-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb477-72"><a href="factor-models.html#cb477-72" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(second_pass, <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##          Risk Premia Estimate Standard Error  T-Stat
## Constant              -0.0016         0.0045 -0.3631
## MKT_RF                -0.0015         0.0021 -0.7409
## SMB                    0.0063         0.0019  3.2394</code></pre>
<p>As we can see, the SMB factor is already quite successful in explaining the cross-sectional movements under consideration. However, note the following. If we leave the standard errors as is, we are highly likely to induce bias into the regression model. This is two-fold. Initially, we can refer to the usual issues in estimation accuracy based on the covariance structure of the assets under consideration. Note therein the heteroskedasticity and serial correlation assumptions we made in earlier chapters. Further, and even more worrisome, the factor loadings <span class="math inline">\(\hat{\beta}_{i,k}\)</span> are <strong>estimates</strong>. This induces a bias arising from potential selection mistakes, or measurement error, as we have discussed. Usually, we need to further correct for this by applying different sorting or standard error correction techniques (to comprehend how, please refer to Shanken (1992)).</p>
<p>Lastly, we can visualise the behavior of the factor risk premia over time. Doing so, we will make use of the following visualisation.</p>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb479-1"><a href="factor-models.html#cb479-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here, we only take from the second row onwards</span></span>
<span id="cb479-2"><a href="factor-models.html#cb479-2" aria-hidden="true" tabindex="-1"></a>lambdas[<span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(lambdas),] <span class="sc">%&gt;%</span> </span>
<span id="cb479-3"><a href="factor-models.html#cb479-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We only select the factors of interet</span></span>
<span id="cb479-4"><a href="factor-models.html#cb479-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(MKT_RF, SMB) <span class="sc">%&gt;%</span> </span>
<span id="cb479-5"><a href="factor-models.html#cb479-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We then bind the columns such that we can gather them on the same x axis</span></span>
<span id="cb479-6"><a href="factor-models.html#cb479-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(<span class="fu">names</span>(second_pass_data[,<span class="dv">3</span><span class="sc">:</span><span class="dv">350</span>]))) <span class="sc">%&gt;%</span> </span>
<span id="cb479-7"><a href="factor-models.html#cb479-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We gather the factor and the lambda value based on each date</span></span>
<span id="cb479-8"><a href="factor-models.html#cb479-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="at">key =</span> factor, <span class="at">value =</span> lambda, <span class="sc">-</span>date) <span class="sc">%&gt;%</span> </span>
<span id="cb479-9"><a href="factor-models.html#cb479-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here, we just create the ggplot</span></span>
<span id="cb479-10"><a href="factor-models.html#cb479-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> lambda, <span class="at">color =</span> factor)) <span class="sc">+</span> </span>
<span id="cb479-11"><a href="factor-models.html#cb479-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_grid</span>(factor<span class="sc">~</span>.) <span class="sc">+</span> </span>
<span id="cb479-12"><a href="factor-models.html#cb479-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;tomato3&quot;</span>, <span class="st">&quot;khaki3&quot;</span>, <span class="st">&quot;lightsteelblue3&quot;</span>, </span>
<span id="cb479-13"><a href="factor-models.html#cb479-13" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;dodgerblue4&quot;</span>, <span class="st">&quot;violetred4&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb479-14"><a href="factor-models.html#cb479-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-266-1.png" width="672" /></p>
<p>We can observe that both factors behave somewhat dependently on each other. That is, they could potentially represent <strong>collinearity issues</strong>. Both factors compensate in an unclear aggregate effect. This highlights the usefulness of penalized estimates, a machine learning technique that is used to reduce dimensionality of a regression framework. However, it is not the aim of this course to dive into this chapter (yet).</p>
</div>
<div id="factor-competition" class="section level4" number="8.4.2.3">
<h4><span class="header-section-number">8.4.2.3</span> Factor Competition</h4>
<p>As we stated, the main aim of of factors is to explain the cross-section of stock returns. However, as we have shown above, there is a potential that factors are moving simultaneously. In other words, it is likely that some factors are colinear to each other. As we understand it, collinearity is an issue because it absorbs variation of a given covariate, thereby making the estimates of interest redundant. If we have a variable which can be substantially represented by another variable within our model, then the resulting framework will induce variation which does not add explanatory power to the variation of the underlying variable of interest, but only noise. Without stating the theoretical concepts of this situation, this shares great similarities with the bias-and-variance issue usually encountered in machine learning applications. Therein, by introducing highly correlated variables, we add noise to the model which, subsequently, increases the standard errors and thus reduces the precision of the estimates. In addition, Guine (2021) states that, when asset managers decompose the performance of their returns into factors, overlaps (high absolute correlations) between factors yield exposures that are less interpretable; positive and negative exposures compensate each other in an uncomprehensible, or spurious, way.</p>
<p>They state a simple protocol to account for redundant factors, by running regressions of each factor against all others. That is, you run:</p>
<p><span class="math display">\[
f_{t,k} = \alpha_{k} + \sum_{j \neq k} \delta_{k,j}f_{t,j} + \epsilon_{t,k}
\]</span></p>
<p>The authors state that the interesting metric is then the test statistic associated to the estimation of <span class="math inline">\(\alpha_k\)</span>.</p>
<ul>
<li>If <span class="math inline">\(\alpha_k\)</span> is significantly different from zero, then the cross-section of (other) factors fails to explain exhaustively the average return of factor k.</li>
<li>Otherwise, the return of the factor can be captured by exposures to the other factors and is thus redundant.</li>
</ul>
<p>We will come back to this application once we encountered and retrieved more factors for the Swiss market.</p>
</div>
</div>
</div>
<div id="create-your-own-factors-a-step-by-step-example" class="section level2" number="8.5">
<h2><span class="header-section-number">8.5</span> Create your own factors: A step-by-step example</h2>
<p>We have now leveraged the linear factor model and understand how to use these models in order to evaluate variation and detect anomalies. So far, the factors that we used were already pre-defined, meaning that we had the data already and “just” had to use the factor construction strategy discussed. However, without data there is not much to compute. Consequently, in the next part, we intend to bring you closer to the actual task of retrieving data needed to construct factor mimicking portfolios and then use the steps discussed above to coherently construct the factor(s) of interest. This will be quite helpful because it constitutes of all steps necessary to construct, apply and interpret factors (and thus resembles the day to day work within factor setting asset management companies).</p>
<p>However, a major difference to all external asset managers is that we intend not to take too long in order to retrieve the data at hand :-). As such, we will again introduce the field of the relational database computing. We have elaborated the SQL coding approach to retrieve data from a relational database. However, we now enhanced the function which automates the entire process for us such that we can now get data from CRSP, Compustat as well as Thomson Reuters / Datastream. The latter is important because it allows us to access the worldscope data base, which offers the largeest consortium of company financials as well as security characteristics for Non-US stocks.</p>
<div id="setting-up-the-wrds-proxy" class="section level3" number="8.5.1">
<h3><span class="header-section-number">8.5.1</span> Setting up the WRDS proxy</h3>
<p>The function for WRDS Database Query is the following. Again, you don’t need to know the function by heart. However, there are still multiple databases which this function cannot (yet) retrieve. Thus, if you feel like something is missing, try modifying the function and see if you are able to get what you need. Any help is certainly greatly appreciated!</p>
<div class="sourceCode" id="cb480"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb480-1"><a href="factor-models.html#cb480-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a function to automate the data retrieval jobs on SQL</span></span>
<span id="cb480-2"><a href="factor-models.html#cb480-2" aria-hidden="true" tabindex="-1"></a>dataset_a <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-3"><a href="factor-models.html#cb480-3" aria-hidden="true" tabindex="-1"></a>dataset_b <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-4"><a href="factor-models.html#cb480-4" aria-hidden="true" tabindex="-1"></a>dataset_sql <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-5"><a href="factor-models.html#cb480-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-6"><a href="factor-models.html#cb480-6" aria-hidden="true" tabindex="-1"></a>datafmt <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-7"><a href="factor-models.html#cb480-7" aria-hidden="true" tabindex="-1"></a>consol <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-8"><a href="factor-models.html#cb480-8" aria-hidden="true" tabindex="-1"></a>indfmt <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-9"><a href="factor-models.html#cb480-9" aria-hidden="true" tabindex="-1"></a>sic <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-10"><a href="factor-models.html#cb480-10" aria-hidden="true" tabindex="-1"></a>gvkey <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-11"><a href="factor-models.html#cb480-11" aria-hidden="true" tabindex="-1"></a>tic<span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-12"><a href="factor-models.html#cb480-12" aria-hidden="true" tabindex="-1"></a>cusip<span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-13"><a href="factor-models.html#cb480-13" aria-hidden="true" tabindex="-1"></a>isin <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-14"><a href="factor-models.html#cb480-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-15"><a href="factor-models.html#cb480-15" aria-hidden="true" tabindex="-1"></a>filters_list<span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-16"><a href="factor-models.html#cb480-16" aria-hidden="true" tabindex="-1"></a>filters_list_final<span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-17"><a href="factor-models.html#cb480-17" aria-hidden="true" tabindex="-1"></a>filters_list_tweaked<span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-18"><a href="factor-models.html#cb480-18" aria-hidden="true" tabindex="-1"></a>filters_list_tweaked_final<span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-19"><a href="factor-models.html#cb480-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-20"><a href="factor-models.html#cb480-20" aria-hidden="true" tabindex="-1"></a>query_sql <span class="ot">&lt;-</span></span>
<span id="cb480-21"><a href="factor-models.html#cb480-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(dataset_a, dataset_b, column_a, column_b, column_sql, start, end, datafmt, consol, indfmt, sic, gvkey, tic, cusip, isin, <span class="at">multi_function =</span> <span class="cn">TRUE</span>, <span class="at">reuters_ds =</span> <span class="cn">FALSE</span>){</span>
<span id="cb480-22"><a href="factor-models.html#cb480-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-23"><a href="factor-models.html#cb480-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (reuters_ds <span class="sc">==</span> <span class="cn">FALSE</span>){</span>
<span id="cb480-24"><a href="factor-models.html#cb480-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-25"><a href="factor-models.html#cb480-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(column_a)) {</span>
<span id="cb480-26"><a href="factor-models.html#cb480-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(column_a)) {</span>
<span id="cb480-27"><a href="factor-models.html#cb480-27" aria-hidden="true" tabindex="-1"></a>      column_a[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.&quot;</span>, column_a[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-28"><a href="factor-models.html#cb480-28" aria-hidden="true" tabindex="-1"></a>      column_filter_a <span class="ot">=</span> <span class="fu">paste</span>(column_a, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-29"><a href="factor-models.html#cb480-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-30"><a href="factor-models.html#cb480-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-31"><a href="factor-models.html#cb480-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb480-32"><a href="factor-models.html#cb480-32" aria-hidden="true" tabindex="-1"></a>      columns_filter_a <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb480-33"><a href="factor-models.html#cb480-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-34"><a href="factor-models.html#cb480-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-35"><a href="factor-models.html#cb480-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(column_b)) {</span>
<span id="cb480-36"><a href="factor-models.html#cb480-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(column_b)) {</span>
<span id="cb480-37"><a href="factor-models.html#cb480-37" aria-hidden="true" tabindex="-1"></a>      column_b[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;b.&quot;</span>, column_b[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-38"><a href="factor-models.html#cb480-38" aria-hidden="true" tabindex="-1"></a>      column_filter_b <span class="ot">=</span> <span class="fu">paste</span>(column_b, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-39"><a href="factor-models.html#cb480-39" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-40"><a href="factor-models.html#cb480-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-41"><a href="factor-models.html#cb480-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb480-42"><a href="factor-models.html#cb480-42" aria-hidden="true" tabindex="-1"></a>      columns_filter_b <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb480-43"><a href="factor-models.html#cb480-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-44"><a href="factor-models.html#cb480-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-45"><a href="factor-models.html#cb480-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(column_sql)) {</span>
<span id="cb480-46"><a href="factor-models.html#cb480-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(column_sql)) {</span>
<span id="cb480-47"><a href="factor-models.html#cb480-47" aria-hidden="true" tabindex="-1"></a>      column_sql[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;b.&quot;</span>, column_sql[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-48"><a href="factor-models.html#cb480-48" aria-hidden="true" tabindex="-1"></a>      column_filter_sql <span class="ot">=</span> <span class="fu">paste</span>(column_sql, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-49"><a href="factor-models.html#cb480-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-50"><a href="factor-models.html#cb480-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-51"><a href="factor-models.html#cb480-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb480-52"><a href="factor-models.html#cb480-52" aria-hidden="true" tabindex="-1"></a>      columns_filter_sql <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb480-53"><a href="factor-models.html#cb480-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-54"><a href="factor-models.html#cb480-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-55"><a href="factor-models.html#cb480-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(start) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(end)){</span>
<span id="cb480-56"><a href="factor-models.html#cb480-56" aria-hidden="true" tabindex="-1"></a>      date_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.datadate BETWEEN &#39;&quot;</span>, start, <span class="st">&quot;&#39; AND &#39;&quot;</span>, end, <span class="st">&quot;&#39;&quot;</span>)</span>
<span id="cb480-57"><a href="factor-models.html#cb480-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-58"><a href="factor-models.html#cb480-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-59"><a href="factor-models.html#cb480-59" aria-hidden="true" tabindex="-1"></a>    sic_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-60"><a href="factor-models.html#cb480-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(sic)) {</span>
<span id="cb480-61"><a href="factor-models.html#cb480-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sic)) {</span>
<span id="cb480-62"><a href="factor-models.html#cb480-62" aria-hidden="true" tabindex="-1"></a>      sic[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, sic[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-63"><a href="factor-models.html#cb480-63" aria-hidden="true" tabindex="-1"></a>      sic_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.sic IN (&quot;</span>, <span class="fu">paste</span>(sic, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-64"><a href="factor-models.html#cb480-64" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-65"><a href="factor-models.html#cb480-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-66"><a href="factor-models.html#cb480-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-67"><a href="factor-models.html#cb480-67" aria-hidden="true" tabindex="-1"></a>    gvkey_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-68"><a href="factor-models.html#cb480-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(gvkey)) {</span>
<span id="cb480-69"><a href="factor-models.html#cb480-69" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(gvkey)) {</span>
<span id="cb480-70"><a href="factor-models.html#cb480-70" aria-hidden="true" tabindex="-1"></a>      gvkey[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, gvkey[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-71"><a href="factor-models.html#cb480-71" aria-hidden="true" tabindex="-1"></a>      gvkey_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.gvkey IN (&quot;</span>, <span class="fu">paste</span>(gvkey, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-72"><a href="factor-models.html#cb480-72" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-73"><a href="factor-models.html#cb480-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-74"><a href="factor-models.html#cb480-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-75"><a href="factor-models.html#cb480-75" aria-hidden="true" tabindex="-1"></a>    tic_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-76"><a href="factor-models.html#cb480-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(tic)) {</span>
<span id="cb480-77"><a href="factor-models.html#cb480-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tic)) {</span>
<span id="cb480-78"><a href="factor-models.html#cb480-78" aria-hidden="true" tabindex="-1"></a>      tic[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, tic[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-79"><a href="factor-models.html#cb480-79" aria-hidden="true" tabindex="-1"></a>      tic_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.tic IN (&quot;</span>, <span class="fu">paste</span>(tic, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-80"><a href="factor-models.html#cb480-80" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-81"><a href="factor-models.html#cb480-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-82"><a href="factor-models.html#cb480-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-83"><a href="factor-models.html#cb480-83" aria-hidden="true" tabindex="-1"></a>    cusip_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-84"><a href="factor-models.html#cb480-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cusip)) {</span>
<span id="cb480-85"><a href="factor-models.html#cb480-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cusip)) {</span>
<span id="cb480-86"><a href="factor-models.html#cb480-86" aria-hidden="true" tabindex="-1"></a>      cusip[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, cusip[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-87"><a href="factor-models.html#cb480-87" aria-hidden="true" tabindex="-1"></a>      cusip_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.cusip IN (&quot;</span>, <span class="fu">paste</span>(cusip, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-88"><a href="factor-models.html#cb480-88" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-89"><a href="factor-models.html#cb480-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-90"><a href="factor-models.html#cb480-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-91"><a href="factor-models.html#cb480-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(datafmt)) {</span>
<span id="cb480-92"><a href="factor-models.html#cb480-92" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(datafmt)) {</span>
<span id="cb480-93"><a href="factor-models.html#cb480-93" aria-hidden="true" tabindex="-1"></a>      datafmt[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.datafmt =  &#39;&quot;</span>, datafmt[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-94"><a href="factor-models.html#cb480-94" aria-hidden="true" tabindex="-1"></a>      datafmt_filter <span class="ot">=</span> <span class="fu">paste</span>(datafmt, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-95"><a href="factor-models.html#cb480-95" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-96"><a href="factor-models.html#cb480-96" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-97"><a href="factor-models.html#cb480-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-98"><a href="factor-models.html#cb480-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-99"><a href="factor-models.html#cb480-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(consol)) {</span>
<span id="cb480-100"><a href="factor-models.html#cb480-100" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(consol)) {</span>
<span id="cb480-101"><a href="factor-models.html#cb480-101" aria-hidden="true" tabindex="-1"></a>      consol[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.consol =  &#39;&quot;</span>, consol[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-102"><a href="factor-models.html#cb480-102" aria-hidden="true" tabindex="-1"></a>      consol_filter <span class="ot">=</span> <span class="fu">paste</span>(consol, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-103"><a href="factor-models.html#cb480-103" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-104"><a href="factor-models.html#cb480-104" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-105"><a href="factor-models.html#cb480-105" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-106"><a href="factor-models.html#cb480-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-107"><a href="factor-models.html#cb480-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(indfmt)) {</span>
<span id="cb480-108"><a href="factor-models.html#cb480-108" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(indfmt)) {</span>
<span id="cb480-109"><a href="factor-models.html#cb480-109" aria-hidden="true" tabindex="-1"></a>      indfmt[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.indfmt =  &#39;&quot;</span>, indfmt[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-110"><a href="factor-models.html#cb480-110" aria-hidden="true" tabindex="-1"></a>      indfmt_filter <span class="ot">=</span> <span class="fu">paste</span>(indfmt, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-111"><a href="factor-models.html#cb480-111" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-112"><a href="factor-models.html#cb480-112" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-113"><a href="factor-models.html#cb480-113" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-114"><a href="factor-models.html#cb480-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-115"><a href="factor-models.html#cb480-115" aria-hidden="true" tabindex="-1"></a>    filters <span class="ot">=</span> <span class="fu">c</span>(date_filter, cusip_filter, tic_filter, gvkey_filter, sic_filter, datafmt_filter, consol_filter, indfmt_filter)</span>
<span id="cb480-116"><a href="factor-models.html#cb480-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-117"><a href="factor-models.html#cb480-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filters)){</span>
<span id="cb480-118"><a href="factor-models.html#cb480-118" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(filters[i])){</span>
<span id="cb480-119"><a href="factor-models.html#cb480-119" aria-hidden="true" tabindex="-1"></a>        filters_list[i] <span class="ot">=</span> <span class="fu">paste</span>(filters[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-120"><a href="factor-models.html#cb480-120" aria-hidden="true" tabindex="-1"></a>        filters_list_final <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot; WHERE &quot;</span>, <span class="fu">paste</span>(filters_list, <span class="at">collapse =</span> <span class="st">&quot; AND &quot;</span>))</span>
<span id="cb480-121"><a href="factor-models.html#cb480-121" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-122"><a href="factor-models.html#cb480-122" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-123"><a href="factor-models.html#cb480-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb480-124"><a href="factor-models.html#cb480-124" aria-hidden="true" tabindex="-1"></a>    filters_tweaked <span class="ot">=</span> <span class="fu">c</span>(date_filter, cusip_filter, tic_filter, gvkey_filter, sic_filter)</span>
<span id="cb480-125"><a href="factor-models.html#cb480-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-126"><a href="factor-models.html#cb480-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(filters_tweaked[i])){</span>
<span id="cb480-127"><a href="factor-models.html#cb480-127" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filters_tweaked)){</span>
<span id="cb480-128"><a href="factor-models.html#cb480-128" aria-hidden="true" tabindex="-1"></a>        filters_list_tweaked[i] <span class="ot">=</span> <span class="fu">paste</span>(filters_tweaked[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-129"><a href="factor-models.html#cb480-129" aria-hidden="true" tabindex="-1"></a>        filters_list_tweaked_final <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot; WHERE &quot;</span>, <span class="fu">paste</span>(filters_list_tweaked, <span class="at">collapse =</span> <span class="st">&quot; AND &quot;</span>))</span>
<span id="cb480-130"><a href="factor-models.html#cb480-130" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-131"><a href="factor-models.html#cb480-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-132"><a href="factor-models.html#cb480-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-133"><a href="factor-models.html#cb480-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (multi_function <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb480-134"><a href="factor-models.html#cb480-134" aria-hidden="true" tabindex="-1"></a>      sql <span class="ot">=</span> (<span class="fu">paste</span>(<span class="st">&quot;SELECT &quot;</span>, </span>
<span id="cb480-135"><a href="factor-models.html#cb480-135" aria-hidden="true" tabindex="-1"></a>                   column_filter_a, </span>
<span id="cb480-136"><a href="factor-models.html#cb480-136" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;, &quot;</span>, column_filter_b,</span>
<span id="cb480-137"><a href="factor-models.html#cb480-137" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; FROM  &quot;</span>, dataset_a, <span class="st">&quot; a&quot;</span>,</span>
<span id="cb480-138"><a href="factor-models.html#cb480-138" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; inner join &quot;</span>, dataset_b, <span class="st">&quot; b&quot;</span>, </span>
<span id="cb480-139"><a href="factor-models.html#cb480-139" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; on &quot;</span>, column_a[<span class="dv">1</span>], <span class="st">&quot; = &quot;</span>, column_sql[<span class="dv">1</span>], </span>
<span id="cb480-140"><a href="factor-models.html#cb480-140" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; and &quot;</span>, column_a[<span class="dv">2</span>], <span class="st">&quot; = &quot;</span>, column_sql[<span class="dv">2</span>], </span>
<span id="cb480-141"><a href="factor-models.html#cb480-141" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; and &quot;</span>, column_a[<span class="dv">3</span>], <span class="st">&quot; = &quot;</span>, column_sql[<span class="dv">3</span>],</span>
<span id="cb480-142"><a href="factor-models.html#cb480-142" aria-hidden="true" tabindex="-1"></a>                   filters_list_final))</span>
<span id="cb480-143"><a href="factor-models.html#cb480-143" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb480-144"><a href="factor-models.html#cb480-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-145"><a href="factor-models.html#cb480-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb480-146"><a href="factor-models.html#cb480-146" aria-hidden="true" tabindex="-1"></a>      sql <span class="ot">=</span> (<span class="fu">paste</span>(<span class="st">&quot;SELECT &quot;</span>, </span>
<span id="cb480-147"><a href="factor-models.html#cb480-147" aria-hidden="true" tabindex="-1"></a>                   column_filter_a, </span>
<span id="cb480-148"><a href="factor-models.html#cb480-148" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; FROM  &quot;</span>, dataset_a, <span class="st">&quot; a&quot;</span>,</span>
<span id="cb480-149"><a href="factor-models.html#cb480-149" aria-hidden="true" tabindex="-1"></a>                   filters_list_tweaked_final))</span>
<span id="cb480-150"><a href="factor-models.html#cb480-150" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-151"><a href="factor-models.html#cb480-151" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-152"><a href="factor-models.html#cb480-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb480-153"><a href="factor-models.html#cb480-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-154"><a href="factor-models.html#cb480-154" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb480-155"><a href="factor-models.html#cb480-155" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(column_a)) {</span>
<span id="cb480-156"><a href="factor-models.html#cb480-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(column_a)) {</span>
<span id="cb480-157"><a href="factor-models.html#cb480-157" aria-hidden="true" tabindex="-1"></a>        column_a[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.&quot;</span>, column_a[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-158"><a href="factor-models.html#cb480-158" aria-hidden="true" tabindex="-1"></a>        column_filter_a <span class="ot">=</span> <span class="fu">paste</span>(column_a, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-159"><a href="factor-models.html#cb480-159" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-160"><a href="factor-models.html#cb480-160" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-161"><a href="factor-models.html#cb480-161" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb480-162"><a href="factor-models.html#cb480-162" aria-hidden="true" tabindex="-1"></a>        columns_filter_a <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb480-163"><a href="factor-models.html#cb480-163" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-164"><a href="factor-models.html#cb480-164" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-165"><a href="factor-models.html#cb480-165" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(column_b)) {</span>
<span id="cb480-166"><a href="factor-models.html#cb480-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(column_b)) {</span>
<span id="cb480-167"><a href="factor-models.html#cb480-167" aria-hidden="true" tabindex="-1"></a>        column_b[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;b.&quot;</span>, column_b[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-168"><a href="factor-models.html#cb480-168" aria-hidden="true" tabindex="-1"></a>        column_filter_b <span class="ot">=</span> <span class="fu">paste</span>(column_b, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-169"><a href="factor-models.html#cb480-169" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-170"><a href="factor-models.html#cb480-170" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-171"><a href="factor-models.html#cb480-171" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb480-172"><a href="factor-models.html#cb480-172" aria-hidden="true" tabindex="-1"></a>        columns_filter_b <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb480-173"><a href="factor-models.html#cb480-173" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-174"><a href="factor-models.html#cb480-174" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-175"><a href="factor-models.html#cb480-175" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(column_sql)) {</span>
<span id="cb480-176"><a href="factor-models.html#cb480-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(column_sql)) {</span>
<span id="cb480-177"><a href="factor-models.html#cb480-177" aria-hidden="true" tabindex="-1"></a>        column_sql[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;b.&quot;</span>, column_sql[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-178"><a href="factor-models.html#cb480-178" aria-hidden="true" tabindex="-1"></a>        column_filter_sql <span class="ot">=</span> <span class="fu">paste</span>(column_sql, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>)</span>
<span id="cb480-179"><a href="factor-models.html#cb480-179" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-180"><a href="factor-models.html#cb480-180" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-181"><a href="factor-models.html#cb480-181" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb480-182"><a href="factor-models.html#cb480-182" aria-hidden="true" tabindex="-1"></a>        columns_filter_sql <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb480-183"><a href="factor-models.html#cb480-183" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-184"><a href="factor-models.html#cb480-184" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-185"><a href="factor-models.html#cb480-185" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(start) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(end)){</span>
<span id="cb480-186"><a href="factor-models.html#cb480-186" aria-hidden="true" tabindex="-1"></a>        date_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.year_ BETWEEN &#39;&quot;</span>, start, <span class="st">&quot;&#39; AND &#39;&quot;</span>, end, <span class="st">&quot;&#39;&quot;</span>)</span>
<span id="cb480-187"><a href="factor-models.html#cb480-187" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-188"><a href="factor-models.html#cb480-188" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-189"><a href="factor-models.html#cb480-189" aria-hidden="true" tabindex="-1"></a>      sic_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-190"><a href="factor-models.html#cb480-190" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(sic)) {</span>
<span id="cb480-191"><a href="factor-models.html#cb480-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sic)) {</span>
<span id="cb480-192"><a href="factor-models.html#cb480-192" aria-hidden="true" tabindex="-1"></a>        sic[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, sic[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-193"><a href="factor-models.html#cb480-193" aria-hidden="true" tabindex="-1"></a>        sic_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.sic IN (&quot;</span>, <span class="fu">paste</span>(sic, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-194"><a href="factor-models.html#cb480-194" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-195"><a href="factor-models.html#cb480-195" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-196"><a href="factor-models.html#cb480-196" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-197"><a href="factor-models.html#cb480-197" aria-hidden="true" tabindex="-1"></a>      gvkey_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-198"><a href="factor-models.html#cb480-198" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(gvkey)) {</span>
<span id="cb480-199"><a href="factor-models.html#cb480-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(gvkey)) {</span>
<span id="cb480-200"><a href="factor-models.html#cb480-200" aria-hidden="true" tabindex="-1"></a>        gvkey[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, gvkey[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-201"><a href="factor-models.html#cb480-201" aria-hidden="true" tabindex="-1"></a>        gvkey_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.gvkey IN (&quot;</span>, <span class="fu">paste</span>(gvkey, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-202"><a href="factor-models.html#cb480-202" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-203"><a href="factor-models.html#cb480-203" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-204"><a href="factor-models.html#cb480-204" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-205"><a href="factor-models.html#cb480-205" aria-hidden="true" tabindex="-1"></a>      tic_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-206"><a href="factor-models.html#cb480-206" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(tic)) {</span>
<span id="cb480-207"><a href="factor-models.html#cb480-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tic)) {</span>
<span id="cb480-208"><a href="factor-models.html#cb480-208" aria-hidden="true" tabindex="-1"></a>        tic[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, tic[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-209"><a href="factor-models.html#cb480-209" aria-hidden="true" tabindex="-1"></a>        tic_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.item5601 IN (&quot;</span>, <span class="fu">paste</span>(tic, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-210"><a href="factor-models.html#cb480-210" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-211"><a href="factor-models.html#cb480-211" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-212"><a href="factor-models.html#cb480-212" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-213"><a href="factor-models.html#cb480-213" aria-hidden="true" tabindex="-1"></a>      cusip_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-214"><a href="factor-models.html#cb480-214" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cusip)) {</span>
<span id="cb480-215"><a href="factor-models.html#cb480-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cusip)) {</span>
<span id="cb480-216"><a href="factor-models.html#cb480-216" aria-hidden="true" tabindex="-1"></a>        cusip[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, cusip[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-217"><a href="factor-models.html#cb480-217" aria-hidden="true" tabindex="-1"></a>        cusip_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.item6004 IN (&quot;</span>, <span class="fu">paste</span>(cusip, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-218"><a href="factor-models.html#cb480-218" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-219"><a href="factor-models.html#cb480-219" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-220"><a href="factor-models.html#cb480-220" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-221"><a href="factor-models.html#cb480-221" aria-hidden="true" tabindex="-1"></a>      isin_filter <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb480-222"><a href="factor-models.html#cb480-222" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(isin)) {</span>
<span id="cb480-223"><a href="factor-models.html#cb480-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(isin)) {</span>
<span id="cb480-224"><a href="factor-models.html#cb480-224" aria-hidden="true" tabindex="-1"></a>        isin[i] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;&#39;&quot;</span>, isin[i], <span class="st">&quot;&#39;&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-225"><a href="factor-models.html#cb480-225" aria-hidden="true" tabindex="-1"></a>        isin_filter <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;a.item6008 IN (&quot;</span>, <span class="fu">paste</span>(isin, <span class="at">collapse =</span> <span class="st">&#39;,&#39;</span>), <span class="st">&quot;)&quot;</span>)</span>
<span id="cb480-226"><a href="factor-models.html#cb480-226" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-227"><a href="factor-models.html#cb480-227" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-228"><a href="factor-models.html#cb480-228" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-229"><a href="factor-models.html#cb480-229" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-230"><a href="factor-models.html#cb480-230" aria-hidden="true" tabindex="-1"></a>      filters <span class="ot">=</span> <span class="fu">c</span>(date_filter, cusip_filter, tic_filter, gvkey_filter, sic_filter, isin_filter)</span>
<span id="cb480-231"><a href="factor-models.html#cb480-231" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-232"><a href="factor-models.html#cb480-232" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filters)){</span>
<span id="cb480-233"><a href="factor-models.html#cb480-233" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(filters[i])){</span>
<span id="cb480-234"><a href="factor-models.html#cb480-234" aria-hidden="true" tabindex="-1"></a>          filters_list[i] <span class="ot">=</span> <span class="fu">paste</span>(filters[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-235"><a href="factor-models.html#cb480-235" aria-hidden="true" tabindex="-1"></a>          filters_list_final <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot; WHERE &quot;</span>, <span class="fu">paste</span>(filters_list, <span class="at">collapse =</span> <span class="st">&quot; AND &quot;</span>))</span>
<span id="cb480-236"><a href="factor-models.html#cb480-236" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-237"><a href="factor-models.html#cb480-237" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-238"><a href="factor-models.html#cb480-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb480-239"><a href="factor-models.html#cb480-239" aria-hidden="true" tabindex="-1"></a>      filters_tweaked <span class="ot">=</span> <span class="fu">c</span>(date_filter, cusip_filter, tic_filter, gvkey_filter, sic_filter, isin_filter)</span>
<span id="cb480-240"><a href="factor-models.html#cb480-240" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-241"><a href="factor-models.html#cb480-241" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(filters_tweaked[i])){</span>
<span id="cb480-242"><a href="factor-models.html#cb480-242" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filters_tweaked)){</span>
<span id="cb480-243"><a href="factor-models.html#cb480-243" aria-hidden="true" tabindex="-1"></a>          filters_list_tweaked[i] <span class="ot">=</span> <span class="fu">paste</span>(filters_tweaked[i], <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb480-244"><a href="factor-models.html#cb480-244" aria-hidden="true" tabindex="-1"></a>          filters_list_tweaked_final <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot; WHERE &quot;</span>, <span class="fu">paste</span>(filters_list_tweaked, <span class="at">collapse =</span> <span class="st">&quot; AND &quot;</span>))</span>
<span id="cb480-245"><a href="factor-models.html#cb480-245" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb480-246"><a href="factor-models.html#cb480-246" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-247"><a href="factor-models.html#cb480-247" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-248"><a href="factor-models.html#cb480-248" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (multi_function <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb480-249"><a href="factor-models.html#cb480-249" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">=</span> (<span class="fu">paste</span>(<span class="st">&quot;SELECT &quot;</span>, </span>
<span id="cb480-250"><a href="factor-models.html#cb480-250" aria-hidden="true" tabindex="-1"></a>                     column_filter_a, </span>
<span id="cb480-251"><a href="factor-models.html#cb480-251" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;, &quot;</span>, column_filter_b,</span>
<span id="cb480-252"><a href="factor-models.html#cb480-252" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot; FROM  &quot;</span>, dataset_a, <span class="st">&quot; a&quot;</span>,</span>
<span id="cb480-253"><a href="factor-models.html#cb480-253" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot; inner join &quot;</span>, dataset_b, <span class="st">&quot; b&quot;</span>, </span>
<span id="cb480-254"><a href="factor-models.html#cb480-254" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot; on &quot;</span>, column_a[<span class="dv">1</span>], <span class="st">&quot; = &quot;</span>, column_sql[<span class="dv">1</span>], </span>
<span id="cb480-255"><a href="factor-models.html#cb480-255" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot; and &quot;</span>, column_a[<span class="dv">2</span>], <span class="st">&quot; = &quot;</span>, column_sql[<span class="dv">2</span>], </span>
<span id="cb480-256"><a href="factor-models.html#cb480-256" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot; and &quot;</span>, column_a[<span class="dv">3</span>], <span class="st">&quot; = &quot;</span>, column_sql[<span class="dv">3</span>],</span>
<span id="cb480-257"><a href="factor-models.html#cb480-257" aria-hidden="true" tabindex="-1"></a>                     filters_list_final))</span>
<span id="cb480-258"><a href="factor-models.html#cb480-258" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb480-259"><a href="factor-models.html#cb480-259" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-260"><a href="factor-models.html#cb480-260" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb480-261"><a href="factor-models.html#cb480-261" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">=</span> (<span class="fu">paste</span>(<span class="st">&quot;SELECT &quot;</span>, </span>
<span id="cb480-262"><a href="factor-models.html#cb480-262" aria-hidden="true" tabindex="-1"></a>                     column_filter_a, </span>
<span id="cb480-263"><a href="factor-models.html#cb480-263" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot; FROM  &quot;</span>, dataset_a, <span class="st">&quot; a&quot;</span>,</span>
<span id="cb480-264"><a href="factor-models.html#cb480-264" aria-hidden="true" tabindex="-1"></a>                     filters_list_tweaked_final))</span>
<span id="cb480-265"><a href="factor-models.html#cb480-265" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb480-266"><a href="factor-models.html#cb480-266" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb480-267"><a href="factor-models.html#cb480-267" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb480-268"><a href="factor-models.html#cb480-268" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Note that we will retrieve the data needed from the WRDS services. In order to use their services, we need to log onto their system. This can be done again by using the command below.</p>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb481-1"><a href="factor-models.html#cb481-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Open the connection </span></span>
<span id="cb481-2"><a href="factor-models.html#cb481-2" aria-hidden="true" tabindex="-1"></a>wrds <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">Postgres</span>(),</span>
<span id="cb481-3"><a href="factor-models.html#cb481-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">host=</span><span class="st">&#39;wrds-pgdata.wharton.upenn.edu&#39;</span>,</span>
<span id="cb481-4"><a href="factor-models.html#cb481-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">port=</span><span class="dv">9737</span>,</span>
<span id="cb481-5"><a href="factor-models.html#cb481-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dbname=</span><span class="st">&#39;wrds&#39;</span>,</span>
<span id="cb481-6"><a href="factor-models.html#cb481-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sslmode=</span><span class="st">&#39;require&#39;</span>,</span>
<span id="cb481-7"><a href="factor-models.html#cb481-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">user=</span><span class="st">&#39;gostlow&#39;</span>,</span>
<span id="cb481-8"><a href="factor-models.html#cb481-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">password =</span> <span class="st">&quot;climaterisk8K&quot;</span>)</span></code></pre></div>
<p>Once the credentials are valid, we can access the database and start retrieving the data we require.</p>
</div>
<div id="factors-of-interest" class="section level3" number="8.5.2">
<h3><span class="header-section-number">8.5.2</span> Factors of interest</h3>
<p>Having established a connection to the WRDS services, the next question is which factors we want to create ourselves. In order to do so, we will focus at the most commonly known and publicly cited anomaly factors currently present. These include:</p>
<ul>
<li>Size (Small Minus Big (SMB))</li>
<li>Value (High Minus Low (HML))</li>
<li>Momentum (Winners Minus Losers (WML))</li>
<li>Profitability (Robust Minus Weak (RMW))</li>
<li>Investment (Conservative Minus Aggressive (CMA))</li>
<li>Low Risk (Betting Against Beta (BAB))</li>
</ul>
<p>We already know how to calculate the Size factor. However, for the remaining factors, we still need to define the common framework of construction.</p>
<p>The <strong>Value</strong> factor is constructed by retrieving data on the Book to Market Ratio (B2M). The formula is:</p>
<p><span class="math display">\[
\text{B2M}_t = \frac{\text{Book-Equity}_{t-6}}{\text{Market Cap}_t}
\]</span></p>
<p>Using this formula, at each date t, we go long in assets with a <strong>high Book-to-Market Ratio and Short in assets with a low Book-to-Market ratio</strong>. Therein, we define High and Low as the <strong>30th and 70th percentile</strong> of the distribution, respectively. The respective indicator on High and Low B2M Ratios is then <strong>interacted with the indicator on small or large cap firms</strong>, whereas we use the <strong>median value as cut-off for the company size</strong>.</p>
<p>The factor is then constructed using the following formula:</p>
<p><span class="math display">\[
\text{HML}_t = 1/2 * (SH_t + BH_t) - 1/2*(SL_t + BL_t)
\]</span></p>
<p>whereas <span class="math inline">\(SH_t\)</span> is the equal- or value-weighted return of small (below or at median) market cap and high B2M (above 70th percentile) stocks, <span class="math inline">\(BH_t\)</span> is the return of Big and High B2M securities and <span class="math inline">\(SL_t\)</span> as well as <span class="math inline">\(BL_t\)</span> are their low B2M counterparts.</p>
<p>The <strong>Momentum</strong> factor is constructed by retrieving the data on Adjusted Stock Prices. The formula is:</p>
<p><span class="math display">\[
\text{Momentum}_t = \frac{\text{Prices Adjusted}_{t-1} - \text{Prices Adjusted}_{t-12}}{\text{Prices Adjusted}_{t-12}}
\]</span></p>
<p>Using this formula, at each date t, we go long in assets with a <strong>high Past Adjusted return and Short in assets with a low Past Adjusted return</strong>. Therein, we define High and Low again as the <strong>30th and 70th percentile</strong> of the distribution, respectively. The respective indicator on High and Low Past Return Adjusted Ratios is then <strong>interacted with the indicator on small or large cap firms</strong>, whereas we use the <strong>median value as cut-off for the company size</strong>.</p>
<p>The factor is then constructed using the following formula:</p>
<p><span class="math display">\[
\text{WML}_t = 1/2 * (SW_t + BW_t) - 1/2*(SL_t + BL_t)
\]</span></p>
<p>whereas <span class="math inline">\(SW_t\)</span> is the equal- or value-weighted return of small (below or at median) market cap and return winner (above 70th percentile) stocks, <span class="math inline">\(BW_t\)</span> is the return of Big and return winner securities and <span class="math inline">\(SL_t\)</span> as well as <span class="math inline">\(BL_t\)</span> are their return loser counterparts.</p>
<p>The <strong>Profitability</strong> factor is constructed by retrieving the data on revenues, cost, expenses as well as book equity. The formula is:</p>
<p><span class="math display">\[
\text{Profitability}_t = \frac{\text{Operating Income}_{t} - \text{COGS}_{t} - \text{SGAE}_{t} - \text{Interest Expenses}_{t} }{\text{Total Book Equity}_{t}}
\]</span></p>
<p>whereas Operating Income is just the total income from operations, COGS are the Costs of Goods Sold, SGAE are Selling, General and Administrative Expenses and Total Book Equity is the Equity of the Balance Sheet. Note that COGS and SGAE are also sometimes referred to as Operating Expenses (although they are not identical they match quite well so for calculation purposes it should not depend too greatly on which accounting numbers you take).</p>
<p>Using this formula, at each date t, we go long in assets with a <strong>high Profitability and Short in assets with a low Profitability</strong>. Therein, we define High and Low again as the <strong>30th and 70th percentile</strong> of the distribution, respectively. The respective indicator on High and Low Past Return Adjusted Ratios is then <strong>interacted with the indicator on small or large cap firms</strong>, whereas we use the <strong>median value as cut-off for the company size</strong>.</p>
<p>The factor is then constructed using the following formula:</p>
<p><span class="math display">\[
\text{RMW}_t = 1/2 * (SR_t + BR_t) - 1/2*(SW_t + BW_t)
\]</span></p>
<p>whereas <span class="math inline">\(SR_t\)</span> is the equal- or value-weighted return of small (below or at median) market cap and robust (above 70th percentile) stocks, <span class="math inline">\(BR_t\)</span> is the return of Big and robust securities and <span class="math inline">\(SW_t\)</span> as well as <span class="math inline">\(BW_t\)</span> are their rprofitability weak counterparts.</p>
<p>The <strong>Investment</strong> factor is constructed by retrieving the data on total assets. The formula is:</p>
<p><span class="math display">\[
\text{Investment}_t = \frac{\text{Total Assets}_{t} - \text{Total Assets}_{t-1}}{\text{Total Assets}_{t-1}}
\]</span></p>
<p><strong>Aggressive firms</strong> are those that experience the <strong>largest growth in assets</strong>. Using this formula, at each date t, we go long in assets with a <strong>high Asset growth and Short in assets with a low Asset growth</strong>. Therein, we define High and Low again as the <strong>30th and 70th percentile</strong> of the distribution, respectively. The respective indicator on High and Low Past Return Adjusted Ratios is then <strong>interacted with the indicator on small or large cap firms</strong>, whereas we use the <strong>median value as cut-off for the company size</strong>.</p>
<p>The factor is then constructed using the following formula:</p>
<p><span class="math display">\[
\text{CMA}_t = 1/2 * (SC_t + BC_t) - 1/2*(SA_t + BA_t)
\]</span></p>
<p>whereas <span class="math inline">\(SC_t\)</span> is the equal- or value-weighted return of small (below or at median) market cap and conservative (below 30th percentile) stocks, <span class="math inline">\(BC_t\)</span> is the return of Big and conservative securities and <span class="math inline">\(SW_t\)</span> as well as <span class="math inline">\(BW_t\)</span> are their asset growth aggressive counterparts.</p>
<p>Lastly, the <strong>Betting Against Beta</strong> factor is constructed in a somewhat advanced manner. We follow the approach by Frazzini and Pedersen (2014) here and construct the factor by running rolling regressions of the excess returns on market excess returns. However, we will not directly run the regressions. Rather, we will calculate the following formula for each beta at date t:</p>
<p><span class="math display">\[
\hat{\beta}_{TS}= \hat{\rho}\cdot \frac{\hat{\sigma}_i}{\hat{\sigma}_M}
\]</span></p>
<p>whereas <span class="math inline">\(\hat{\sigma}_i\)</span> and <span class="math inline">\(\hat{\sigma}_i\)</span> are the estimated volatilities for the stock and the market and <span class="math inline">\(\hat{\rho}\)</span> is their estimated their correlation. They use a one-year rolling standard deviation to estimate volatility as well as a five-year horizon for the correlation.</p>
<p>Lastly, the authors reduce the influence of outliers by following Vasicek (1973) and construct a shrinkage of the time series estimate of beta towards 1 by running:</p>
<p><span class="math display">\[
\hat{\beta}_{i} = 0.4\cdot \hat{\beta}_{TS} + 0.6 \cdot 1
\]</span></p>
<p>Having constructed the beta estimates, they rank the betas and go long in assets with a <strong>below median beta value</strong> and short in assets with an <strong>above median beta value</strong>.</p>
<p>Then, in each portfolio, <strong>securities are weighted by the ranked betas</strong> (i.e., lower-beta securities have larger weights in the low-beta portfolio and higher-beta securities have larger weights in the high-beta portfolio). To put it more formally, we have that <span class="math inline">\(z_i = rank(\hat{\beta}_{it})\)</span> and <span class="math inline">\(\bar{z} = \frac{1}{n}\sum_{i=1}^N z_i\)</span>, whereas <span class="math inline">\(z_i\)</span> indicates the rank of the i’th beta and <span class="math inline">\(\bar{z}\)</span> is the average rank, where n is the number of securities.</p>
<p>Based on this, the portfolio weights are constructed as:</p>
<p><span class="math display">\[
w_{it} = k(z_{it} - \bar{z}_t)
\]</span></p>
<p>whereas <span class="math inline">\(k = \frac{2}{\sum_{i=1}^N |z_i - z|}\)</span> is a normalisation constant. Based on these weights, we can finally construct the BAB factor as:</p>
<p><span class="math display">\[
\text{BAB}_t = \frac{1}{\sum_{i=1}^N\beta_{it}^Lw_{it}^L}(\sum_{i=1}^N r_{i,t+1}^Lw_{it}^L - r_f) - \frac{1}{\sum_{i=1}^N\beta_{it}^Hw_{it}^H}(\sum_{i=1}^N r_{i,t+1}^Hw_{it}^H - r_f)
\]</span></p>
<p>For all the factors, it is important to understand that they need to be <strong>lagged by one period to avoid any look-ahead bias</strong>.</p>
</div>
<div id="get-the-data-to-construct-the-factors" class="section level3" number="8.5.3">
<h3><span class="header-section-number">8.5.3</span> Get the data to construct the factors</h3>
<p>We now proceed by retrieving the data from the datastream services. Therein, we will need to fetch two distinct types of data. The company <strong>stock characteristics</strong> which are taken from the <strong>datastream equitites</strong> database, as well as the <strong>company fundamanetals characteristics</strong> through the <strong>worldscope</strong> database. Note that, to show you how to retrieve the data in multiple ways, we decided to retrieve the data on stock characteristics manually while using the function to retrieve the data on company fundamentals. The exact composition of the services of Datastream worldscope as well as the respective names <a href="https://wrds-www.wharton.upenn.edu/data-dictionary/tr_worldscope/">can be found on the WRDS homepage</a>, whereas you can find the compositon of the services of Datastream equities <a href="https://wrds-www.wharton.upenn.edu/data-dictionary/tr_ds_equities/">here</a>. For our use, we will need the <strong>Daily Stock File</strong> (wrds_ds2dsf) from the equities database as well as the <strong>Fundamentals Annually</strong> (wrds_ws_funda) as well as the <strong>Stock Data</strong> (wrds_ws_stock) tables of the worldscope database.</p>
<p>The variables that we retrieve from the equities database are given below:</p>
<ul>
<li>adjclose: Adjusted Close price (Used for: MOM)</li>
<li>close: Unadjusted Close price (Used for: SMB, HML)</li>
<li>volume: Volume of traded shares</li>
<li>numshrs: Number of shares outstanding (Used for: SMB, HML)</li>
</ul>
<p>Further, we need some identifiers to assure that we only take the Swiss companies under consideration:</p>
<ul>
<li>dscode: Code identifier for the stocks of TR</li>
<li>marketdate: Date of the observation</li>
<li>currency: Currency the company is traded in</li>
<li>region: Region of company’s main location</li>
<li>isin: ISIN number</li>
<li>ticker: Ticker</li>
<li>dslocalcode: Local code (combination of ISIN and Ticker based on TR)</li>
</ul>
<p>While the names for the equities database are quite straight-forward to interpret, the variable names of the worldscope database are presented in “items”, whereas each item is associated with a different accounting number. These are indicated below:</p>
<ul>
<li><p>item3501: Common Equity (= Book Value. Used for: HML, RMW. From wrds_ws_funda)</p></li>
<li><p>item2999: Total Assets (Used for: HML, CMA. From: wrds_ws_funda)</p></li>
<li><p>item3351: Total Liabilities (Used for: HML. From: wrds_ws_funda)</p></li>
<li><p>item1001: Net Sales or Revenues (Used for: RMW. From: wrds_ws_funda)</p></li>
<li><p>item1051: COGS excl depreciation (Used for: RMW. From: wrds_ws_funda)</p></li>
<li><p>item1101: SGA (Used for: RMW, From wrds_ws_funda)</p></li>
<li><p>item1100: Gross Income</p></li>
<li><p>item1249: Operating Expenses</p></li>
<li><p>item1251: Interest Expense on Debt</p></li>
</ul>
<p>Moreover, we need data on the date and sequence codes</p>
<ul>
<li>year_: Year of observation</li>
<li>seq: Sequential code</li>
<li>code: Company code from TR</li>
<li>item5350: Fiscal Period End date (Used to identify at which date the company had its annual closing. Based on this date, the 12 previous periods will obtain the same accouting numbers when upsampling from annual to monthly observations - e.g. if a company has its reported closing on the 31st of March, then the respective accounting number must be replicated for the subsequent 12 periods in order to base portfolios on the characteristic).</li>
</ul>
<p>Further, we need to define for which companies we require the data at hand. As it was with the data in CRSP and Compustat, we can enter a search query by providing security information based on (I) Stock Ticker (II) ISIN Number (III) CUSIP Number (IV) IBES identifier. However, we always advise you to use CUSIP numbers whenever possible, as these are the truly unique identifiers that can be used to source multiple databases at once. In our case, these are the following items:</p>
<ul>
<li>item5601: Ticker Symbol</li>
<li>item6008: ISIN</li>
<li>item6004: CUSIP</li>
<li>item6038: IBES</li>
</ul>
<p>For the use case here, we have a comprehensive ticker dataset with the companies that we previously used for earlier exercises. We will use this as identifier for our securities.</p>
<div id="fetch-the-swiss-data-for-stock-characteristics-through-datastream-equitites" class="section level4" number="8.5.3.1">
<h4><span class="header-section-number">8.5.3.1</span> Fetch the Swiss Data for Stock Characteristics through datastream equitites</h4>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb482-1"><a href="factor-models.html#cb482-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the stock market data (shares outstanding, adjusted and unadjusted stock prices, volume of trades)</span></span>
<span id="cb482-2"><a href="factor-models.html#cb482-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(wrds, <span class="st">&quot;select  a.dscode, a.marketdate,a.adjclose,a.close,a.volume, a.numshrs, a.ri, a.currency, a.region,</span></span>
<span id="cb482-3"><a href="factor-models.html#cb482-3" aria-hidden="true" tabindex="-1"></a><span class="st">                          b.isin, b.ticker, b.dslocalcode</span></span>
<span id="cb482-4"><a href="factor-models.html#cb482-4" aria-hidden="true" tabindex="-1"></a><span class="st">                          from  tr_ds_equities.wrds_ds2dsf a  </span></span>
<span id="cb482-5"><a href="factor-models.html#cb482-5" aria-hidden="true" tabindex="-1"></a><span class="st">                          left join tr_ds_equities.wrds_ds_names b</span></span>
<span id="cb482-6"><a href="factor-models.html#cb482-6" aria-hidden="true" tabindex="-1"></a><span class="st">                          on a.dscode = b.dscode </span></span>
<span id="cb482-7"><a href="factor-models.html#cb482-7" aria-hidden="true" tabindex="-1"></a><span class="st">                          where a.marketdate BETWEEN &#39;1990-01-01&#39; and &#39;2021-12-31&#39; AND a.region = &#39;CH&#39;&quot;</span>)</span>
<span id="cb482-8"><a href="factor-models.html#cb482-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-9"><a href="factor-models.html#cb482-9" aria-hidden="true" tabindex="-1"></a>data_2 <span class="ot">&lt;-</span> <span class="fu">dbFetch</span>(res)</span>
<span id="cb482-10"><a href="factor-models.html#cb482-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-11"><a href="factor-models.html#cb482-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the ISIN into two parts</span></span>
<span id="cb482-12"><a href="factor-models.html#cb482-12" aria-hidden="true" tabindex="-1"></a><span class="co"># This is done to identify Swiss companies with the characteristic &quot;CH&quot; in front of the ISIN number</span></span>
<span id="cb482-13"><a href="factor-models.html#cb482-13" aria-hidden="true" tabindex="-1"></a>CH_data <span class="ot">&lt;-</span> data_2 <span class="sc">%&gt;%</span> </span>
<span id="cb482-14"><a href="factor-models.html#cb482-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">country =</span> <span class="fu">substr</span>(data_2<span class="sc">$</span>isin,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb482-15"><a href="factor-models.html#cb482-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(country <span class="sc">==</span> <span class="st">&quot;CH&quot;</span> <span class="sc">&amp;</span> currency <span class="sc">==</span> <span class="st">&quot;CHF&quot;</span>) </span>
<span id="cb482-16"><a href="factor-models.html#cb482-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-17"><a href="factor-models.html#cb482-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the calender week</span></span>
<span id="cb482-18"><a href="factor-models.html#cb482-18" aria-hidden="true" tabindex="-1"></a>CH_data <span class="ot">&lt;-</span> CH_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Cal_Week =</span> lubridate<span class="sc">::</span><span class="fu">week</span>(marketdate))</span>
<span id="cb482-19"><a href="factor-models.html#cb482-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-20"><a href="factor-models.html#cb482-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand the date</span></span>
<span id="cb482-21"><a href="factor-models.html#cb482-21" aria-hidden="true" tabindex="-1"></a>CH_data_stock <span class="ot">&lt;-</span> <span class="fu">separate</span>(CH_data, <span class="st">&quot;marketdate&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Day&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;-&quot;</span>)</span>
<span id="cb482-22"><a href="factor-models.html#cb482-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-23"><a href="factor-models.html#cb482-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete duplicated rows</span></span>
<span id="cb482-24"><a href="factor-models.html#cb482-24" aria-hidden="true" tabindex="-1"></a>CH_data_stock <span class="ot">&lt;-</span> CH_data_stock[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_stock[<span class="fu">c</span>(<span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Month&quot;</span>, <span class="st">&quot;Day&quot;</span>, <span class="st">&#39;ticker&#39;</span>, <span class="st">&#39;dscode&#39;</span>)]),]</span>
<span id="cb482-25"><a href="factor-models.html#cb482-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-26"><a href="factor-models.html#cb482-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly Data: Get only the last date of each month</span></span>
<span id="cb482-27"><a href="factor-models.html#cb482-27" aria-hidden="true" tabindex="-1"></a>CH_data_stock_monthly <span class="ot">&lt;-</span>  CH_data_stock <span class="sc">%&gt;%</span> </span>
<span id="cb482-28"><a href="factor-models.html#cb482-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by each year-month and company</span></span>
<span id="cb482-29"><a href="factor-models.html#cb482-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dscode, Year, Month) <span class="sc">%&gt;%</span> </span>
<span id="cb482-30"><a href="factor-models.html#cb482-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Only get the maximum day value (the last day of each month per company and year)</span></span>
<span id="cb482-31"><a href="factor-models.html#cb482-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Day <span class="sc">==</span> <span class="fu">max</span>(Day)) <span class="sc">%&gt;%</span> </span>
<span id="cb482-32"><a href="factor-models.html#cb482-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recreate the actual last day date</span></span>
<span id="cb482-33"><a href="factor-models.html#cb482-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_actual =</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(Year,Month,Day,<span class="at">sep=</span><span class="st">&quot;-&quot;</span>)),</span>
<span id="cb482-34"><a href="factor-models.html#cb482-34" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Since this is only the last observed date, we need to transform them into the last date of each month (e.g. if last observed day was 2000-06-28 we</span></span>
<span id="cb482-35"><a href="factor-models.html#cb482-35" aria-hidden="true" tabindex="-1"></a>         <span class="co"># need to transform this to 2000-06-30 to match the relationship afterwards)</span></span>
<span id="cb482-36"><a href="factor-models.html#cb482-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_t =</span> lubridate<span class="sc">::</span><span class="fu">ceiling_date</span>(Date_actual, <span class="st">&quot;month&quot;</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb482-37"><a href="factor-models.html#cb482-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb482-38"><a href="factor-models.html#cb482-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, ticker, isin, adjclose, close, numshrs)</span>
<span id="cb482-39"><a href="factor-models.html#cb482-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-40"><a href="factor-models.html#cb482-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Weekly Data: Get only the last date of each week (same logic as above, but this time with weeks and not months)</span></span>
<span id="cb482-41"><a href="factor-models.html#cb482-41" aria-hidden="true" tabindex="-1"></a>CH_data_stock_weekly <span class="ot">&lt;-</span> CH_data_stock <span class="sc">%&gt;%</span> </span>
<span id="cb482-42"><a href="factor-models.html#cb482-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dscode, Year, Month, Cal_Week) <span class="sc">%&gt;%</span> </span>
<span id="cb482-43"><a href="factor-models.html#cb482-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Day <span class="sc">==</span> <span class="fu">max</span>(Day)) <span class="sc">%&gt;%</span> </span>
<span id="cb482-44"><a href="factor-models.html#cb482-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(Year,Month,Day,<span class="at">sep=</span><span class="st">&quot;-&quot;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb482-45"><a href="factor-models.html#cb482-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb482-46"><a href="factor-models.html#cb482-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, ticker, isin, adjclose, close, numshrs)</span></code></pre></div>
</div>
<div id="fetch-the-swiss-data-for-company-fundamanetals-characteristics-through-worldscope" class="section level4" number="8.5.3.2">
<h4><span class="header-section-number">8.5.3.2</span> Fetch the Swiss data for company fundamanetals characteristics through worldscope</h4>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb483-1"><a href="factor-models.html#cb483-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, we define the ticker symbol</span></span>
<span id="cb483-2"><a href="factor-models.html#cb483-2" aria-hidden="true" tabindex="-1"></a>tic <span class="ot">&lt;-</span> <span class="fu">unique</span>(CH_data_stock_monthly<span class="sc">$</span>ticker)</span>
<span id="cb483-3"><a href="factor-models.html#cb483-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb483-4"><a href="factor-models.html#cb483-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Then, we define the variables to be retrieved</span></span>
<span id="cb483-5"><a href="factor-models.html#cb483-5" aria-hidden="true" tabindex="-1"></a>column_a <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&#39;year_&#39;</span>, <span class="st">&#39;seq&#39;</span>, <span class="st">&#39;code&#39;</span>, <span class="st">&#39;item5350&#39;</span>, <span class="co"># Date and sequence codes</span></span>
<span id="cb483-6"><a href="factor-models.html#cb483-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;item5601&quot;</span>, <span class="st">&quot;item6008&quot;</span>, <span class="st">&quot;item6004&quot;</span>, <span class="st">&quot;item6038&quot;</span>, <span class="co"># The identifiers</span></span>
<span id="cb483-7"><a href="factor-models.html#cb483-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;item3501&quot;</span>, <span class="st">&quot;item2999&quot;</span>, <span class="st">&quot;item3351&quot;</span>, <span class="co"># Common Equity, Total Assets, Total Liabs </span></span>
<span id="cb483-8"><a href="factor-models.html#cb483-8" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;item1001&quot;</span>, <span class="st">&quot;item1051&quot;</span>, <span class="st">&quot;item1101&quot;</span>, <span class="st">&quot;item1100&quot;</span>, <span class="st">&quot;item1249&quot;</span>, <span class="st">&quot;item1251&quot;</span>) <span class="co"># Total Revenue, COGS, SGA, Gross Income, Operating Exp, Interest Exp)</span></span>
<span id="cb483-9"><a href="factor-models.html#cb483-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb483-10"><a href="factor-models.html#cb483-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb483-11"><a href="factor-models.html#cb483-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This is to connect the both databases without duplicating their output in the end</span></span>
<span id="cb483-12"><a href="factor-models.html#cb483-12" aria-hidden="true" tabindex="-1"></a>column_sql <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&#39;year_&#39;</span>, <span class="st">&#39;seq&#39;</span>, <span class="st">&#39;code&#39;</span>)</span>
<span id="cb483-13"><a href="factor-models.html#cb483-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb483-14"><a href="factor-models.html#cb483-14" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the second database, used for the keys from the securities monthly list</span></span>
<span id="cb483-15"><a href="factor-models.html#cb483-15" aria-hidden="true" tabindex="-1"></a>column_b <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&#39;item8001&#39;</span>, <span class="st">&#39;item8004&#39;</span>) <span class="co"># Market Cap, Market Cap Public</span></span>
<span id="cb483-16"><a href="factor-models.html#cb483-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb483-17"><a href="factor-models.html#cb483-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the quarterly data on company financials</span></span>
<span id="cb483-18"><a href="factor-models.html#cb483-18" aria-hidden="true" tabindex="-1"></a>query <span class="ot">=</span> <span class="fu">query_sql</span>(<span class="at">dataset_a =</span> <span class="st">&quot;tr_worldscope.wrds_ws_funda&quot;</span>,</span>
<span id="cb483-19"><a href="factor-models.html#cb483-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dataset_b =</span> <span class="st">&quot;tr_worldscope.wrds_ws_stock&quot;</span>,</span>
<span id="cb483-20"><a href="factor-models.html#cb483-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">multi_function =</span> F,</span>
<span id="cb483-21"><a href="factor-models.html#cb483-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">reuters_ds =</span> T,</span>
<span id="cb483-22"><a href="factor-models.html#cb483-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">column_a =</span> column_a,</span>
<span id="cb483-23"><a href="factor-models.html#cb483-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">column_b =</span> column_b,</span>
<span id="cb483-24"><a href="factor-models.html#cb483-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">column_sql =</span> column_sql,</span>
<span id="cb483-25"><a href="factor-models.html#cb483-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gvkey =</span> gvkey,</span>
<span id="cb483-26"><a href="factor-models.html#cb483-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sic =</span> sic,</span>
<span id="cb483-27"><a href="factor-models.html#cb483-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tic =</span> tic,</span>
<span id="cb483-28"><a href="factor-models.html#cb483-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cusip =</span> cusip, </span>
<span id="cb483-29"><a href="factor-models.html#cb483-29" aria-hidden="true" tabindex="-1"></a>                  <span class="at">isin =</span> isin,</span>
<span id="cb483-30"><a href="factor-models.html#cb483-30" aria-hidden="true" tabindex="-1"></a>                  <span class="at">datafmt =</span> <span class="cn">NULL</span>, </span>
<span id="cb483-31"><a href="factor-models.html#cb483-31" aria-hidden="true" tabindex="-1"></a>                  <span class="at">consol =</span> <span class="st">&#39;C&#39;</span>, </span>
<span id="cb483-32"><a href="factor-models.html#cb483-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">indfmt =</span> <span class="st">&#39;INDL&#39;</span>,</span>
<span id="cb483-33"><a href="factor-models.html#cb483-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">start =</span> <span class="st">&#39;1990&#39;</span>,</span>
<span id="cb483-34"><a href="factor-models.html#cb483-34" aria-hidden="true" tabindex="-1"></a>                  <span class="at">end =</span> <span class="st">&#39;2022&#39;</span>) </span>
<span id="cb483-35"><a href="factor-models.html#cb483-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb483-36"><a href="factor-models.html#cb483-36" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(wrds, query)</span></code></pre></div>
<pre><code>## Warning in result_create(conn@ptr, statement, immediate): Closing open result set, cancelling previous query</code></pre>
<div class="sourceCode" id="cb485"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb485-1"><a href="factor-models.html#cb485-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">dbFetch</span>(res)</span>
<span id="cb485-2"><a href="factor-models.html#cb485-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-3"><a href="factor-models.html#cb485-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Year_t&#39;</span>, <span class="st">&#39;Seq&#39;</span>, <span class="st">&#39;Code&#39;</span>, <span class="st">&quot;Fiscal_Period_End_Date&quot;</span>,</span>
<span id="cb485-4"><a href="factor-models.html#cb485-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;ISIN&quot;</span>, <span class="st">&quot;CUSIP&quot;</span>, <span class="st">&quot;IBES&quot;</span>,</span>
<span id="cb485-5"><a href="factor-models.html#cb485-5" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Total_Eq_t&quot;</span>, <span class="st">&quot;Total_Assets_t&quot;</span>, <span class="st">&quot;Total_Liab_t&quot;</span>, </span>
<span id="cb485-6"><a href="factor-models.html#cb485-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Revenue_Tot_t&quot;</span>, <span class="st">&quot;COGS_t&quot;</span>, <span class="st">&quot;SGA_t&quot;</span>, <span class="st">&quot;Gross_Inc_t&quot;</span>, <span class="st">&quot;Operating_Exp_t&quot;</span>, <span class="st">&quot;Interest_Exp_t&quot;</span>)</span>
<span id="cb485-7"><a href="factor-models.html#cb485-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-8"><a href="factor-models.html#cb485-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the ISIN into two parts</span></span>
<span id="cb485-9"><a href="factor-models.html#cb485-9" aria-hidden="true" tabindex="-1"></a>CH_data_fund <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb485-10"><a href="factor-models.html#cb485-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">country =</span> <span class="fu">substr</span>(data<span class="sc">$</span>ISIN,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb485-11"><a href="factor-models.html#cb485-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(country <span class="sc">==</span> <span class="st">&quot;CH&quot;</span>) </span>
<span id="cb485-12"><a href="factor-models.html#cb485-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-13"><a href="factor-models.html#cb485-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove duplicated observations based on the Code and Year combination </span></span>
<span id="cb485-14"><a href="factor-models.html#cb485-14" aria-hidden="true" tabindex="-1"></a>CH_data_fund <span class="ot">&lt;-</span> CH_data_fund[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_fund[<span class="fu">c</span>(<span class="st">&#39;Year_t&#39;</span>, <span class="st">&#39;Code&#39;</span>)]),]</span>
<span id="cb485-15"><a href="factor-models.html#cb485-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-16"><a href="factor-models.html#cb485-16" aria-hidden="true" tabindex="-1"></a>CH_data_fund <span class="ot">&lt;-</span> <span class="fu">separate</span>(CH_data_fund, <span class="st">&quot;Fiscal_Period_End_Date&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;Year_Fiscal_Period_End&quot;</span>, <span class="st">&quot;Month_Fiscal_Period_End&quot;</span>, <span class="st">&quot;Day_Fiscal_Period_End&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;-&quot;</span>)</span>
<span id="cb485-17"><a href="factor-models.html#cb485-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-18"><a href="factor-models.html#cb485-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the monthly dataset </span></span>
<span id="cb485-19"><a href="factor-models.html#cb485-19" aria-hidden="true" tabindex="-1"></a>CH_data_fund_monthly <span class="ot">&lt;-</span> CH_data_fund <span class="sc">%&gt;%</span> </span>
<span id="cb485-20"><a href="factor-models.html#cb485-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Dupl_Dummy =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(Total_Assets_t) <span class="sc">|</span> <span class="sc">!</span><span class="fu">is.na</span>(Total_Liab_t), <span class="dv">1</span>, <span class="dv">0</span>))  <span class="sc">%&gt;%</span> </span>
<span id="cb485-21"><a href="factor-models.html#cb485-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Dupl_Dummy <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb485-22"><a href="factor-models.html#cb485-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year_t, Code) <span class="sc">%&gt;%</span> </span>
<span id="cb485-23"><a href="factor-models.html#cb485-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="fu">first</span>(<span class="dv">12</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb485-24"><a href="factor-models.html#cb485-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Expand the data from yearly to monthly while accounting for different fiscal period end dates </span></span>
<span id="cb485-25"><a href="factor-models.html#cb485-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Month_t =</span> <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;01&quot;</span>, </span>
<span id="cb485-26"><a href="factor-models.html#cb485-26" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">c</span>(<span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>), </span>
<span id="cb485-27"><a href="factor-models.html#cb485-27" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;03&quot;</span>, </span>
<span id="cb485-28"><a href="factor-models.html#cb485-28" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">c</span>(<span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>),</span>
<span id="cb485-29"><a href="factor-models.html#cb485-29" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;04&quot;</span>,</span>
<span id="cb485-30"><a href="factor-models.html#cb485-30" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">c</span>(<span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>),</span>
<span id="cb485-31"><a href="factor-models.html#cb485-31" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;05&quot;</span>,</span>
<span id="cb485-32"><a href="factor-models.html#cb485-32" aria-hidden="true" tabindex="-1"></a>                                               <span class="fu">c</span>(<span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>), </span>
<span id="cb485-33"><a href="factor-models.html#cb485-33" aria-hidden="true" tabindex="-1"></a>                                               <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;06&quot;</span>,</span>
<span id="cb485-34"><a href="factor-models.html#cb485-34" aria-hidden="true" tabindex="-1"></a>                                                      <span class="fu">c</span>(<span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>),</span>
<span id="cb485-35"><a href="factor-models.html#cb485-35" aria-hidden="true" tabindex="-1"></a>                                                      <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;07&quot;</span>, </span>
<span id="cb485-36"><a href="factor-models.html#cb485-36" aria-hidden="true" tabindex="-1"></a>                                                             <span class="fu">c</span>(<span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>),</span>
<span id="cb485-37"><a href="factor-models.html#cb485-37" aria-hidden="true" tabindex="-1"></a>                                                             <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;08&quot;</span>, </span>
<span id="cb485-38"><a href="factor-models.html#cb485-38" aria-hidden="true" tabindex="-1"></a>                                                                    <span class="fu">c</span>(<span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>), </span>
<span id="cb485-39"><a href="factor-models.html#cb485-39" aria-hidden="true" tabindex="-1"></a>                                                                    <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;09&quot;</span>, </span>
<span id="cb485-40"><a href="factor-models.html#cb485-40" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>),</span>
<span id="cb485-41"><a href="factor-models.html#cb485-41" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;10&quot;</span>, </span>
<span id="cb485-42"><a href="factor-models.html#cb485-42" aria-hidden="true" tabindex="-1"></a>                                                                                  <span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>), </span>
<span id="cb485-43"><a href="factor-models.html#cb485-43" aria-hidden="true" tabindex="-1"></a>                                                                                  <span class="fu">ifelse</span>(Month_Fiscal_Period_End <span class="sc">==</span> <span class="st">&quot;11&quot;</span>,</span>
<span id="cb485-44"><a href="factor-models.html#cb485-44" aria-hidden="true" tabindex="-1"></a>                                                                                         <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>),</span>
<span id="cb485-45"><a href="factor-models.html#cb485-45" aria-hidden="true" tabindex="-1"></a>                                                                                         <span class="fu">c</span>(<span class="dv">01</span>, <span class="dv">02</span>, <span class="dv">03</span>, <span class="dv">04</span>, <span class="dv">05</span>, <span class="dv">06</span>, <span class="dv">07</span>, <span class="dv">08</span>, <span class="dv">09</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>)</span>
<span id="cb485-46"><a href="factor-models.html#cb485-46" aria-hidden="true" tabindex="-1"></a>                                                                                         </span>
<span id="cb485-47"><a href="factor-models.html#cb485-47" aria-hidden="true" tabindex="-1"></a>                                                                                         ) </span>
<span id="cb485-48"><a href="factor-models.html#cb485-48" aria-hidden="true" tabindex="-1"></a>                                                                                  )</span>
<span id="cb485-49"><a href="factor-models.html#cb485-49" aria-hidden="true" tabindex="-1"></a>                                                                           )</span>
<span id="cb485-50"><a href="factor-models.html#cb485-50" aria-hidden="true" tabindex="-1"></a>                                                                    )</span>
<span id="cb485-51"><a href="factor-models.html#cb485-51" aria-hidden="true" tabindex="-1"></a>                                                             )</span>
<span id="cb485-52"><a href="factor-models.html#cb485-52" aria-hidden="true" tabindex="-1"></a>                                                      )</span>
<span id="cb485-53"><a href="factor-models.html#cb485-53" aria-hidden="true" tabindex="-1"></a>                                               )</span>
<span id="cb485-54"><a href="factor-models.html#cb485-54" aria-hidden="true" tabindex="-1"></a>                                        )</span>
<span id="cb485-55"><a href="factor-models.html#cb485-55" aria-hidden="true" tabindex="-1"></a>                                 )</span>
<span id="cb485-56"><a href="factor-models.html#cb485-56" aria-hidden="true" tabindex="-1"></a>                          ),</span>
<span id="cb485-57"><a href="factor-models.html#cb485-57" aria-hidden="true" tabindex="-1"></a>         <span class="at">Day_t =</span> <span class="fu">c</span>(<span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>, <span class="dv">01</span>), </span>
<span id="cb485-58"><a href="factor-models.html#cb485-58" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create for each month the starting period </span></span>
<span id="cb485-59"><a href="factor-models.html#cb485-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">Start_Date_t =</span> <span class="fu">as.Date</span>(<span class="fu">paste</span>(Year_t,Month_t,Day_t,<span class="at">sep=</span><span class="st">&quot;-&quot;</span>)),</span>
<span id="cb485-60"><a href="factor-models.html#cb485-60" aria-hidden="true" tabindex="-1"></a>         <span class="co"># And also the last day of the month -&gt; assign as Date column since we only work with last day of month values (They are the same anyways)</span></span>
<span id="cb485-61"><a href="factor-models.html#cb485-61" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_t =</span> lubridate<span class="sc">::</span><span class="fu">ceiling_date</span>(Start_Date_t, <span class="st">&quot;month&quot;</span>) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb485-62"><a href="factor-models.html#cb485-62" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb485-63"><a href="factor-models.html#cb485-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb485-64"><a href="factor-models.html#cb485-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select only the variables of interest</span></span>
<span id="cb485-65"><a href="factor-models.html#cb485-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, ISIN, Total_Assets_t, Total_Liab_t, Gross_Inc_t, Operating_Exp_t, Interest_Exp_t, Total_Eq_t)</span>
<span id="cb485-66"><a href="factor-models.html#cb485-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-67"><a href="factor-models.html#cb485-67" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CH_data_stock_monthly) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;ISIN&quot;</span>, <span class="st">&quot;Adj_Close&quot;</span>, <span class="st">&quot;Close&quot;</span>, <span class="st">&quot;Num_Shares&quot;</span>)</span></code></pre></div>
</div>
<div id="export-the-monthly-and-weekly-datasets" class="section level4" number="8.5.3.3">
<h4><span class="header-section-number">8.5.3.3</span> Export the monthly and weekly datasets</h4>
<div class="sourceCode" id="cb486"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb486-1"><a href="factor-models.html#cb486-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe which incorporates all data</span></span>
<span id="cb486-2"><a href="factor-models.html#cb486-2" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">left_join</span>(CH_data_stock_monthly, CH_data_fund_monthly, </span>
<span id="cb486-3"><a href="factor-models.html#cb486-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span> <span class="ot">=</span> <span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Date_t&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>))</span>
<span id="cb486-4"><a href="factor-models.html#cb486-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb486-5"><a href="factor-models.html#cb486-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(CH_data_total_monthly, <span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb486-6"><a href="factor-models.html#cb486-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb486-7"><a href="factor-models.html#cb486-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the weekly csv for stocks </span></span>
<span id="cb486-8"><a href="factor-models.html#cb486-8" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(CH_data_stock_weekly, <span class="st">&quot;~/Desktop/CH_data_stock_weekly.csv&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
</div>
<div id="portfolio-sorts-for-different-factors" class="section level3" number="8.5.4">
<h3><span class="header-section-number">8.5.4</span> Portfolio Sorts for different factors</h3>
<p>We first deploy the portfolio sorts strategy to determine the behaviour of percentile distributed portfolios based on the characteristic of interest. Therein, we will create decile portfolios which are sorted based on the factors of interest.</p>
<p>However, before we start, we need to clarify the following. Previously, we used a specific approach to construct factors. This approach is also known as <strong>wide format</strong> approach, because we use a wide formatted dataframe in order to calculate the factor returns. Remember that a wide formatted dataframe means that each column shows the data of one specific characteristic for one specific company. Thus, if you have 300 companies for 10 years on a yearly basis, then the dataframe will have 300 columns and 10 rows. This implies that we need multiple dataframes to construct multiple factors.</p>
<p>The other method is called the <strong>long format</strong> approach. This is because we use a long formatted dataframe. As opposed to a wide formatted dataframe, long formats are constructed such that, in each column, we have a specific accounting number. In the other two columns, we then have the respective observational period as well as the company identifier for the respective accounting measure. For instance, if you have 3 specific measures (let’s say Total Equity, Net Income as well as Turnover) for 300 companies and 10 years, then you have a dataframe consisting of 5 columns and 3000 rows (300 companies à 10 years). This implies that we only need one dataframe to construct multiple factors.</p>
<p>We showed you the wide format approach previously because, although it appears to be computationally more complex, it actually shows all the specific steps we make when constructing factors. That is, you can trace pretty much each step back to its direct predecessor and thereby comprehend more easily how the code operates.</p>
<p>Despite this, we now introduce the long format approach. Although it does not document each operation directly, the main advantage is that it is computationally less expensive. As such, we can retrieve the results with less code and running time.</p>
<p>However, for one specific factor, the Jegadeesh Momentum factor, we still create the factors in both forms. This is to show you the main concepts in both ways. Especially, we want to highlight some differences in the sorting strategy that R follows which can potentially lead to slightly different results. In general, sorting is still a highly debated field with multiple different possibilities that statistics programs offer. When we use a pre-defined sorting function, we are likely to obtain different sorts compared to using a customised (own created) sorting procedure. Although this can lead to different results, it shows an additional, important caveat for scientific work. That is, we need to be clear and precise in formulating our assumptions even in more technical and less central areas of the work at hand.</p>
<div id="jegadeesh-and-titman-momentum-factor" class="section level4" number="8.5.4.1">
<h4><span class="header-section-number">8.5.4.1</span> Jegadeesh and Titman Momentum Factor</h4>
<p>This is the replication of the Jegadeesh and Titman Momentum factor. Therein, we will construct the factors in both a wide and long format to show you the differences that the choice of the sorting function can have on the final performance of our portfolios. Note that this is not the same Momentum factor as we will cover in the last assignment and, thus, it cannot be copied to calculate the momentum factor.</p>
<div id="wide-format-factor-construction" class="section level5" number="8.5.4.1.1">
<h5><span class="header-section-number">8.5.4.1.1</span> Wide-format factor construction</h5>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb487-1"><a href="factor-models.html#cb487-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb487-2"><a href="factor-models.html#cb487-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb487-3"><a href="factor-models.html#cb487-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb487-4"><a href="factor-models.html#cb487-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb487-5"><a href="factor-models.html#cb487-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a wide data frame</span></span>
<span id="cb487-6"><a href="factor-models.html#cb487-6" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb487-7"><a href="factor-models.html#cb487-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-8"><a href="factor-models.html#cb487-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb487-9"><a href="factor-models.html#cb487-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb487-10"><a href="factor-models.html#cb487-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close)</span>
<span id="cb487-11"><a href="factor-models.html#cb487-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-12"><a href="factor-models.html#cb487-12" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean_wide <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> <span class="fu">spread</span>(<span class="at">key =</span> Ticker, <span class="at">value =</span> Adj_Close)</span>
<span id="cb487-13"><a href="factor-models.html#cb487-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-14"><a href="factor-models.html#cb487-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time series object</span></span>
<span id="cb487-15"><a href="factor-models.html#cb487-15" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean_wide_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_total_monthly_clean_wide[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_total_monthly_clean_wide<span class="sc">$</span>Date_t))</span>
<span id="cb487-16"><a href="factor-models.html#cb487-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-17"><a href="factor-models.html#cb487-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Returns</span></span>
<span id="cb487-18"><a href="factor-models.html#cb487-18" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_wide_ret_ts <span class="ot">&lt;-</span> <span class="fu">Return.calculate</span>(CH_data_total_monthly_clean_wide_ts, <span class="st">&quot;discrete&quot;</span>)</span>
<span id="cb487-19"><a href="factor-models.html#cb487-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-20"><a href="factor-models.html#cb487-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Cut the 5% most extreme returns</span></span>
<span id="cb487-21"><a href="factor-models.html#cb487-21" aria-hidden="true" tabindex="-1"></a>extreme_cutoff <span class="ot">&lt;-</span> matrixStats<span class="sc">::</span><span class="fu">rowQuantiles</span>(<span class="fu">as.matrix</span>(CH_data_total_monthly_wide_ret_ts), <span class="at">probs =</span> <span class="fl">0.999</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb487-22"><a href="factor-models.html#cb487-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-23"><a href="factor-models.html#cb487-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-24"><a href="factor-models.html#cb487-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(CH_data_total_monthly_wide_ret_ts)){</span>
<span id="cb487-25"><a href="factor-models.html#cb487-25" aria-hidden="true" tabindex="-1"></a>  extreme <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(CH_data_total_monthly_wide_ret_ts[,i] <span class="sc">&lt;=</span> extreme_cutoff, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-26"><a href="factor-models.html#cb487-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb487-27"><a href="factor-models.html#cb487-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="st">&quot;ABBN&quot;</span>){</span>
<span id="cb487-28"><a href="factor-models.html#cb487-28" aria-hidden="true" tabindex="-1"></a>    extreme_final <span class="ot">&lt;-</span> extreme</span>
<span id="cb487-29"><a href="factor-models.html#cb487-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb487-30"><a href="factor-models.html#cb487-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb487-31"><a href="factor-models.html#cb487-31" aria-hidden="true" tabindex="-1"></a>    extreme_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(extreme_final, extreme)</span>
<span id="cb487-32"><a href="factor-models.html#cb487-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb487-33"><a href="factor-models.html#cb487-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb487-34"><a href="factor-models.html#cb487-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-35"><a href="factor-models.html#cb487-35" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_wide_ret_ts <span class="ot">&lt;-</span> CH_data_total_monthly_wide_ret_ts<span class="sc">*</span>extreme_final</span>
<span id="cb487-36"><a href="factor-models.html#cb487-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-37"><a href="factor-models.html#cb487-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Cumulative Returns</span></span>
<span id="cb487-38"><a href="factor-models.html#cb487-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(CH_data_total_monthly_wide_ret_ts)){</span>
<span id="cb487-39"><a href="factor-models.html#cb487-39" aria-hidden="true" tabindex="-1"></a>  col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(i)</span>
<span id="cb487-40"><a href="factor-models.html#cb487-40" aria-hidden="true" tabindex="-1"></a>  Log_Ret_Adj <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span>CH_data_total_monthly_wide_ret_ts[,i])</span>
<span id="cb487-41"><a href="factor-models.html#cb487-41" aria-hidden="true" tabindex="-1"></a>  Sum_Ret <span class="ot">=</span> <span class="fu">roll_sum</span>(Log_Ret_Adj, <span class="dv">6</span>)</span>
<span id="cb487-42"><a href="factor-models.html#cb487-42" aria-hidden="true" tabindex="-1"></a>  Cum_Ret <span class="ot">=</span> <span class="fu">exp</span>(Sum_Ret) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb487-43"><a href="factor-models.html#cb487-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb487-44"><a href="factor-models.html#cb487-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="st">&quot;ABBN&quot;</span>){</span>
<span id="cb487-45"><a href="factor-models.html#cb487-45" aria-hidden="true" tabindex="-1"></a>    Cum_Ret_final <span class="ot">&lt;-</span> Cum_Ret</span>
<span id="cb487-46"><a href="factor-models.html#cb487-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb487-47"><a href="factor-models.html#cb487-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb487-48"><a href="factor-models.html#cb487-48" aria-hidden="true" tabindex="-1"></a>    Cum_Ret_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Cum_Ret_final, Cum_Ret)</span>
<span id="cb487-49"><a href="factor-models.html#cb487-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb487-50"><a href="factor-models.html#cb487-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb487-51"><a href="factor-models.html#cb487-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-52"><a href="factor-models.html#cb487-52" aria-hidden="true" tabindex="-1"></a>one_to_ten <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">1</span>)</span>
<span id="cb487-53"><a href="factor-models.html#cb487-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-54"><a href="factor-models.html#cb487-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> one_to_ten){</span>
<span id="cb487-55"><a href="factor-models.html#cb487-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assign</span>(<span class="fu">paste0</span>(<span class="st">&quot;Momentum_d&quot;</span>, i), matrixStats<span class="sc">::</span><span class="fu">rowQuantiles</span>(<span class="fu">as.matrix</span>(Cum_Ret_final), <span class="at">probs =</span> i<span class="sc">/</span><span class="dv">10</span>, <span class="at">na.rm =</span> T))</span>
<span id="cb487-56"><a href="factor-models.html#cb487-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb487-57"><a href="factor-models.html#cb487-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-58"><a href="factor-models.html#cb487-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(Cum_Ret_final)) {</span>
<span id="cb487-59"><a href="factor-models.html#cb487-59" aria-hidden="true" tabindex="-1"></a>  col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(i)</span>
<span id="cb487-60"><a href="factor-models.html#cb487-60" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d1 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d1, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-61"><a href="factor-models.html#cb487-61" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d2 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d1 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d2, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-62"><a href="factor-models.html#cb487-62" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d3 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d2 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d3, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-63"><a href="factor-models.html#cb487-63" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d4 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d3 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d4, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-64"><a href="factor-models.html#cb487-64" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d5 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d4 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d5, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-65"><a href="factor-models.html#cb487-65" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d6 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d5 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d6, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-66"><a href="factor-models.html#cb487-66" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d7 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d6 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d7, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-67"><a href="factor-models.html#cb487-67" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d8 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d7 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d8, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-68"><a href="factor-models.html#cb487-68" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d9 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d8 <span class="sc">&amp;</span> Cum_Ret_final[,i] <span class="sc">&lt;=</span> Momentum_d9, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-69"><a href="factor-models.html#cb487-69" aria-hidden="true" tabindex="-1"></a>  Momentum_indicator_d10 <span class="ot">=</span> <span class="fu">ifelse</span>(Cum_Ret_final[,i] <span class="sc">&gt;</span> Momentum_d9, <span class="dv">1</span>, <span class="cn">NA</span>)</span>
<span id="cb487-70"><a href="factor-models.html#cb487-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb487-71"><a href="factor-models.html#cb487-71" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d1 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d1, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-72"><a href="factor-models.html#cb487-72" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d2 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d2, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-73"><a href="factor-models.html#cb487-73" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d3 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d3, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-74"><a href="factor-models.html#cb487-74" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d4 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d4, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-75"><a href="factor-models.html#cb487-75" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d5 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d5, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-76"><a href="factor-models.html#cb487-76" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d6 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d6, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-77"><a href="factor-models.html#cb487-77" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d7 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d7, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-78"><a href="factor-models.html#cb487-78" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d8 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d8, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-79"><a href="factor-models.html#cb487-79" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d9 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d9, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-80"><a href="factor-models.html#cb487-80" aria-hidden="true" tabindex="-1"></a>  Return_Mom_d10 <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lag</span>(Momentum_indicator_d10, <span class="at">n=</span><span class="dv">1</span>) <span class="sc">*</span> CH_data_total_monthly_wide_ret_ts[<span class="st">&#39;1990-01-31/2021-12-31&#39;</span>, i]</span>
<span id="cb487-81"><a href="factor-models.html#cb487-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb487-82"><a href="factor-models.html#cb487-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="st">&quot;ABBN&quot;</span>){</span>
<span id="cb487-83"><a href="factor-models.html#cb487-83" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d1_final <span class="ot">&lt;-</span> Return_Mom_d1</span>
<span id="cb487-84"><a href="factor-models.html#cb487-84" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d2_final <span class="ot">&lt;-</span> Return_Mom_d2</span>
<span id="cb487-85"><a href="factor-models.html#cb487-85" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d3_final <span class="ot">&lt;-</span> Return_Mom_d3</span>
<span id="cb487-86"><a href="factor-models.html#cb487-86" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d4_final <span class="ot">&lt;-</span> Return_Mom_d4</span>
<span id="cb487-87"><a href="factor-models.html#cb487-87" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d5_final <span class="ot">&lt;-</span> Return_Mom_d5</span>
<span id="cb487-88"><a href="factor-models.html#cb487-88" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d6_final <span class="ot">&lt;-</span> Return_Mom_d6</span>
<span id="cb487-89"><a href="factor-models.html#cb487-89" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d7_final <span class="ot">&lt;-</span> Return_Mom_d7</span>
<span id="cb487-90"><a href="factor-models.html#cb487-90" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d8_final <span class="ot">&lt;-</span> Return_Mom_d8</span>
<span id="cb487-91"><a href="factor-models.html#cb487-91" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d9_final <span class="ot">&lt;-</span> Return_Mom_d9</span>
<span id="cb487-92"><a href="factor-models.html#cb487-92" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d10_final <span class="ot">&lt;-</span> Return_Mom_d10</span>
<span id="cb487-93"><a href="factor-models.html#cb487-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb487-94"><a href="factor-models.html#cb487-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb487-95"><a href="factor-models.html#cb487-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb487-96"><a href="factor-models.html#cb487-96" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d1_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d1_final, Return_Mom_d1)</span>
<span id="cb487-97"><a href="factor-models.html#cb487-97" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d2_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d2_final, Return_Mom_d2)</span>
<span id="cb487-98"><a href="factor-models.html#cb487-98" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d3_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d3_final, Return_Mom_d3)</span>
<span id="cb487-99"><a href="factor-models.html#cb487-99" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d4_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d4_final, Return_Mom_d4)</span>
<span id="cb487-100"><a href="factor-models.html#cb487-100" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d5_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d5_final, Return_Mom_d5)</span>
<span id="cb487-101"><a href="factor-models.html#cb487-101" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d6_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d6_final, Return_Mom_d6)</span>
<span id="cb487-102"><a href="factor-models.html#cb487-102" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d7_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d7_final, Return_Mom_d7)</span>
<span id="cb487-103"><a href="factor-models.html#cb487-103" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d8_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d8_final, Return_Mom_d8)</span>
<span id="cb487-104"><a href="factor-models.html#cb487-104" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d9_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d9_final, Return_Mom_d9)</span>
<span id="cb487-105"><a href="factor-models.html#cb487-105" aria-hidden="true" tabindex="-1"></a>    Return_Mom_d10_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Return_Mom_d10_final, Return_Mom_d10)</span>
<span id="cb487-106"><a href="factor-models.html#cb487-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb487-107"><a href="factor-models.html#cb487-107" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb487-108"><a href="factor-models.html#cb487-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-109"><a href="factor-models.html#cb487-109" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d1 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d1_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d1_final)[<span class="dv">1</span>]]</span>
<span id="cb487-110"><a href="factor-models.html#cb487-110" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d2 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d2_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d2_final)[<span class="dv">1</span>]]</span>
<span id="cb487-111"><a href="factor-models.html#cb487-111" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d3 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d3_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d3_final)[<span class="dv">1</span>]]</span>
<span id="cb487-112"><a href="factor-models.html#cb487-112" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d4 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d4_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d4_final)[<span class="dv">1</span>]]</span>
<span id="cb487-113"><a href="factor-models.html#cb487-113" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d5 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d5_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d5_final)[<span class="dv">1</span>]]</span>
<span id="cb487-114"><a href="factor-models.html#cb487-114" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d6 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d6_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d6_final)[<span class="dv">1</span>]]</span>
<span id="cb487-115"><a href="factor-models.html#cb487-115" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d7 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d7_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d7_final)[<span class="dv">1</span>]]</span>
<span id="cb487-116"><a href="factor-models.html#cb487-116" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d8 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d8_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d8_final)[<span class="dv">1</span>]]</span>
<span id="cb487-117"><a href="factor-models.html#cb487-117" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d9 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d9_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d9_final)[<span class="dv">1</span>]]</span>
<span id="cb487-118"><a href="factor-models.html#cb487-118" aria-hidden="true" tabindex="-1"></a>EW_Return_Mom_d10 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(Return_Mom_d10_final, <span class="at">na.rm =</span> T)[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d10_final)[<span class="dv">1</span>]]</span>
<span id="cb487-119"><a href="factor-models.html#cb487-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-120"><a href="factor-models.html#cb487-120" aria-hidden="true" tabindex="-1"></a>Dates <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(CH_data_total_monthly_clean_wide<span class="sc">$</span>Date_t[<span class="dv">8</span><span class="sc">:</span><span class="fu">dim</span>(Return_Mom_d1_final)[<span class="dv">1</span>]])</span>
<span id="cb487-121"><a href="factor-models.html#cb487-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-122"><a href="factor-models.html#cb487-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-123"><a href="factor-models.html#cb487-123" aria-hidden="true" tabindex="-1"></a>df_mom <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Dates, <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d1), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d2), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d3), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d4),</span>
<span id="cb487-124"><a href="factor-models.html#cb487-124" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d5), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d6), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d7), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d8),</span>
<span id="cb487-125"><a href="factor-models.html#cb487-125" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d9), <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Return_Mom_d10)))</span>
<span id="cb487-126"><a href="factor-models.html#cb487-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-127"><a href="factor-models.html#cb487-127" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_mom) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date&quot;</span>, <span class="st">&quot;Decile 1&quot;</span>, <span class="st">&quot;Decile 2&quot;</span>, <span class="st">&quot;Decile 3&quot;</span>, <span class="st">&quot;Decile 4&quot;</span>, <span class="st">&quot;Decile 5&quot;</span>, <span class="st">&quot;Decile 6&quot;</span>, <span class="st">&quot;Decile 7&quot;</span>, <span class="st">&quot;Decile 8&quot;</span>, <span class="st">&quot;Decile 9&quot;</span>, <span class="st">&quot;Decile 10&quot;</span>)</span>
<span id="cb487-128"><a href="factor-models.html#cb487-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-129"><a href="factor-models.html#cb487-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform into long format</span></span>
<span id="cb487-130"><a href="factor-models.html#cb487-130" aria-hidden="true" tabindex="-1"></a>df_mom_long <span class="ot">&lt;-</span> df_mom <span class="sc">%&gt;%</span> </span>
<span id="cb487-131"><a href="factor-models.html#cb487-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.Date</span>(Date)) <span class="sc">%&gt;%</span> </span>
<span id="cb487-132"><a href="factor-models.html#cb487-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(Decile, value, <span class="sc">-</span><span class="fu">c</span>(Date))</span>
<span id="cb487-133"><a href="factor-models.html#cb487-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-134"><a href="factor-models.html#cb487-134" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_mom_long) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Decile&quot;</span>, <span class="st">&quot;cum_ret&quot;</span>)</span>
<span id="cb487-135"><a href="factor-models.html#cb487-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-136"><a href="factor-models.html#cb487-136" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret_long <span class="ot">&lt;-</span> df_mom_long <span class="sc">%&gt;%</span> </span>
<span id="cb487-137"><a href="factor-models.html#cb487-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.factor</span>(Decile)) <span class="sc">%&gt;%</span> </span>
<span id="cb487-138"><a href="factor-models.html#cb487-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t))</span>
<span id="cb487-139"><a href="factor-models.html#cb487-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-140"><a href="factor-models.html#cb487-140" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret_long <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>( <span class="at">x =</span> Date_t , <span class="at">y =</span> cum_ret , <span class="at">color =</span> Decile), <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span> </span>
<span id="cb487-141"><a href="factor-models.html#cb487-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_color_manual(values=c(&quot;tomato3&quot;, &quot;khaki3&quot;, &quot;lightsteelblue3&quot;, &quot;dodgerblue4&quot;, &quot;violetred4&quot;, &quot;black&quot;)) +</span></span>
<span id="cb487-142"><a href="factor-models.html#cb487-142" aria-hidden="true" tabindex="-1"></a><span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Jegadeesh Titman Momentum Strategy with wide formatted dataset&quot;</span>) <span class="sc">+</span></span>
<span id="cb487-143"><a href="factor-models.html#cb487-143" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb487-144"><a href="factor-models.html#cb487-144" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb487-145"><a href="factor-models.html#cb487-145" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb487-146"><a href="factor-models.html#cb487-146" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb487-147"><a href="factor-models.html#cb487-147" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb487-148"><a href="factor-models.html#cb487-148" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb487-149"><a href="factor-models.html#cb487-149" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb487-150"><a href="factor-models.html#cb487-150" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb487-151"><a href="factor-models.html#cb487-151" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-272-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb488-1"><a href="factor-models.html#cb488-1" aria-hidden="true" tabindex="-1"></a>df_mom <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Dates, EW_Return_Mom_d1, EW_Return_Mom_d2, EW_Return_Mom_d3, EW_Return_Mom_d4,</span>
<span id="cb488-2"><a href="factor-models.html#cb488-2" aria-hidden="true" tabindex="-1"></a>                              EW_Return_Mom_d5, EW_Return_Mom_d6, EW_Return_Mom_d7, EW_Return_Mom_d8, EW_Return_Mom_d9, EW_Return_Mom_d10))</span>
<span id="cb488-3"><a href="factor-models.html#cb488-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb488-4"><a href="factor-models.html#cb488-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_mom) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date&quot;</span>, <span class="st">&quot;Decile 1&quot;</span>, <span class="st">&quot;Decile 2&quot;</span>, <span class="st">&quot;Decile 3&quot;</span>, <span class="st">&quot;Decile 4&quot;</span>, <span class="st">&quot;Decile 5&quot;</span>, <span class="st">&quot;Decile 6&quot;</span>, <span class="st">&quot;Decile 7&quot;</span>, <span class="st">&quot;Decile 8&quot;</span>, <span class="st">&quot;Decile 9&quot;</span>, <span class="st">&quot;Decile 10&quot;</span>)</span>
<span id="cb488-5"><a href="factor-models.html#cb488-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb488-6"><a href="factor-models.html#cb488-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform into long format</span></span>
<span id="cb488-7"><a href="factor-models.html#cb488-7" aria-hidden="true" tabindex="-1"></a>df_mom_long <span class="ot">&lt;-</span> df_mom <span class="sc">%&gt;%</span> </span>
<span id="cb488-8"><a href="factor-models.html#cb488-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.Date</span>(Date)) <span class="sc">%&gt;%</span> </span>
<span id="cb488-9"><a href="factor-models.html#cb488-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(Decile, value, <span class="sc">-</span><span class="fu">c</span>(Date))</span>
<span id="cb488-10"><a href="factor-models.html#cb488-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb488-11"><a href="factor-models.html#cb488-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_mom_long) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Decile&quot;</span>, <span class="st">&quot;EW_Ret_mean_t&quot;</span>)</span>
<span id="cb488-12"><a href="factor-models.html#cb488-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb488-13"><a href="factor-models.html#cb488-13" aria-hidden="true" tabindex="-1"></a>df_mom_long <span class="sc">%&gt;%</span> </span>
<span id="cb488-14"><a href="factor-models.html#cb488-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Decile <span class="sc">!=</span> <span class="st">&quot;NA&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb488-15"><a href="factor-models.html#cb488-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb488-16"><a href="factor-models.html#cb488-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Annualised_Mean_Return =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">+</span><span class="fu">mean</span>(EW_Ret_mean_t))<span class="sc">^</span><span class="dv">12</span> <span class="sc">-</span><span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb488-17"><a href="factor-models.html#cb488-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">Annualised_SD =</span> <span class="fu">round</span>(<span class="fu">sd</span>(EW_Ret_mean_t)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>), <span class="dv">5</span>),</span>
<span id="cb488-18"><a href="factor-models.html#cb488-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sharpe_Ratio =</span> <span class="fu">round</span>(Annualised_Mean_Return<span class="sc">/</span>Annualised_SD,<span class="dv">5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb488-19"><a href="factor-models.html#cb488-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Decile, Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb488-20"><a href="factor-models.html#cb488-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
## # Groups:   Decile [10]
##    Decile    Annualised_Mean_Return Annualised_SD Sharpe_Ratio
##    &lt;chr&gt;                      &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
##  1 Decile 1                 -0.0997         0.283      -0.352 
##  2 Decile 2                  0.0111         0.202       0.0549
##  3 Decile 3                  0.0119         0.188       0.0635
##  4 Decile 4                  0.0720         0.177       0.407 
##  5 Decile 5                  0.0670         0.158       0.423 
##  6 Decile 6                  0.0824         0.150       0.548 
##  7 Decile 7                  0.0850         0.146       0.581 
##  8 Decile 8                  0.124          0.150       0.824 
##  9 Decile 9                  0.129          0.156       0.828 
## 10 Decile 10                 0.172          0.179       0.962</code></pre>
</div>
<div id="long-format-factor-construction" class="section level5" number="8.5.4.1.2">
<h5><span class="header-section-number">8.5.4.1.2</span> Long-format factor construction</h5>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb490-1"><a href="factor-models.html#cb490-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb490-2"><a href="factor-models.html#cb490-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb490-3"><a href="factor-models.html#cb490-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb490-4"><a href="factor-models.html#cb490-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb490-5"><a href="factor-models.html#cb490-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb490-6"><a href="factor-models.html#cb490-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-7"><a href="factor-models.html#cb490-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb490-8"><a href="factor-models.html#cb490-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb490-9"><a href="factor-models.html#cb490-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb490-10"><a href="factor-models.html#cb490-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close) <span class="sc">%&gt;%</span> </span>
<span id="cb490-11"><a href="factor-models.html#cb490-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t), </span>
<span id="cb490-12"><a href="factor-models.html#cb490-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_t =</span> <span class="fu">as.yearmon</span>(Date_t)) </span>
<span id="cb490-13"><a href="factor-models.html#cb490-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-14"><a href="factor-models.html#cb490-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb490-15"><a href="factor-models.html#cb490-15" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb490-16"><a href="factor-models.html#cb490-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb490-17"><a href="factor-models.html#cb490-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close) <span class="sc">%&gt;%</span> </span>
<span id="cb490-18"><a href="factor-models.html#cb490-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb490-19"><a href="factor-models.html#cb490-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb490-20"><a href="factor-models.html#cb490-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb490-21"><a href="factor-models.html#cb490-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb490-22"><a href="factor-models.html#cb490-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb490-23"><a href="factor-models.html#cb490-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="fl">0.999</span>), </span>
<span id="cb490-24"><a href="factor-models.html#cb490-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb490-25"><a href="factor-models.html#cb490-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb490-26"><a href="factor-models.html#cb490-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb490-27"><a href="factor-models.html#cb490-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-28"><a href="factor-models.html#cb490-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the lagged values to ensure that we have a HPR of 6 periods! </span></span>
<span id="cb490-29"><a href="factor-models.html#cb490-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we go 6 periods behind and take the cum ret from period -6 to period -1 to obtain the HPR from period -5 to 0. </span></span>
<span id="cb490-30"><a href="factor-models.html#cb490-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-31"><a href="factor-models.html#cb490-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Idea: If we do it like this, we account for gaps in the data. E.g. if two observational periods were on Aug 1990 and then on Aug 1991, the gap would be 12 periods. Thus, this would not constitute a HPR of 6 periods, but 12. In order to ensure we only ever get HPR of 6 periods, we need to create the indicator which shows how many periods (in months) two dates are apart from one another. This must equal 6 and not more! </span></span>
<span id="cb490-32"><a href="factor-models.html#cb490-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-33"><a href="factor-models.html#cb490-33" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_lag <span class="ot">&lt;-</span> CH_data_total_monthly_sub <span class="sc">%&gt;%</span> </span>
<span id="cb490-34"><a href="factor-models.html#cb490-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb490-35"><a href="factor-models.html#cb490-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lag6 =</span> <span class="fu">round</span>(<span class="dv">12</span><span class="sc">*</span>(Date_t <span class="sc">-</span> <span class="fu">lag</span>(Date_t, <span class="at">n=</span><span class="dv">5</span>)))<span class="sc">/</span><span class="dv">5</span>)</span>
<span id="cb490-36"><a href="factor-models.html#cb490-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-37"><a href="factor-models.html#cb490-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the adjustred returns to form the PF on</span></span>
<span id="cb490-38"><a href="factor-models.html#cb490-38" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret <span class="ot">&lt;-</span> CH_data_total_monthly_sub_lag <span class="sc">%&gt;%</span> </span>
<span id="cb490-39"><a href="factor-models.html#cb490-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb490-40"><a href="factor-models.html#cb490-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Log_Ret_Adj =</span> <span class="fu">lag</span>(<span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span>Ret_Adj), <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb490-41"><a href="factor-models.html#cb490-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sum_Ret =</span> <span class="fu">roll_sum</span>(Log_Ret_Adj, <span class="dv">6</span>),</span>
<span id="cb490-42"><a href="factor-models.html#cb490-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">Cum_Ret =</span> <span class="fu">exp</span>(Sum_Ret) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb490-43"><a href="factor-models.html#cb490-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb490-44"><a href="factor-models.html#cb490-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb490-45"><a href="factor-models.html#cb490-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-46"><a href="factor-models.html#cb490-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rankings</span></span>
<span id="cb490-47"><a href="factor-models.html#cb490-47" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret <span class="sc">%&gt;%</span> </span>
<span id="cb490-48"><a href="factor-models.html#cb490-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.,  lag6 <span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb490-49"><a href="factor-models.html#cb490-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb490-50"><a href="factor-models.html#cb490-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb490-51"><a href="factor-models.html#cb490-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Cum_Ret, </span>
<span id="cb490-52"><a href="factor-models.html#cb490-52" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Cum_Ret, </span>
<span id="cb490-53"><a href="factor-models.html#cb490-53" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb490-54"><a href="factor-models.html#cb490-54" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb490-55"><a href="factor-models.html#cb490-55" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>),</span>
<span id="cb490-56"><a href="factor-models.html#cb490-56" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb490-57"><a href="factor-models.html#cb490-57" aria-hidden="true" tabindex="-1"></a>         <span class="at">p1 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.1</span>), </span>
<span id="cb490-58"><a href="factor-models.html#cb490-58" aria-hidden="true" tabindex="-1"></a>         <span class="at">p2 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.2</span>),</span>
<span id="cb490-59"><a href="factor-models.html#cb490-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">p3 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.3</span>),</span>
<span id="cb490-60"><a href="factor-models.html#cb490-60" aria-hidden="true" tabindex="-1"></a>         <span class="at">p4 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.4</span>),</span>
<span id="cb490-61"><a href="factor-models.html#cb490-61" aria-hidden="true" tabindex="-1"></a>         <span class="at">p5 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.5</span>),</span>
<span id="cb490-62"><a href="factor-models.html#cb490-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">p6 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.6</span>),</span>
<span id="cb490-63"><a href="factor-models.html#cb490-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">p7 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.7</span>),</span>
<span id="cb490-64"><a href="factor-models.html#cb490-64" aria-hidden="true" tabindex="-1"></a>         <span class="at">p8 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.8</span>),</span>
<span id="cb490-65"><a href="factor-models.html#cb490-65" aria-hidden="true" tabindex="-1"></a>         <span class="at">p9 =</span> <span class="fu">quantile</span>(Cum_Ret, <span class="fl">0.9</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb490-66"><a href="factor-models.html#cb490-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb490-67"><a href="factor-models.html#cb490-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-68"><a href="factor-models.html#cb490-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only certain columns</span></span>
<span id="cb490-69"><a href="factor-models.html#cb490-69" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_2_lag <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank <span class="sc">%&gt;%</span> </span>
<span id="cb490-70"><a href="factor-models.html#cb490-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Decile)</span>
<span id="cb490-71"><a href="factor-models.html#cb490-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-72"><a href="factor-models.html#cb490-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge two df</span></span>
<span id="cb490-73"><a href="factor-models.html#cb490-73" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_tot <span class="ot">&lt;-</span> CH_data_total_monthly_sub_lag <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb490-74"><a href="factor-models.html#cb490-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(., lag6 <span class="sc">==</span> <span class="dv">1</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb490-75"><a href="factor-models.html#cb490-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(CH_data_total_monthly_sub_rank_2_lag, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span><span class="ot">=</span><span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Date_t&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb490-76"><a href="factor-models.html#cb490-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Ticker,Date_t,Ret_Adj,Decile) <span class="sc">%&gt;%</span></span>
<span id="cb490-77"><a href="factor-models.html#cb490-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Ticker,Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb490-78"><a href="factor-models.html#cb490-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Date_t,Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb490-79"><a href="factor-models.html#cb490-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">momr =</span> <span class="fu">mean</span>(Ret_Adj)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb490-80"><a href="factor-models.html#cb490-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Decile,momr) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb490-81"><a href="factor-models.html#cb490-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-82"><a href="factor-models.html#cb490-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns</span></span>
<span id="cb490-83"><a href="factor-models.html#cb490-83" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_tot <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb490-84"><a href="factor-models.html#cb490-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t =</span> <span class="fu">mean</span>(momr, <span class="at">na.rm =</span> T), </span>
<span id="cb490-85"><a href="factor-models.html#cb490-85" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t =</span> <span class="fu">sd</span>(momr, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb490-86"><a href="factor-models.html#cb490-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Decile,EW_Ret_mean_t,EW_Ret_sd_t) <span class="sc">%&gt;%</span> </span>
<span id="cb490-87"><a href="factor-models.html#cb490-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb490-88"><a href="factor-models.html#cb490-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb490-89"><a href="factor-models.html#cb490-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Decile)</span>
<span id="cb490-90"><a href="factor-models.html#cb490-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-91"><a href="factor-models.html#cb490-91" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret <span class="ot">&lt;-</span> CH_data_EW_Ret <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb490-92"><a href="factor-models.html#cb490-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_ret =</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Ret_mean_t))</span>
<span id="cb490-93"><a href="factor-models.html#cb490-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-94"><a href="factor-models.html#cb490-94" aria-hidden="true" tabindex="-1"></a>ewretdat2 <span class="ot">&lt;-</span> CH_data_Cum_Ret <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.factor</span>(Decile)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t)) <span class="sc">%&gt;%</span> <span class="fu">subset</span>(<span class="sc">!</span><span class="fu">is.na</span>(cum_ret) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(Decile))</span>
<span id="cb490-95"><a href="factor-models.html#cb490-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-96"><a href="factor-models.html#cb490-96" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> ewretdat2) <span class="sc">+</span></span>
<span id="cb490-97"><a href="factor-models.html#cb490-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>Date_t ,<span class="at">y =</span> cum_ret ,<span class="at">color =</span> Decile), <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb490-98"><a href="factor-models.html#cb490-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Jegadeesh Titman Momentum Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb490-99"><a href="factor-models.html#cb490-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb490-100"><a href="factor-models.html#cb490-100" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb490-101"><a href="factor-models.html#cb490-101" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb490-102"><a href="factor-models.html#cb490-102" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb490-103"><a href="factor-models.html#cb490-103" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb490-104"><a href="factor-models.html#cb490-104" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb490-105"><a href="factor-models.html#cb490-105" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb490-106"><a href="factor-models.html#cb490-106" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb490-107"><a href="factor-models.html#cb490-107" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb490-108"><a href="factor-models.html#cb490-108" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-274-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb491"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb491-1"><a href="factor-models.html#cb491-1" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret <span class="sc">%&gt;%</span> </span>
<span id="cb491-2"><a href="factor-models.html#cb491-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Decile <span class="sc">!=</span> <span class="st">&quot;NA&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb491-3"><a href="factor-models.html#cb491-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb491-4"><a href="factor-models.html#cb491-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Annualised_Mean_Return =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">+</span><span class="fu">mean</span>(EW_Ret_mean_t))<span class="sc">^</span><span class="dv">12</span> <span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>),</span>
<span id="cb491-5"><a href="factor-models.html#cb491-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">Annualised_SD =</span> <span class="fu">round</span>(<span class="fu">sd</span>(EW_Ret_mean_t)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>), <span class="dv">5</span>),</span>
<span id="cb491-6"><a href="factor-models.html#cb491-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sharpe_Ratio =</span> <span class="fu">round</span>(Annualised_Mean_Return<span class="sc">/</span>Annualised_SD,<span class="dv">5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb491-7"><a href="factor-models.html#cb491-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Decile, Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb491-8"><a href="factor-models.html#cb491-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
## # Groups:   Decile [10]
##    Decile Annualised_Mean_Return Annualised_SD Sharpe_Ratio
##     &lt;dbl&gt;                  &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
##  1      1               -0.103           0.287      -0.359 
##  2      2                0.0137          0.199       0.0685
##  3      3                0.00573         0.189       0.0304
##  4      4                0.0742          0.178       0.416 
##  5      5                0.0638          0.157       0.406 
##  6      6                0.0826          0.149       0.553 
##  7      7                0.0858          0.143       0.600 
##  8      8                0.122           0.149       0.817 
##  9      9                0.129           0.153       0.843 
## 10     10                0.177           0.177       0.999</code></pre>
</div>
</div>
<div id="the-size-factor" class="section level4" number="8.5.4.2">
<h4><span class="header-section-number">8.5.4.2</span> The Size Factor</h4>
<p>This is the long-format construction of the size factor based on the data downloaded.</p>
<div class="sourceCode" id="cb493"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb493-1"><a href="factor-models.html#cb493-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb493-2"><a href="factor-models.html#cb493-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb493-3"><a href="factor-models.html#cb493-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb493-4"><a href="factor-models.html#cb493-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb493-5"><a href="factor-models.html#cb493-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb493-6"><a href="factor-models.html#cb493-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-7"><a href="factor-models.html#cb493-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb493-8"><a href="factor-models.html#cb493-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb493-9"><a href="factor-models.html#cb493-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb493-10"><a href="factor-models.html#cb493-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Close, Num_Shares)</span>
<span id="cb493-11"><a href="factor-models.html#cb493-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-12"><a href="factor-models.html#cb493-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb493-13"><a href="factor-models.html#cb493-13" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Size <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb493-14"><a href="factor-models.html#cb493-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb493-15"><a href="factor-models.html#cb493-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb493-16"><a href="factor-models.html#cb493-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb493-17"><a href="factor-models.html#cb493-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb493-18"><a href="factor-models.html#cb493-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb493-19"><a href="factor-models.html#cb493-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb493-20"><a href="factor-models.html#cb493-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="fl">0.999</span>), </span>
<span id="cb493-21"><a href="factor-models.html#cb493-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb493-22"><a href="factor-models.html#cb493-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb493-23"><a href="factor-models.html#cb493-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb493-24"><a href="factor-models.html#cb493-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-25"><a href="factor-models.html#cb493-25" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb493-26"><a href="factor-models.html#cb493-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb493-27"><a href="factor-models.html#cb493-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb493-28"><a href="factor-models.html#cb493-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb493-29"><a href="factor-models.html#cb493-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged) <span class="sc">%&gt;%</span> </span>
<span id="cb493-30"><a href="factor-models.html#cb493-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb493-31"><a href="factor-models.html#cb493-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb493-32"><a href="factor-models.html#cb493-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-33"><a href="factor-models.html#cb493-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rankings</span></span>
<span id="cb493-34"><a href="factor-models.html#cb493-34" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size <span class="sc">%&gt;%</span> </span>
<span id="cb493-35"><a href="factor-models.html#cb493-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb493-36"><a href="factor-models.html#cb493-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb493-37"><a href="factor-models.html#cb493-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb493-38"><a href="factor-models.html#cb493-38" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb493-39"><a href="factor-models.html#cb493-39" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb493-40"><a href="factor-models.html#cb493-40" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb493-41"><a href="factor-models.html#cb493-41" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>),</span>
<span id="cb493-42"><a href="factor-models.html#cb493-42" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb493-43"><a href="factor-models.html#cb493-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">p1 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.1</span>), </span>
<span id="cb493-44"><a href="factor-models.html#cb493-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">p2 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.2</span>),</span>
<span id="cb493-45"><a href="factor-models.html#cb493-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">p3 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.3</span>),</span>
<span id="cb493-46"><a href="factor-models.html#cb493-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">p4 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.4</span>),</span>
<span id="cb493-47"><a href="factor-models.html#cb493-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">p5 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.5</span>),</span>
<span id="cb493-48"><a href="factor-models.html#cb493-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">p6 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.6</span>),</span>
<span id="cb493-49"><a href="factor-models.html#cb493-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">p7 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.7</span>),</span>
<span id="cb493-50"><a href="factor-models.html#cb493-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">p8 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.8</span>),</span>
<span id="cb493-51"><a href="factor-models.html#cb493-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">p9 =</span> <span class="fu">quantile</span>(Market_Cap, <span class="fl">0.9</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb493-52"><a href="factor-models.html#cb493-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb493-53"><a href="factor-models.html#cb493-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-54"><a href="factor-models.html#cb493-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns</span></span>
<span id="cb493-55"><a href="factor-models.html#cb493-55" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb493-56"><a href="factor-models.html#cb493-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb493-57"><a href="factor-models.html#cb493-57" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb493-58"><a href="factor-models.html#cb493-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Decile,EW_Ret_mean_t,EW_Ret_sd_t) <span class="sc">%&gt;%</span> </span>
<span id="cb493-59"><a href="factor-models.html#cb493-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb493-60"><a href="factor-models.html#cb493-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb493-61"><a href="factor-models.html#cb493-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Decile)</span>
<span id="cb493-62"><a href="factor-models.html#cb493-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-63"><a href="factor-models.html#cb493-63" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret_Size <span class="ot">&lt;-</span> CH_data_EW_Ret_Size <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb493-64"><a href="factor-models.html#cb493-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_ret =</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Ret_mean_t))</span>
<span id="cb493-65"><a href="factor-models.html#cb493-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-66"><a href="factor-models.html#cb493-66" aria-hidden="true" tabindex="-1"></a>EW_Size <span class="ot">&lt;-</span> CH_data_Cum_Ret_Size <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.factor</span>(Decile)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t))</span>
<span id="cb493-67"><a href="factor-models.html#cb493-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-68"><a href="factor-models.html#cb493-68" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> EW_Size) <span class="sc">+</span></span>
<span id="cb493-69"><a href="factor-models.html#cb493-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>Date_t ,<span class="at">y =</span> cum_ret ,<span class="at">color =</span> Decile), <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb493-70"><a href="factor-models.html#cb493-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Size Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb493-71"><a href="factor-models.html#cb493-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb493-72"><a href="factor-models.html#cb493-72" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb493-73"><a href="factor-models.html#cb493-73" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb493-74"><a href="factor-models.html#cb493-74" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb493-75"><a href="factor-models.html#cb493-75" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb493-76"><a href="factor-models.html#cb493-76" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb493-77"><a href="factor-models.html#cb493-77" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb493-78"><a href="factor-models.html#cb493-78" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb493-79"><a href="factor-models.html#cb493-79" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb493-80"><a href="factor-models.html#cb493-80" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-276-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb494"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb494-1"><a href="factor-models.html#cb494-1" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size <span class="sc">%&gt;%</span> </span>
<span id="cb494-2"><a href="factor-models.html#cb494-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb494-3"><a href="factor-models.html#cb494-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Annualised_Mean_Return =</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">mean</span>(EW_Ret_mean_t))<span class="sc">^</span><span class="dv">12</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb494-4"><a href="factor-models.html#cb494-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">Annualised_SD =</span> <span class="fu">sd</span>(EW_Ret_mean_t)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>), </span>
<span id="cb494-5"><a href="factor-models.html#cb494-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sharpe_Ratio =</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD) <span class="sc">%&gt;%</span> </span>
<span id="cb494-6"><a href="factor-models.html#cb494-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Decile, Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb494-7"><a href="factor-models.html#cb494-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
## # Groups:   Decile [10]
##    Decile Annualised_Mean_Return Annualised_SD Sharpe_Ratio
##     &lt;dbl&gt;                  &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
##  1      1                -0.0679         0.210       -0.324
##  2      2                 0.0332         0.171        0.194
##  3      3                 0.0488         0.162        0.302
##  4      4                 0.0627         0.165        0.381
##  5      5                 0.0750         0.177        0.423
##  6      6                 0.0555         0.161        0.346
##  7      7                 0.0780         0.160        0.489
##  8      8                 0.0609         0.171        0.356
##  9      9                 0.0889         0.180        0.492
## 10     10                 0.0857         0.174        0.492</code></pre>
</div>
<div id="the-value-factor" class="section level4" number="8.5.4.3">
<h4><span class="header-section-number">8.5.4.3</span> The Value Factor</h4>
<p>This is the long-format construction of the value factor based on the data downloaded.</p>
<div class="sourceCode" id="cb496"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb496-1"><a href="factor-models.html#cb496-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb496-2"><a href="factor-models.html#cb496-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb496-3"><a href="factor-models.html#cb496-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb496-4"><a href="factor-models.html#cb496-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb496-5"><a href="factor-models.html#cb496-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb496-6"><a href="factor-models.html#cb496-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-7"><a href="factor-models.html#cb496-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb496-8"><a href="factor-models.html#cb496-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb496-9"><a href="factor-models.html#cb496-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb496-10"><a href="factor-models.html#cb496-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Close, Num_Shares, Total_Assets_t, Total_Liab_t, Total_Eq_t)</span>
<span id="cb496-11"><a href="factor-models.html#cb496-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-12"><a href="factor-models.html#cb496-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb496-13"><a href="factor-models.html#cb496-13" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Value <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb496-14"><a href="factor-models.html#cb496-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb496-15"><a href="factor-models.html#cb496-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb496-16"><a href="factor-models.html#cb496-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb496-17"><a href="factor-models.html#cb496-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb496-18"><a href="factor-models.html#cb496-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb496-19"><a href="factor-models.html#cb496-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb496-20"><a href="factor-models.html#cb496-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="fl">0.999</span>), </span>
<span id="cb496-21"><a href="factor-models.html#cb496-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb496-22"><a href="factor-models.html#cb496-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb496-23"><a href="factor-models.html#cb496-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb496-24"><a href="factor-models.html#cb496-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-25"><a href="factor-models.html#cb496-25" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Value <span class="sc">%&gt;%</span> </span>
<span id="cb496-26"><a href="factor-models.html#cb496-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb496-27"><a href="factor-models.html#cb496-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb496-28"><a href="factor-models.html#cb496-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb496-29"><a href="factor-models.html#cb496-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged,</span>
<span id="cb496-30"><a href="factor-models.html#cb496-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">Total_Eq_t =</span> Total_Assets_t <span class="sc">-</span> Total_Liab_t,</span>
<span id="cb496-31"><a href="factor-models.html#cb496-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">B2M =</span> <span class="fu">lag</span>(Total_Eq_t, <span class="at">n =</span> <span class="dv">7</span>) <span class="sc">/</span>Market_Cap) <span class="sc">%&gt;%</span> </span>
<span id="cb496-32"><a href="factor-models.html#cb496-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb496-33"><a href="factor-models.html#cb496-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb496-34"><a href="factor-models.html#cb496-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-35"><a href="factor-models.html#cb496-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rankings</span></span>
<span id="cb496-36"><a href="factor-models.html#cb496-36" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Value <span class="sc">%&gt;%</span> </span>
<span id="cb496-37"><a href="factor-models.html#cb496-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb496-38"><a href="factor-models.html#cb496-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb496-39"><a href="factor-models.html#cb496-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(B2M, </span>
<span id="cb496-40"><a href="factor-models.html#cb496-40" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(B2M, </span>
<span id="cb496-41"><a href="factor-models.html#cb496-41" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb496-42"><a href="factor-models.html#cb496-42" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb496-43"><a href="factor-models.html#cb496-43" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>),</span>
<span id="cb496-44"><a href="factor-models.html#cb496-44" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb496-45"><a href="factor-models.html#cb496-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">p1 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.1</span>), </span>
<span id="cb496-46"><a href="factor-models.html#cb496-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">p2 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.2</span>),</span>
<span id="cb496-47"><a href="factor-models.html#cb496-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">p3 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.3</span>),</span>
<span id="cb496-48"><a href="factor-models.html#cb496-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">p4 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.4</span>),</span>
<span id="cb496-49"><a href="factor-models.html#cb496-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">p5 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.5</span>),</span>
<span id="cb496-50"><a href="factor-models.html#cb496-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">p6 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.6</span>),</span>
<span id="cb496-51"><a href="factor-models.html#cb496-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">p7 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.7</span>),</span>
<span id="cb496-52"><a href="factor-models.html#cb496-52" aria-hidden="true" tabindex="-1"></a>         <span class="at">p8 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.8</span>),</span>
<span id="cb496-53"><a href="factor-models.html#cb496-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">p9 =</span> <span class="fu">quantile</span>(B2M, <span class="fl">0.9</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb496-54"><a href="factor-models.html#cb496-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb496-55"><a href="factor-models.html#cb496-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-56"><a href="factor-models.html#cb496-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns</span></span>
<span id="cb496-57"><a href="factor-models.html#cb496-57" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Value <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb496-58"><a href="factor-models.html#cb496-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb496-59"><a href="factor-models.html#cb496-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb496-60"><a href="factor-models.html#cb496-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Decile,EW_Ret_mean_t,EW_Ret_sd_t) <span class="sc">%&gt;%</span> </span>
<span id="cb496-61"><a href="factor-models.html#cb496-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb496-62"><a href="factor-models.html#cb496-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb496-63"><a href="factor-models.html#cb496-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Decile)</span>
<span id="cb496-64"><a href="factor-models.html#cb496-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-65"><a href="factor-models.html#cb496-65" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret_Value <span class="ot">&lt;-</span> CH_data_EW_Ret_Value <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb496-66"><a href="factor-models.html#cb496-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_ret =</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Ret_mean_t))</span>
<span id="cb496-67"><a href="factor-models.html#cb496-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-68"><a href="factor-models.html#cb496-68" aria-hidden="true" tabindex="-1"></a>EW_Value <span class="ot">&lt;-</span> CH_data_Cum_Ret_Value <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.factor</span>(Decile)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t))</span>
<span id="cb496-69"><a href="factor-models.html#cb496-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb496-70"><a href="factor-models.html#cb496-70" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> EW_Value) <span class="sc">+</span></span>
<span id="cb496-71"><a href="factor-models.html#cb496-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>Date_t ,<span class="at">y =</span> cum_ret ,<span class="at">color =</span> Decile), <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb496-72"><a href="factor-models.html#cb496-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Value Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb496-73"><a href="factor-models.html#cb496-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb496-74"><a href="factor-models.html#cb496-74" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb496-75"><a href="factor-models.html#cb496-75" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb496-76"><a href="factor-models.html#cb496-76" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb496-77"><a href="factor-models.html#cb496-77" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb496-78"><a href="factor-models.html#cb496-78" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb496-79"><a href="factor-models.html#cb496-79" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb496-80"><a href="factor-models.html#cb496-80" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb496-81"><a href="factor-models.html#cb496-81" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb496-82"><a href="factor-models.html#cb496-82" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-278-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb497-1"><a href="factor-models.html#cb497-1" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Value <span class="sc">%&gt;%</span> </span>
<span id="cb497-2"><a href="factor-models.html#cb497-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb497-3"><a href="factor-models.html#cb497-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Annualised_Mean_Return =</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">mean</span>(EW_Ret_mean_t))<span class="sc">^</span><span class="dv">12</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb497-4"><a href="factor-models.html#cb497-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">Annualised_SD =</span> <span class="fu">sd</span>(EW_Ret_mean_t)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>), </span>
<span id="cb497-5"><a href="factor-models.html#cb497-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sharpe_Ratio =</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD) <span class="sc">%&gt;%</span> </span>
<span id="cb497-6"><a href="factor-models.html#cb497-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Decile, Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb497-7"><a href="factor-models.html#cb497-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
## # Groups:   Decile [10]
##    Decile Annualised_Mean_Return Annualised_SD Sharpe_Ratio
##     &lt;dbl&gt;                  &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
##  1      1               -0.00841         0.209      -0.0403
##  2      2                0.0903          0.173       0.521 
##  3      3                0.0730          0.186       0.392 
##  4      4                0.0535          0.173       0.309 
##  5      5                0.0602          0.168       0.358 
##  6      6                0.0697          0.166       0.421 
##  7      7                0.0715          0.161       0.445 
##  8      8                0.0558          0.164       0.340 
##  9      9                0.0984          0.171       0.574 
## 10     10                0.0782          0.162       0.483</code></pre>
</div>
<div id="the-profitability-factor" class="section level4" number="8.5.4.4">
<h4><span class="header-section-number">8.5.4.4</span> The Profitability Factor</h4>
<p>This is the long-format construction of the profitability factor based on the data downloaded.</p>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb499-1"><a href="factor-models.html#cb499-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb499-2"><a href="factor-models.html#cb499-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb499-3"><a href="factor-models.html#cb499-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb499-4"><a href="factor-models.html#cb499-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb499-5"><a href="factor-models.html#cb499-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb499-6"><a href="factor-models.html#cb499-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-7"><a href="factor-models.html#cb499-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb499-8"><a href="factor-models.html#cb499-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb499-9"><a href="factor-models.html#cb499-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb499-10"><a href="factor-models.html#cb499-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Gross_Inc_t, Operating_Exp_t, Interest_Exp_t, Total_Eq_t)</span>
<span id="cb499-11"><a href="factor-models.html#cb499-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-12"><a href="factor-models.html#cb499-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb499-13"><a href="factor-models.html#cb499-13" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Profit <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb499-14"><a href="factor-models.html#cb499-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb499-15"><a href="factor-models.html#cb499-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb499-16"><a href="factor-models.html#cb499-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb499-17"><a href="factor-models.html#cb499-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb499-18"><a href="factor-models.html#cb499-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb499-19"><a href="factor-models.html#cb499-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb499-20"><a href="factor-models.html#cb499-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="fl">0.999</span>), </span>
<span id="cb499-21"><a href="factor-models.html#cb499-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb499-22"><a href="factor-models.html#cb499-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb499-23"><a href="factor-models.html#cb499-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb499-24"><a href="factor-models.html#cb499-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-25"><a href="factor-models.html#cb499-25" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Profit <span class="sc">%&gt;%</span> </span>
<span id="cb499-26"><a href="factor-models.html#cb499-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb499-27"><a href="factor-models.html#cb499-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Profit_lead =</span> (Gross_Inc_t <span class="sc">-</span> Operating_Exp_t <span class="sc">-</span> Interest_Exp_t)<span class="sc">/</span>Total_Eq_t,</span>
<span id="cb499-28"><a href="factor-models.html#cb499-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">Profit =</span> <span class="fu">lag</span>(Profit_lead, <span class="at">n =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb499-29"><a href="factor-models.html#cb499-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb499-30"><a href="factor-models.html#cb499-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb499-31"><a href="factor-models.html#cb499-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-32"><a href="factor-models.html#cb499-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rankings</span></span>
<span id="cb499-33"><a href="factor-models.html#cb499-33" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Profit <span class="sc">%&gt;%</span> </span>
<span id="cb499-34"><a href="factor-models.html#cb499-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb499-35"><a href="factor-models.html#cb499-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb499-36"><a href="factor-models.html#cb499-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Profit, </span>
<span id="cb499-37"><a href="factor-models.html#cb499-37" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Profit, </span>
<span id="cb499-38"><a href="factor-models.html#cb499-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb499-39"><a href="factor-models.html#cb499-39" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb499-40"><a href="factor-models.html#cb499-40" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>),</span>
<span id="cb499-41"><a href="factor-models.html#cb499-41" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb499-42"><a href="factor-models.html#cb499-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">p1 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.1</span>), </span>
<span id="cb499-43"><a href="factor-models.html#cb499-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">p2 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.2</span>),</span>
<span id="cb499-44"><a href="factor-models.html#cb499-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">p3 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.3</span>),</span>
<span id="cb499-45"><a href="factor-models.html#cb499-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">p4 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.4</span>),</span>
<span id="cb499-46"><a href="factor-models.html#cb499-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">p5 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.5</span>),</span>
<span id="cb499-47"><a href="factor-models.html#cb499-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">p6 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.6</span>),</span>
<span id="cb499-48"><a href="factor-models.html#cb499-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">p7 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.7</span>),</span>
<span id="cb499-49"><a href="factor-models.html#cb499-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">p8 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.8</span>),</span>
<span id="cb499-50"><a href="factor-models.html#cb499-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">p9 =</span> <span class="fu">quantile</span>(Profit, <span class="fl">0.9</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb499-51"><a href="factor-models.html#cb499-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb499-52"><a href="factor-models.html#cb499-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-53"><a href="factor-models.html#cb499-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns</span></span>
<span id="cb499-54"><a href="factor-models.html#cb499-54" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Profit <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb499-55"><a href="factor-models.html#cb499-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb499-56"><a href="factor-models.html#cb499-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb499-57"><a href="factor-models.html#cb499-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Decile,EW_Ret_mean_t,EW_Ret_sd_t) <span class="sc">%&gt;%</span> </span>
<span id="cb499-58"><a href="factor-models.html#cb499-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb499-59"><a href="factor-models.html#cb499-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb499-60"><a href="factor-models.html#cb499-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Decile)</span>
<span id="cb499-61"><a href="factor-models.html#cb499-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-62"><a href="factor-models.html#cb499-62" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret_Profit <span class="ot">&lt;-</span> CH_data_EW_Ret_Profit <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb499-63"><a href="factor-models.html#cb499-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_ret =</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Ret_mean_t))</span>
<span id="cb499-64"><a href="factor-models.html#cb499-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-65"><a href="factor-models.html#cb499-65" aria-hidden="true" tabindex="-1"></a>EW_Profit <span class="ot">&lt;-</span> CH_data_Cum_Ret_Profit <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.factor</span>(Decile)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t))</span>
<span id="cb499-66"><a href="factor-models.html#cb499-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-67"><a href="factor-models.html#cb499-67" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> EW_Profit) <span class="sc">+</span></span>
<span id="cb499-68"><a href="factor-models.html#cb499-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>Date_t ,<span class="at">y =</span> cum_ret ,<span class="at">color =</span> Decile), <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb499-69"><a href="factor-models.html#cb499-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Operating Profitability Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb499-70"><a href="factor-models.html#cb499-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb499-71"><a href="factor-models.html#cb499-71" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb499-72"><a href="factor-models.html#cb499-72" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb499-73"><a href="factor-models.html#cb499-73" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb499-74"><a href="factor-models.html#cb499-74" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb499-75"><a href="factor-models.html#cb499-75" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb499-76"><a href="factor-models.html#cb499-76" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb499-77"><a href="factor-models.html#cb499-77" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb499-78"><a href="factor-models.html#cb499-78" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb499-79"><a href="factor-models.html#cb499-79" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-280-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb500-1"><a href="factor-models.html#cb500-1" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Profit <span class="sc">%&gt;%</span> </span>
<span id="cb500-2"><a href="factor-models.html#cb500-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb500-3"><a href="factor-models.html#cb500-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Annualised_Mean_Return =</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">mean</span>(EW_Ret_mean_t))<span class="sc">^</span><span class="dv">12</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb500-4"><a href="factor-models.html#cb500-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">Annualised_SD =</span> <span class="fu">sd</span>(EW_Ret_mean_t)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>), </span>
<span id="cb500-5"><a href="factor-models.html#cb500-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sharpe_Ratio =</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD) <span class="sc">%&gt;%</span> </span>
<span id="cb500-6"><a href="factor-models.html#cb500-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Decile, Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb500-7"><a href="factor-models.html#cb500-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
## # Groups:   Decile [10]
##    Decile Annualised_Mean_Return Annualised_SD Sharpe_Ratio
##     &lt;dbl&gt;                  &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
##  1      1                -0.0411         0.227      -0.181 
##  2      2                 0.0256         0.191       0.134 
##  3      3                 0.0100         0.221       0.0455
##  4      4                 0.0676         0.201       0.336 
##  5      5                 0.0469         0.194       0.241 
##  6      6                 0.0434         0.186       0.234 
##  7      7                 0.0893         0.163       0.547 
##  8      8                 0.0763         0.186       0.411 
##  9      9                 0.0793         0.175       0.453 
## 10     10                 0.0565         0.147       0.386</code></pre>
</div>
<div id="the-investment-factor" class="section level4" number="8.5.4.5">
<h4><span class="header-section-number">8.5.4.5</span> The Investment Factor</h4>
<p>This is the long-format construction of the investment factor based on the data downloaded.</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb502-1"><a href="factor-models.html#cb502-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb502-2"><a href="factor-models.html#cb502-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb502-3"><a href="factor-models.html#cb502-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb502-4"><a href="factor-models.html#cb502-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb502-5"><a href="factor-models.html#cb502-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb502-6"><a href="factor-models.html#cb502-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-7"><a href="factor-models.html#cb502-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb502-8"><a href="factor-models.html#cb502-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb502-9"><a href="factor-models.html#cb502-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb502-10"><a href="factor-models.html#cb502-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Total_Assets_t)</span>
<span id="cb502-11"><a href="factor-models.html#cb502-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-12"><a href="factor-models.html#cb502-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb502-13"><a href="factor-models.html#cb502-13" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Invest <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb502-14"><a href="factor-models.html#cb502-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb502-15"><a href="factor-models.html#cb502-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb502-16"><a href="factor-models.html#cb502-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb502-17"><a href="factor-models.html#cb502-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb502-18"><a href="factor-models.html#cb502-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb502-19"><a href="factor-models.html#cb502-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb502-20"><a href="factor-models.html#cb502-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="fl">0.999</span>), </span>
<span id="cb502-21"><a href="factor-models.html#cb502-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb502-22"><a href="factor-models.html#cb502-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb502-23"><a href="factor-models.html#cb502-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb502-24"><a href="factor-models.html#cb502-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-25"><a href="factor-models.html#cb502-25" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Invest <span class="sc">%&gt;%</span> </span>
<span id="cb502-26"><a href="factor-models.html#cb502-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb502-27"><a href="factor-models.html#cb502-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Invest_lead =</span> (Total_Assets_t <span class="sc">-</span> <span class="fu">lag</span>(Total_Assets_t, <span class="at">n =</span> <span class="dv">12</span>))<span class="sc">/</span><span class="fu">lag</span>(Total_Assets_t, <span class="at">n =</span> <span class="dv">12</span>),</span>
<span id="cb502-28"><a href="factor-models.html#cb502-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">Invest =</span> <span class="fu">lag</span>(Invest_lead, <span class="at">n =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb502-29"><a href="factor-models.html#cb502-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb502-30"><a href="factor-models.html#cb502-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb502-31"><a href="factor-models.html#cb502-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-32"><a href="factor-models.html#cb502-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rankings</span></span>
<span id="cb502-33"><a href="factor-models.html#cb502-33" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Invest <span class="sc">%&gt;%</span> </span>
<span id="cb502-34"><a href="factor-models.html#cb502-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb502-35"><a href="factor-models.html#cb502-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb502-36"><a href="factor-models.html#cb502-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Invest, </span>
<span id="cb502-37"><a href="factor-models.html#cb502-37" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Invest, </span>
<span id="cb502-38"><a href="factor-models.html#cb502-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb502-39"><a href="factor-models.html#cb502-39" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb502-40"><a href="factor-models.html#cb502-40" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>),</span>
<span id="cb502-41"><a href="factor-models.html#cb502-41" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb502-42"><a href="factor-models.html#cb502-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">p1 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.1</span>), </span>
<span id="cb502-43"><a href="factor-models.html#cb502-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">p2 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.2</span>),</span>
<span id="cb502-44"><a href="factor-models.html#cb502-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">p3 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.3</span>),</span>
<span id="cb502-45"><a href="factor-models.html#cb502-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">p4 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.4</span>),</span>
<span id="cb502-46"><a href="factor-models.html#cb502-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">p5 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.5</span>),</span>
<span id="cb502-47"><a href="factor-models.html#cb502-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">p6 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.6</span>),</span>
<span id="cb502-48"><a href="factor-models.html#cb502-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">p7 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.7</span>),</span>
<span id="cb502-49"><a href="factor-models.html#cb502-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">p8 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.8</span>),</span>
<span id="cb502-50"><a href="factor-models.html#cb502-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">p9 =</span> <span class="fu">quantile</span>(Invest, <span class="fl">0.9</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb502-51"><a href="factor-models.html#cb502-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb502-52"><a href="factor-models.html#cb502-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-53"><a href="factor-models.html#cb502-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns</span></span>
<span id="cb502-54"><a href="factor-models.html#cb502-54" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Invest <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb502-55"><a href="factor-models.html#cb502-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb502-56"><a href="factor-models.html#cb502-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb502-57"><a href="factor-models.html#cb502-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Decile,EW_Ret_mean_t,EW_Ret_sd_t) <span class="sc">%&gt;%</span> </span>
<span id="cb502-58"><a href="factor-models.html#cb502-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb502-59"><a href="factor-models.html#cb502-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb502-60"><a href="factor-models.html#cb502-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Decile)</span>
<span id="cb502-61"><a href="factor-models.html#cb502-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-62"><a href="factor-models.html#cb502-62" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret_Invest <span class="ot">&lt;-</span> CH_data_EW_Ret_Invest <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb502-63"><a href="factor-models.html#cb502-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_ret =</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Ret_mean_t))</span>
<span id="cb502-64"><a href="factor-models.html#cb502-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-65"><a href="factor-models.html#cb502-65" aria-hidden="true" tabindex="-1"></a>EW_Invest <span class="ot">&lt;-</span> CH_data_Cum_Ret_Invest <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.factor</span>(Decile)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t))</span>
<span id="cb502-66"><a href="factor-models.html#cb502-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-67"><a href="factor-models.html#cb502-67" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> EW_Invest) <span class="sc">+</span></span>
<span id="cb502-68"><a href="factor-models.html#cb502-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>Date_t ,<span class="at">y =</span> cum_ret ,<span class="at">color =</span> Decile), <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb502-69"><a href="factor-models.html#cb502-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Investment Growth Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb502-70"><a href="factor-models.html#cb502-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb502-71"><a href="factor-models.html#cb502-71" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb502-72"><a href="factor-models.html#cb502-72" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb502-73"><a href="factor-models.html#cb502-73" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb502-74"><a href="factor-models.html#cb502-74" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb502-75"><a href="factor-models.html#cb502-75" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb502-76"><a href="factor-models.html#cb502-76" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb502-77"><a href="factor-models.html#cb502-77" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb502-78"><a href="factor-models.html#cb502-78" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb502-79"><a href="factor-models.html#cb502-79" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-282-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb503"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb503-1"><a href="factor-models.html#cb503-1" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Invest <span class="sc">%&gt;%</span> </span>
<span id="cb503-2"><a href="factor-models.html#cb503-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb503-3"><a href="factor-models.html#cb503-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Annualised_Mean_Return =</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">mean</span>(EW_Ret_mean_t))<span class="sc">^</span><span class="dv">12</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb503-4"><a href="factor-models.html#cb503-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">Annualised_SD =</span> <span class="fu">sd</span>(EW_Ret_mean_t)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>), </span>
<span id="cb503-5"><a href="factor-models.html#cb503-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sharpe_Ratio =</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD) <span class="sc">%&gt;%</span> </span>
<span id="cb503-6"><a href="factor-models.html#cb503-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Decile, Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb503-7"><a href="factor-models.html#cb503-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
## # Groups:   Decile [10]
##    Decile Annualised_Mean_Return Annualised_SD Sharpe_Ratio
##     &lt;dbl&gt;                  &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
##  1      1                -0.115          0.233      -0.494 
##  2      2                -0.0110         0.191      -0.0576
##  3      3                 0.0423         0.184       0.230 
##  4      4                 0.0699         0.157       0.445 
##  5      5                 0.0578         0.153       0.377 
##  6      6                 0.0885         0.164       0.539 
##  7      7                 0.122          0.145       0.842 
##  8      8                 0.112          0.159       0.705 
##  9      9                 0.150          0.164       0.913 
## 10     10                 0.148          0.183       0.809</code></pre>
</div>
<div id="the-betting-against-beta-factor" class="section level4" number="8.5.4.6">
<h4><span class="header-section-number">8.5.4.6</span> The Betting against Beta Factor</h4>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb505-1"><a href="factor-models.html#cb505-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb505-2"><a href="factor-models.html#cb505-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb505-3"><a href="factor-models.html#cb505-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb505-4"><a href="factor-models.html#cb505-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb505-5"><a href="factor-models.html#cb505-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb505-6"><a href="factor-models.html#cb505-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-7"><a href="factor-models.html#cb505-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb505-8"><a href="factor-models.html#cb505-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb505-9"><a href="factor-models.html#cb505-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb505-10"><a href="factor-models.html#cb505-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Total_Assets_t)</span>
<span id="cb505-11"><a href="factor-models.html#cb505-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-12"><a href="factor-models.html#cb505-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb505-13"><a href="factor-models.html#cb505-13" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_BAB <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb505-14"><a href="factor-models.html#cb505-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb505-15"><a href="factor-models.html#cb505-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb505-16"><a href="factor-models.html#cb505-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb505-17"><a href="factor-models.html#cb505-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb505-18"><a href="factor-models.html#cb505-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb505-19"><a href="factor-models.html#cb505-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb505-20"><a href="factor-models.html#cb505-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="dv">1</span>), </span>
<span id="cb505-21"><a href="factor-models.html#cb505-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb505-22"><a href="factor-models.html#cb505-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb505-23"><a href="factor-models.html#cb505-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb505-24"><a href="factor-models.html#cb505-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-25"><a href="factor-models.html#cb505-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-26"><a href="factor-models.html#cb505-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s also get the data on the Swiss Market Index as well as the risk free rate </span></span>
<span id="cb505-27"><a href="factor-models.html#cb505-27" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A2_dataset_02.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb505-28"><a href="factor-models.html#cb505-28" aria-hidden="true" tabindex="-1"></a>rf_ts <span class="ot">&lt;-</span> rf <span class="sc">%&gt;%</span> </span>
<span id="cb505-29"><a href="factor-models.html#cb505-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>((Date <span class="sc">&gt;=</span> <span class="st">&#39;1989-12-01&#39;</span>) <span class="sc">&amp;</span> (Date <span class="sc">&lt;=</span> <span class="st">&#39;2019-12-31&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb505-30"><a href="factor-models.html#cb505-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rf_annual =</span> SWISS.CONFEDERATION.BOND.<span class="fl">1.</span>YEAR...RED..YIELD <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb505-31"><a href="factor-models.html#cb505-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">rf_monthly =</span>  (<span class="dv">1</span> <span class="sc">+</span> rf_annual)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb505-32"><a href="factor-models.html#cb505-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date, rf_monthly)</span>
<span id="cb505-33"><a href="factor-models.html#cb505-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-34"><a href="factor-models.html#cb505-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb505-35"><a href="factor-models.html#cb505-35" aria-hidden="true" tabindex="-1"></a>SMI <span class="ot">&lt;-</span>  <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A2_dataset_03.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb505-36"><a href="factor-models.html#cb505-36" aria-hidden="true" tabindex="-1"></a>SMI_ts <span class="ot">&lt;-</span> SMI <span class="sc">%&gt;%</span> </span>
<span id="cb505-37"><a href="factor-models.html#cb505-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>((Date <span class="sc">&gt;=</span> <span class="st">&#39;1989-12-01&#39;</span>) <span class="sc">&amp;</span> (Date <span class="sc">&lt;=</span> <span class="st">&#39;2019-12-31&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb505-38"><a href="factor-models.html#cb505-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SMI_ret =</span> (SMI <span class="sc">-</span> <span class="fu">lag</span>(SMI, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(SMI, <span class="dv">1</span>),</span>
<span id="cb505-39"><a href="factor-models.html#cb505-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">rf_monthly =</span> rf_ts<span class="sc">$</span>rf_monthly,</span>
<span id="cb505-40"><a href="factor-models.html#cb505-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">SMI_rf_excess_ret =</span> SMI_ret <span class="sc">-</span> rf_monthly) </span>
<span id="cb505-41"><a href="factor-models.html#cb505-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-42"><a href="factor-models.html#cb505-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, let&#39;s calculate the excess returns</span></span>
<span id="cb505-43"><a href="factor-models.html#cb505-43" aria-hidden="true" tabindex="-1"></a>SMI_rf_ts_ret <span class="ot">&lt;-</span> SMI_ts_ret <span class="sc">-</span> rf_ts_monthly</span>
<span id="cb505-44"><a href="factor-models.html#cb505-44" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_excess_ret_BAB <span class="ot">&lt;-</span> <span class="fu">left_join</span>(SMI_ts, CH_data_total_monthly_sub_BAB, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Date&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb505-45"><a href="factor-models.html#cb505-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Excess_Ret_Adj =</span> Ret_Adj <span class="sc">-</span> rf_monthly)</span>
<span id="cb505-46"><a href="factor-models.html#cb505-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb505-47"><a href="factor-models.html#cb505-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on this, we can now have rolling regressions of the correlation as well as the standard deviations. </span></span>
<span id="cb505-48"><a href="factor-models.html#cb505-48" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_weighted_BAB <span class="ot">&lt;-</span> CH_data_total_monthly_sub_excess_ret_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb505-49"><a href="factor-models.html#cb505-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb505-50"><a href="factor-models.html#cb505-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sd_roll_1_year =</span> <span class="fu">roll_sd</span>(Excess_Ret_Adj, <span class="at">width =</span> <span class="dv">12</span>), </span>
<span id="cb505-51"><a href="factor-models.html#cb505-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">corr_roll_5_year =</span> <span class="fu">roll_cor</span>(Excess_Ret_Adj, SMI_rf_excess_ret, <span class="at">width =</span> <span class="dv">60</span>), </span>
<span id="cb505-52"><a href="factor-models.html#cb505-52" aria-hidden="true" tabindex="-1"></a>         <span class="at">sd_roll_1_year_Market =</span> <span class="fu">roll_sd</span>(SMI_rf_excess_ret, <span class="at">width =</span> <span class="dv">12</span>), </span>
<span id="cb505-53"><a href="factor-models.html#cb505-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">Beta_Est_raw =</span> sd_roll_1_year<span class="sc">/</span>sd_roll_1_year_Market<span class="sc">*</span>corr_roll_5_year,</span>
<span id="cb505-54"><a href="factor-models.html#cb505-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">Beta_Est_Adj =</span> Beta_Est_raw<span class="sc">*</span><span class="fl">0.4</span> <span class="sc">+</span> <span class="fl">0.6</span><span class="sc">*</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb505-55"><a href="factor-models.html#cb505-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb505-56"><a href="factor-models.html#cb505-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="sc">!</span><span class="fu">is.na</span>(Beta_Est_Adj)) <span class="sc">%&gt;%</span></span>
<span id="cb505-57"><a href="factor-models.html#cb505-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb505-58"><a href="factor-models.html#cb505-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranks_beta =</span> <span class="fu">rank</span>(Beta_Est_Adj), </span>
<span id="cb505-59"><a href="factor-models.html#cb505-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean_rank_beta =</span> <span class="fu">mean</span>(ranks_beta, <span class="at">na.rm =</span> T), </span>
<span id="cb505-60"><a href="factor-models.html#cb505-60" aria-hidden="true" tabindex="-1"></a>         <span class="at">portfolio_indicator_BAB =</span><span class="fu">ifelse</span>(ranks_beta <span class="sc">&gt;</span> mean_rank_beta, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb505-61"><a href="factor-models.html#cb505-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb505-62"><a href="factor-models.html#cb505-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, portfolio_indicator_BAB) <span class="sc">%&gt;%</span> </span>
<span id="cb505-63"><a href="factor-models.html#cb505-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">abs_dev =</span> <span class="fu">abs</span>(ranks_beta <span class="sc">-</span> mean_rank_beta), </span>
<span id="cb505-64"><a href="factor-models.html#cb505-64" aria-hidden="true" tabindex="-1"></a>         <span class="at">sum_abs_dev =</span> <span class="fu">sum</span>(abs_dev, <span class="at">na.rm =</span> T), </span>
<span id="cb505-65"><a href="factor-models.html#cb505-65" aria-hidden="true" tabindex="-1"></a>         <span class="at">k =</span> <span class="dv">2</span> <span class="sc">/</span> sum_abs_dev, </span>
<span id="cb505-66"><a href="factor-models.html#cb505-66" aria-hidden="true" tabindex="-1"></a>         <span class="at">weights_BAB =</span> k<span class="sc">*</span>(ranks_beta <span class="sc">-</span> mean_rank_beta), </span>
<span id="cb505-67"><a href="factor-models.html#cb505-67" aria-hidden="true" tabindex="-1"></a>         <span class="at">Beta_Est_Weight_Adj =</span> Beta_Est_Adj <span class="sc">*</span> weights_BAB) <span class="sc">%&gt;%</span> </span>
<span id="cb505-68"><a href="factor-models.html#cb505-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb505-69"><a href="factor-models.html#cb505-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-70"><a href="factor-models.html#cb505-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rankings</span></span>
<span id="cb505-71"><a href="factor-models.html#cb505-71" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_rank_BAB <span class="ot">&lt;-</span> CH_data_total_monthly_weighted_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb505-72"><a href="factor-models.html#cb505-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb505-73"><a href="factor-models.html#cb505-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Min_PF =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb505-74"><a href="factor-models.html#cb505-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Min_PF <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb505-75"><a href="factor-models.html#cb505-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Beta_Est_Weight_Adj, </span>
<span id="cb505-76"><a href="factor-models.html#cb505-76" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, </span>
<span id="cb505-77"><a href="factor-models.html#cb505-77" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">10</span>), </span>
<span id="cb505-78"><a href="factor-models.html#cb505-78" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb505-79"><a href="factor-models.html#cb505-79" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>),</span>
<span id="cb505-80"><a href="factor-models.html#cb505-80" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb505-81"><a href="factor-models.html#cb505-81" aria-hidden="true" tabindex="-1"></a>         <span class="at">p1 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.1</span>), </span>
<span id="cb505-82"><a href="factor-models.html#cb505-82" aria-hidden="true" tabindex="-1"></a>         <span class="at">p2 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.2</span>),</span>
<span id="cb505-83"><a href="factor-models.html#cb505-83" aria-hidden="true" tabindex="-1"></a>         <span class="at">p3 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.3</span>),</span>
<span id="cb505-84"><a href="factor-models.html#cb505-84" aria-hidden="true" tabindex="-1"></a>         <span class="at">p4 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.4</span>),</span>
<span id="cb505-85"><a href="factor-models.html#cb505-85" aria-hidden="true" tabindex="-1"></a>         <span class="at">p5 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.5</span>), </span>
<span id="cb505-86"><a href="factor-models.html#cb505-86" aria-hidden="true" tabindex="-1"></a>         <span class="at">p6 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.6</span>),</span>
<span id="cb505-87"><a href="factor-models.html#cb505-87" aria-hidden="true" tabindex="-1"></a>         <span class="at">p7 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.7</span>),</span>
<span id="cb505-88"><a href="factor-models.html#cb505-88" aria-hidden="true" tabindex="-1"></a>         <span class="at">p8 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.8</span>),</span>
<span id="cb505-89"><a href="factor-models.html#cb505-89" aria-hidden="true" tabindex="-1"></a>         <span class="at">p9 =</span> <span class="fu">quantile</span>(Beta_Est_Weight_Adj, <span class="fl">0.9</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb505-90"><a href="factor-models.html#cb505-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb505-91"><a href="factor-models.html#cb505-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-92"><a href="factor-models.html#cb505-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns Decile</span></span>
<span id="cb505-93"><a href="factor-models.html#cb505-93" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_BAB <span class="ot">&lt;-</span> CH_data_total_monthly_rank_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb505-94"><a href="factor-models.html#cb505-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb505-95"><a href="factor-models.html#cb505-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(Beta_Est_Weight_Adj)<span class="sc">*</span><span class="fu">sum</span>(weights_BAB<span class="sc">*</span>Excess_Ret_Adj)) <span class="sc">%&gt;%</span> </span>
<span id="cb505-96"><a href="factor-models.html#cb505-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date, Decile, EW_Ret_mean_t) <span class="sc">%&gt;%</span> </span>
<span id="cb505-97"><a href="factor-models.html#cb505-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb505-98"><a href="factor-models.html#cb505-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb505-99"><a href="factor-models.html#cb505-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date, Decile)</span>
<span id="cb505-100"><a href="factor-models.html#cb505-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb505-101"><a href="factor-models.html#cb505-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the cumulative returns</span></span>
<span id="cb505-102"><a href="factor-models.html#cb505-102" aria-hidden="true" tabindex="-1"></a>CH_data_Cum_Ret_BAB <span class="ot">&lt;-</span> CH_data_EW_Ret_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb505-103"><a href="factor-models.html#cb505-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb505-104"><a href="factor-models.html#cb505-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_ret =</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>EW_Ret_mean_t))</span>
<span id="cb505-105"><a href="factor-models.html#cb505-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-106"><a href="factor-models.html#cb505-106" aria-hidden="true" tabindex="-1"></a>EW_BAB <span class="ot">&lt;-</span> CH_data_Cum_Ret_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb505-107"><a href="factor-models.html#cb505-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">as.factor</span>(Decile)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.Date</span>(Date))</span>
<span id="cb505-108"><a href="factor-models.html#cb505-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb505-109"><a href="factor-models.html#cb505-109" aria-hidden="true" tabindex="-1"></a>EW_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb505-110"><a href="factor-models.html#cb505-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Decile <span class="sc">!=</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb505-111"><a href="factor-models.html#cb505-111" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb505-112"><a href="factor-models.html#cb505-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>Date ,<span class="at">y =</span> cum_ret ,<span class="at">color =</span> Decile), <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb505-113"><a href="factor-models.html#cb505-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;BAB Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb505-114"><a href="factor-models.html#cb505-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb505-115"><a href="factor-models.html#cb505-115" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb505-116"><a href="factor-models.html#cb505-116" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb505-117"><a href="factor-models.html#cb505-117" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb505-118"><a href="factor-models.html#cb505-118" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb505-119"><a href="factor-models.html#cb505-119" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb505-120"><a href="factor-models.html#cb505-120" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb505-121"><a href="factor-models.html#cb505-121" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb505-122"><a href="factor-models.html#cb505-122" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb505-123"><a href="factor-models.html#cb505-123" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-284-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb506-1"><a href="factor-models.html#cb506-1" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb506-2"><a href="factor-models.html#cb506-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb506-3"><a href="factor-models.html#cb506-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Annualised_Mean_Return =</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">mean</span>(EW_Ret_mean_t))<span class="sc">^</span><span class="dv">12</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb506-4"><a href="factor-models.html#cb506-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">Annualised_SD =</span> <span class="fu">sd</span>(EW_Ret_mean_t)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">12</span>), </span>
<span id="cb506-5"><a href="factor-models.html#cb506-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sharpe_Ratio =</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD) <span class="sc">%&gt;%</span> </span>
<span id="cb506-6"><a href="factor-models.html#cb506-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Decile, Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio) <span class="sc">%&gt;%</span> </span>
<span id="cb506-7"><a href="factor-models.html#cb506-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() </span></code></pre></div>
<pre><code>## # A tibble: 9 × 4
## # Groups:   Decile [9]
##   Decile Annualised_Mean_Return Annualised_SD Sharpe_Ratio
##    &lt;dbl&gt;                  &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
## 1      1                 0.0595         0.147       0.405 
## 2      2                 0.0522         0.147       0.356 
## 3      3                 0.134          0.199       0.674 
## 4      4                 0.114          0.185       0.616 
## 5      5                -0.234          3.46       -0.0676
## 6      6                 0.0773         0.224       0.346 
## 7      7                 0.0857         0.216       0.397 
## 8      8                 0.0611         0.227       0.269 
## 9      9                 0.0435         0.266       0.163</code></pre>
</div>
</div>
<div id="double-sorted-portfolios" class="section level3" number="8.5.5">
<h3><span class="header-section-number">8.5.5</span> Double-sorted Portfolios</h3>
<p>We now have created the portfolio sorts for each of the factors under consideration and plotted the cumulative returns of each decile throughout time. Let’s now get one step further and calculate double-sorted portfolios based on the company size as well as the respective factor characteristic under consideration. Throughout, we will follow the approach of Fama and French (1993, 2015). That is, we will use the formulas specifically highlighted and used by both researchers during the construction for the US market and replicate their strategy for the Swiss market. The repsective factors <a href="https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/f-f_5_factors_2x3.html">can be found on Kenneth French’s webpage</a>.</p>
<div id="small-minus-big" class="section level4" number="8.5.5.1">
<h4><span class="header-section-number">8.5.5.1</span> Small Minus Big</h4>
<p>For the SMB factor, we will use an aggregate of double-sorted portfolios based on size as well as Value, Profitability and Investment, respectively. That is, we will double-sort the stocks based on size and each of the three distinct accounting measures and then create a long-short strategy for each double sort. Lastly, we will aggregate the three risk factors by creating an equal-weighted SMB factor consisting of all three sub-factors.</p>
<div class="sourceCode" id="cb508"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb508-1"><a href="factor-models.html#cb508-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb508-2"><a href="factor-models.html#cb508-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb508-3"><a href="factor-models.html#cb508-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb508-4"><a href="factor-models.html#cb508-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb508-5"><a href="factor-models.html#cb508-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb508-6"><a href="factor-models.html#cb508-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-7"><a href="factor-models.html#cb508-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb508-8"><a href="factor-models.html#cb508-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb508-9"><a href="factor-models.html#cb508-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb508-10"><a href="factor-models.html#cb508-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Close, Num_Shares, Total_Eq_t, Gross_Inc_t, Operating_Exp_t, Interest_Exp_t, Total_Assets_t, Total_Liab_t)</span>
<span id="cb508-11"><a href="factor-models.html#cb508-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-12"><a href="factor-models.html#cb508-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb508-13"><a href="factor-models.html#cb508-13" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Size <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb508-14"><a href="factor-models.html#cb508-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb508-15"><a href="factor-models.html#cb508-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb508-16"><a href="factor-models.html#cb508-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-17"><a href="factor-models.html#cb508-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-18"><a href="factor-models.html#cb508-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-19"><a href="factor-models.html#cb508-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb508-20"><a href="factor-models.html#cb508-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="dv">1</span>), </span>
<span id="cb508-21"><a href="factor-models.html#cb508-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb508-22"><a href="factor-models.html#cb508-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb508-23"><a href="factor-models.html#cb508-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb508-24"><a href="factor-models.html#cb508-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-25"><a href="factor-models.html#cb508-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Value</span></span>
<span id="cb508-26"><a href="factor-models.html#cb508-26" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb508-27"><a href="factor-models.html#cb508-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb508-28"><a href="factor-models.html#cb508-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb508-29"><a href="factor-models.html#cb508-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb508-30"><a href="factor-models.html#cb508-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb508-31"><a href="factor-models.html#cb508-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb508-32"><a href="factor-models.html#cb508-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">Total_Eq_t =</span> Total_Assets_t <span class="sc">-</span> Total_Liab_t,</span>
<span id="cb508-33"><a href="factor-models.html#cb508-33" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb508-34"><a href="factor-models.html#cb508-34" aria-hidden="true" tabindex="-1"></a>         <span class="at">B2M =</span> <span class="fu">lag</span>(Total_Eq_t, <span class="at">n =</span> <span class="dv">7</span>) <span class="sc">/</span> Market_Cap) <span class="sc">%&gt;%</span> </span>
<span id="cb508-35"><a href="factor-models.html#cb508-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-36"><a href="factor-models.html#cb508-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb508-37"><a href="factor-models.html#cb508-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-38"><a href="factor-models.html#cb508-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Operating Profitability</span></span>
<span id="cb508-39"><a href="factor-models.html#cb508-39" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb508-40"><a href="factor-models.html#cb508-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb508-41"><a href="factor-models.html#cb508-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb508-42"><a href="factor-models.html#cb508-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb508-43"><a href="factor-models.html#cb508-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb508-44"><a href="factor-models.html#cb508-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb508-45"><a href="factor-models.html#cb508-45" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb508-46"><a href="factor-models.html#cb508-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">Profit_lead =</span> (Gross_Inc_t <span class="sc">-</span> Operating_Exp_t <span class="sc">-</span> Interest_Exp_t)<span class="sc">/</span>Total_Eq_t,</span>
<span id="cb508-47"><a href="factor-models.html#cb508-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">Profit =</span> <span class="fu">lag</span>(Profit_lead, <span class="at">n =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-48"><a href="factor-models.html#cb508-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-49"><a href="factor-models.html#cb508-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb508-50"><a href="factor-models.html#cb508-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb508-51"><a href="factor-models.html#cb508-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Investment Growth</span></span>
<span id="cb508-52"><a href="factor-models.html#cb508-52" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb508-53"><a href="factor-models.html#cb508-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb508-54"><a href="factor-models.html#cb508-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb508-55"><a href="factor-models.html#cb508-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb508-56"><a href="factor-models.html#cb508-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb508-57"><a href="factor-models.html#cb508-57" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb508-58"><a href="factor-models.html#cb508-58" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb508-59"><a href="factor-models.html#cb508-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">Invest_lead =</span> (Total_Assets_t <span class="sc">-</span> <span class="fu">lag</span>(Total_Assets_t, <span class="at">n =</span> <span class="dv">12</span>))<span class="sc">/</span><span class="fu">lag</span>(Total_Assets_t, <span class="at">n =</span> <span class="dv">12</span>),</span>
<span id="cb508-60"><a href="factor-models.html#cb508-60" aria-hidden="true" tabindex="-1"></a>         <span class="at">Invest =</span> <span class="fu">lag</span>(Invest_lead, <span class="at">n =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-61"><a href="factor-models.html#cb508-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-62"><a href="factor-models.html#cb508-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb508-63"><a href="factor-models.html#cb508-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-64"><a href="factor-models.html#cb508-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Value</span></span>
<span id="cb508-65"><a href="factor-models.html#cb508-65" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Value <span class="sc">%&gt;%</span> </span>
<span id="cb508-66"><a href="factor-models.html#cb508-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb508-67"><a href="factor-models.html#cb508-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb508-68"><a href="factor-models.html#cb508-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb508-69"><a href="factor-models.html#cb508-69" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb508-70"><a href="factor-models.html#cb508-70" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb508-71"><a href="factor-models.html#cb508-71" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb508-72"><a href="factor-models.html#cb508-72" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb508-73"><a href="factor-models.html#cb508-73" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb508-74"><a href="factor-models.html#cb508-74" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb508-75"><a href="factor-models.html#cb508-75" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on B2M (Low, Neutral, High)</span></span>
<span id="cb508-76"><a href="factor-models.html#cb508-76" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(B2M, </span>
<span id="cb508-77"><a href="factor-models.html#cb508-77" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(B2M, </span>
<span id="cb508-78"><a href="factor-models.html#cb508-78" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb508-79"><a href="factor-models.html#cb508-79" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb508-80"><a href="factor-models.html#cb508-80" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb508-81"><a href="factor-models.html#cb508-81" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb508-82"><a href="factor-models.html#cb508-82" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb508-83"><a href="factor-models.html#cb508-83" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb508-84"><a href="factor-models.html#cb508-84" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb508-85"><a href="factor-models.html#cb508-85" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb508-86"><a href="factor-models.html#cb508-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb508-87"><a href="factor-models.html#cb508-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-88"><a href="factor-models.html#cb508-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Operating Profitability</span></span>
<span id="cb508-89"><a href="factor-models.html#cb508-89" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Profit <span class="sc">%&gt;%</span> </span>
<span id="cb508-90"><a href="factor-models.html#cb508-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb508-91"><a href="factor-models.html#cb508-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb508-92"><a href="factor-models.html#cb508-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb508-93"><a href="factor-models.html#cb508-93" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb508-94"><a href="factor-models.html#cb508-94" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb508-95"><a href="factor-models.html#cb508-95" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb508-96"><a href="factor-models.html#cb508-96" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb508-97"><a href="factor-models.html#cb508-97" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb508-98"><a href="factor-models.html#cb508-98" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb508-99"><a href="factor-models.html#cb508-99" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on Oper Profit (Low, Neutral, High)</span></span>
<span id="cb508-100"><a href="factor-models.html#cb508-100" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Profit, </span>
<span id="cb508-101"><a href="factor-models.html#cb508-101" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Profit, </span>
<span id="cb508-102"><a href="factor-models.html#cb508-102" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb508-103"><a href="factor-models.html#cb508-103" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb508-104"><a href="factor-models.html#cb508-104" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb508-105"><a href="factor-models.html#cb508-105" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb508-106"><a href="factor-models.html#cb508-106" aria-hidden="true" tabindex="-1"></a>         <span class="at">Profit_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb508-107"><a href="factor-models.html#cb508-107" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb508-108"><a href="factor-models.html#cb508-108" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb508-109"><a href="factor-models.html#cb508-109" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb508-110"><a href="factor-models.html#cb508-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb508-111"><a href="factor-models.html#cb508-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-112"><a href="factor-models.html#cb508-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Investment Growth</span></span>
<span id="cb508-113"><a href="factor-models.html#cb508-113" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Invest <span class="sc">%&gt;%</span> </span>
<span id="cb508-114"><a href="factor-models.html#cb508-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb508-115"><a href="factor-models.html#cb508-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb508-116"><a href="factor-models.html#cb508-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb508-117"><a href="factor-models.html#cb508-117" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb508-118"><a href="factor-models.html#cb508-118" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb508-119"><a href="factor-models.html#cb508-119" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb508-120"><a href="factor-models.html#cb508-120" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb508-121"><a href="factor-models.html#cb508-121" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb508-122"><a href="factor-models.html#cb508-122" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb508-123"><a href="factor-models.html#cb508-123" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on Investment Growth (Low, Neutral, High)</span></span>
<span id="cb508-124"><a href="factor-models.html#cb508-124" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Invest, </span>
<span id="cb508-125"><a href="factor-models.html#cb508-125" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Invest, </span>
<span id="cb508-126"><a href="factor-models.html#cb508-126" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb508-127"><a href="factor-models.html#cb508-127" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb508-128"><a href="factor-models.html#cb508-128" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb508-129"><a href="factor-models.html#cb508-129" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb508-130"><a href="factor-models.html#cb508-130" aria-hidden="true" tabindex="-1"></a>         <span class="at">Invest_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb508-131"><a href="factor-models.html#cb508-131" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb508-132"><a href="factor-models.html#cb508-132" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb508-133"><a href="factor-models.html#cb508-133" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb508-134"><a href="factor-models.html#cb508-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb508-135"><a href="factor-models.html#cb508-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-136"><a href="factor-models.html#cb508-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-137"><a href="factor-models.html#cb508-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Value</span></span>
<span id="cb508-138"><a href="factor-models.html#cb508-138" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Value <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Size_Ranks, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-139"><a href="factor-models.html#cb508-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Value =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb508-140"><a href="factor-models.html#cb508-140" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Value =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-141"><a href="factor-models.html#cb508-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Value_Ranks, EW_Ret_mean_t_Size_Value,EW_Ret_sd_t_Size_Value) <span class="sc">%&gt;%</span> </span>
<span id="cb508-142"><a href="factor-models.html#cb508-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-143"><a href="factor-models.html#cb508-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-144"><a href="factor-models.html#cb508-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-145"><a href="factor-models.html#cb508-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-146"><a href="factor-models.html#cb508-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Large_Value =</span> <span class="fu">ifelse</span>(Size_Ranks <span class="sc">==</span> <span class="dv">2</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value), <span class="dv">0</span>),</span>
<span id="cb508-147"><a href="factor-models.html#cb508-147" aria-hidden="true" tabindex="-1"></a>         <span class="at">Small_Value =</span> <span class="fu">ifelse</span>(Size_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-148"><a href="factor-models.html#cb508-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-149"><a href="factor-models.html#cb508-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Large_Value, Small_Value) <span class="sc">%&gt;%</span> </span>
<span id="cb508-150"><a href="factor-models.html#cb508-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-151"><a href="factor-models.html#cb508-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb508-152"><a href="factor-models.html#cb508-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SMB_BM =</span> <span class="fu">sum</span>(Large_Value) <span class="sc">-</span> <span class="fu">sum</span>(Small_Value)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-153"><a href="factor-models.html#cb508-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, SMB_BM) <span class="sc">%&gt;%</span> </span>
<span id="cb508-154"><a href="factor-models.html#cb508-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb508-155"><a href="factor-models.html#cb508-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-156"><a href="factor-models.html#cb508-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Operating Profitability</span></span>
<span id="cb508-157"><a href="factor-models.html#cb508-157" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Profit <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Size_Ranks, Profit_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-158"><a href="factor-models.html#cb508-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Profit =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb508-159"><a href="factor-models.html#cb508-159" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Profit =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-160"><a href="factor-models.html#cb508-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Profit_Ranks, EW_Ret_mean_t_Size_Profit,EW_Ret_sd_t_Size_Profit) <span class="sc">%&gt;%</span> </span>
<span id="cb508-161"><a href="factor-models.html#cb508-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-162"><a href="factor-models.html#cb508-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-163"><a href="factor-models.html#cb508-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Profit_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-164"><a href="factor-models.html#cb508-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-165"><a href="factor-models.html#cb508-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Large_OP =</span> <span class="fu">ifelse</span>(Size_Ranks <span class="sc">==</span> <span class="dv">2</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Profit), <span class="dv">0</span>),</span>
<span id="cb508-166"><a href="factor-models.html#cb508-166" aria-hidden="true" tabindex="-1"></a>         <span class="at">Small_OP =</span> <span class="fu">ifelse</span>(Size_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Profit), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-167"><a href="factor-models.html#cb508-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-168"><a href="factor-models.html#cb508-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Large_OP, Small_OP) <span class="sc">%&gt;%</span> </span>
<span id="cb508-169"><a href="factor-models.html#cb508-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-170"><a href="factor-models.html#cb508-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb508-171"><a href="factor-models.html#cb508-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SMB_OP =</span> <span class="fu">sum</span>(Large_OP) <span class="sc">-</span> <span class="fu">sum</span>(Small_OP)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-172"><a href="factor-models.html#cb508-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, SMB_OP) <span class="sc">%&gt;%</span> </span>
<span id="cb508-173"><a href="factor-models.html#cb508-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb508-174"><a href="factor-models.html#cb508-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-175"><a href="factor-models.html#cb508-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Investment Growth</span></span>
<span id="cb508-176"><a href="factor-models.html#cb508-176" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Invest <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Size_Ranks, Invest_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-177"><a href="factor-models.html#cb508-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Invest =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb508-178"><a href="factor-models.html#cb508-178" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Invest =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-179"><a href="factor-models.html#cb508-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Invest_Ranks, EW_Ret_mean_t_Size_Invest,EW_Ret_sd_t_Size_Invest) <span class="sc">%&gt;%</span> </span>
<span id="cb508-180"><a href="factor-models.html#cb508-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-181"><a href="factor-models.html#cb508-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-182"><a href="factor-models.html#cb508-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Invest_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-183"><a href="factor-models.html#cb508-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb508-184"><a href="factor-models.html#cb508-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Large_INV =</span> <span class="fu">ifelse</span>(Size_Ranks <span class="sc">==</span> <span class="dv">2</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Invest), <span class="dv">0</span>),</span>
<span id="cb508-185"><a href="factor-models.html#cb508-185" aria-hidden="true" tabindex="-1"></a>         <span class="at">Small_INV =</span> <span class="fu">ifelse</span>(Size_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Invest), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-186"><a href="factor-models.html#cb508-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-187"><a href="factor-models.html#cb508-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Large_INV, Small_INV) <span class="sc">%&gt;%</span> </span>
<span id="cb508-188"><a href="factor-models.html#cb508-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb508-189"><a href="factor-models.html#cb508-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb508-190"><a href="factor-models.html#cb508-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SMB_INV =</span> <span class="fu">sum</span>(Large_INV) <span class="sc">-</span> <span class="fu">sum</span>(Small_INV)) <span class="sc">%&gt;%</span> </span>
<span id="cb508-191"><a href="factor-models.html#cb508-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, SMB_INV) <span class="sc">%&gt;%</span> </span>
<span id="cb508-192"><a href="factor-models.html#cb508-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb508-193"><a href="factor-models.html#cb508-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-194"><a href="factor-models.html#cb508-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the three individual factors </span></span>
<span id="cb508-195"><a href="factor-models.html#cb508-195" aria-hidden="true" tabindex="-1"></a><span class="do">## Create three xts objects</span></span>
<span id="cb508-196"><a href="factor-models.html#cb508-196" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_Value_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_Size_Value[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_Size_Value<span class="sc">$</span>Date_t))</span>
<span id="cb508-197"><a href="factor-models.html#cb508-197" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_Profit_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_Size_Profit[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_Size_Profit<span class="sc">$</span>Date_t))</span>
<span id="cb508-198"><a href="factor-models.html#cb508-198" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_Invest_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_Size_Invest[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_Size_Invest<span class="sc">$</span>Date_t))</span>
<span id="cb508-199"><a href="factor-models.html#cb508-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-200"><a href="factor-models.html#cb508-200" aria-hidden="true" tabindex="-1"></a>SMB <span class="ot">&lt;-</span> <span class="fu">merge.xts</span>(CH_data_EW_Ret_Size_Value_ts, CH_data_EW_Ret_Size_Profit_ts, CH_data_EW_Ret_Size_Invest_ts)</span>
<span id="cb508-201"><a href="factor-models.html#cb508-201" aria-hidden="true" tabindex="-1"></a>SMB<span class="sc">$</span>SMB <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(SMB, <span class="at">na.rm =</span> T)</span>
<span id="cb508-202"><a href="factor-models.html#cb508-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-203"><a href="factor-models.html#cb508-203" aria-hidden="true" tabindex="-1"></a><span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">na.omit</span>(SMB[<span class="st">&quot;1991-02-28/2020-12-31&quot;</span>])) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>index ,<span class="at">y =</span> value ,<span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb508-204"><a href="factor-models.html#cb508-204" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>( <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb508-205"><a href="factor-models.html#cb508-205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Size Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb508-206"><a href="factor-models.html#cb508-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb508-207"><a href="factor-models.html#cb508-207" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb508-208"><a href="factor-models.html#cb508-208" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb508-209"><a href="factor-models.html#cb508-209" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb508-210"><a href="factor-models.html#cb508-210" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb508-211"><a href="factor-models.html#cb508-211" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb508-212"><a href="factor-models.html#cb508-212" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb508-213"><a href="factor-models.html#cb508-213" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb508-214"><a href="factor-models.html#cb508-214" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb508-215"><a href="factor-models.html#cb508-215" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-286-1.png" width="672" /></p>
<p>As we can see, the SMB factor has declining cumulative returns throughout time, implying that there appears to be no market anomaly related to this specific factor.</p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb509"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb509-1"><a href="factor-models.html#cb509-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the three performance metrics</span></span>
<span id="cb509-2"><a href="factor-models.html#cb509-2" aria-hidden="true" tabindex="-1"></a>Annualised_Mean_Return <span class="ot">&lt;-</span> <span class="fu">Return.annualized</span>(SMB)</span>
<span id="cb509-3"><a href="factor-models.html#cb509-3" aria-hidden="true" tabindex="-1"></a>Annualised_SD <span class="ot">&lt;-</span> <span class="fu">sd.annualized</span>(SMB)</span>
<span id="cb509-4"><a href="factor-models.html#cb509-4" aria-hidden="true" tabindex="-1"></a>Sharpe_Ratio <span class="ot">&lt;-</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD</span>
<span id="cb509-5"><a href="factor-models.html#cb509-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb509-6"><a href="factor-models.html#cb509-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Put it together </span></span>
<span id="cb509-7"><a href="factor-models.html#cb509-7" aria-hidden="true" tabindex="-1"></a>df_SMB <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio))</span>
<span id="cb509-8"><a href="factor-models.html#cb509-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(df_SMB) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Annualised Return&quot;</span>, <span class="st">&quot;Standard Deviation&quot;</span>, <span class="st">&quot;Sharpe Ratio&quot;</span>)</span>
<span id="cb509-9"><a href="factor-models.html#cb509-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb509-10"><a href="factor-models.html#cb509-10" aria-hidden="true" tabindex="-1"></a>df_SMB</span></code></pre></div>
<pre><code>##                         SMB_BM      SMB_OP     SMB_INV         SMB
## Annualised Return  -0.03587035 -0.05180128 -0.05900121 -0.04904802
## Standard Deviation  0.11646017  0.10833291  0.11875724  0.10969154
## Sharpe Ratio       -0.30800529 -0.47816754 -0.49682205 -0.44714498</code></pre>
</div>
<div id="high-minus-low-robust-minus-weak-and-conservative-minus-aggressive" class="section level4" number="8.5.5.2">
<h4><span class="header-section-number">8.5.5.2</span> High Minus Low, Robust Minus Weak and Conservative Minus Aggressive</h4>
<p>Having created the SMB factor, let’s now replicate the HML, RMW as well as CMA factors. We will follow the same approach as Fama and French here again.</p>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb511-1"><a href="factor-models.html#cb511-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the old dataset for book value</span></span>
<span id="cb511-2"><a href="factor-models.html#cb511-2" aria-hidden="true" tabindex="-1"></a>Book <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_02.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb511-3"><a href="factor-models.html#cb511-3" aria-hidden="true" tabindex="-1"></a>Book_check <span class="ot">&lt;-</span> Book <span class="sc">%&gt;%</span></span>
<span id="cb511-4"><a href="factor-models.html#cb511-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(Ticker,value,NESN<span class="sc">:</span>X692395) <span class="sc">%&gt;%</span> </span>
<span id="cb511-5"><a href="factor-models.html#cb511-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_t =</span> lubridate<span class="sc">::</span><span class="fu">ceiling_date</span>(<span class="fu">dmy</span>(Date), <span class="st">&quot;month&quot;</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb511-6"><a href="factor-models.html#cb511-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Date)</span>
<span id="cb511-7"><a href="factor-models.html#cb511-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-8"><a href="factor-models.html#cb511-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Book_check) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Total_Eq_Real&quot;</span>, <span class="st">&quot;Date_t&quot;</span>)</span>
<span id="cb511-9"><a href="factor-models.html#cb511-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-10"><a href="factor-models.html#cb511-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Only sub select the companies under consideration</span></span>
<span id="cb511-11"><a href="factor-models.html#cb511-11" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb511-12"><a href="factor-models.html#cb511-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-13"><a href="factor-models.html#cb511-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb511-14"><a href="factor-models.html#cb511-14" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb511-15"><a href="factor-models.html#cb511-15" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb511-16"><a href="factor-models.html#cb511-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-17"><a href="factor-models.html#cb511-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb511-18"><a href="factor-models.html#cb511-18" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb511-19"><a href="factor-models.html#cb511-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb511-20"><a href="factor-models.html#cb511-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Close, Num_Shares, Total_Eq_t, Gross_Inc_t, Operating_Exp_t, Interest_Exp_t, Total_Assets_t, Total_Liab_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-21"><a href="factor-models.html#cb511-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Total_Eq_t =</span> Total_Assets_t <span class="sc">-</span> Total_Liab_t,</span>
<span id="cb511-22"><a href="factor-models.html#cb511-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Num_Shares =</span> Num_Shares, </span>
<span id="cb511-23"><a href="factor-models.html#cb511-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-24"><a href="factor-models.html#cb511-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb511-25"><a href="factor-models.html#cb511-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Close =</span> <span class="fu">lag</span>(Close, <span class="at">n=</span><span class="dv">1</span>),</span>
<span id="cb511-26"><a href="factor-models.html#cb511-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">Num_Shares =</span> <span class="fu">lag</span>(Num_Shares, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-27"><a href="factor-models.html#cb511-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb511-28"><a href="factor-models.html#cb511-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-29"><a href="factor-models.html#cb511-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-30"><a href="factor-models.html#cb511-30" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont_check <span class="ot">&lt;-</span> <span class="fu">left_join</span>(CH_data_total_mont, Book_check, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span> <span class="ot">=</span> <span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Date_t&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>))</span>
<span id="cb511-31"><a href="factor-models.html#cb511-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-32"><a href="factor-models.html#cb511-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb511-33"><a href="factor-models.html#cb511-33" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Size <span class="ot">&lt;-</span> CH_data_total_mont_check <span class="sc">%&gt;%</span> </span>
<span id="cb511-34"><a href="factor-models.html#cb511-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb511-35"><a href="factor-models.html#cb511-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb511-36"><a href="factor-models.html#cb511-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-37"><a href="factor-models.html#cb511-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-38"><a href="factor-models.html#cb511-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-39"><a href="factor-models.html#cb511-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-40"><a href="factor-models.html#cb511-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="dv">1</span>), </span>
<span id="cb511-41"><a href="factor-models.html#cb511-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb511-42"><a href="factor-models.html#cb511-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb511-43"><a href="factor-models.html#cb511-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb511-44"><a href="factor-models.html#cb511-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-45"><a href="factor-models.html#cb511-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Value</span></span>
<span id="cb511-46"><a href="factor-models.html#cb511-46" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb511-47"><a href="factor-models.html#cb511-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb511-48"><a href="factor-models.html#cb511-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb511-49"><a href="factor-models.html#cb511-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb511-50"><a href="factor-models.html#cb511-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb511-51"><a href="factor-models.html#cb511-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb511-52"><a href="factor-models.html#cb511-52" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb511-53"><a href="factor-models.html#cb511-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">Total_Eq_t =</span> Total_Assets_t <span class="sc">-</span> Total_Liab_t,</span>
<span id="cb511-54"><a href="factor-models.html#cb511-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">B2M =</span> <span class="fu">lag</span>(Total_Eq_t, <span class="at">n =</span> <span class="dv">6</span>) <span class="sc">/</span> Market_Cap) <span class="sc">%&gt;%</span> </span>
<span id="cb511-55"><a href="factor-models.html#cb511-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-56"><a href="factor-models.html#cb511-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb511-57"><a href="factor-models.html#cb511-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-58"><a href="factor-models.html#cb511-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and old Value</span></span>
<span id="cb511-59"><a href="factor-models.html#cb511-59" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Value_old <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb511-60"><a href="factor-models.html#cb511-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb511-61"><a href="factor-models.html#cb511-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb511-62"><a href="factor-models.html#cb511-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb511-63"><a href="factor-models.html#cb511-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb511-64"><a href="factor-models.html#cb511-64" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb511-65"><a href="factor-models.html#cb511-65" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb511-66"><a href="factor-models.html#cb511-66" aria-hidden="true" tabindex="-1"></a>         <span class="at">B2M_old =</span> <span class="fu">lag</span>(Total_Eq_Real, <span class="at">n =</span> <span class="dv">6</span>) <span class="sc">/</span> Market_Cap) <span class="sc">%&gt;%</span> </span>
<span id="cb511-67"><a href="factor-models.html#cb511-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-68"><a href="factor-models.html#cb511-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb511-69"><a href="factor-models.html#cb511-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-70"><a href="factor-models.html#cb511-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Operating Profitability</span></span>
<span id="cb511-71"><a href="factor-models.html#cb511-71" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb511-72"><a href="factor-models.html#cb511-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb511-73"><a href="factor-models.html#cb511-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb511-74"><a href="factor-models.html#cb511-74" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb511-75"><a href="factor-models.html#cb511-75" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb511-76"><a href="factor-models.html#cb511-76" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb511-77"><a href="factor-models.html#cb511-77" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb511-78"><a href="factor-models.html#cb511-78" aria-hidden="true" tabindex="-1"></a>         <span class="at">Profit_lead =</span> (Gross_Inc_t <span class="sc">-</span> Operating_Exp_t <span class="sc">-</span> Interest_Exp_t)<span class="sc">/</span>Total_Eq_t,</span>
<span id="cb511-79"><a href="factor-models.html#cb511-79" aria-hidden="true" tabindex="-1"></a>         <span class="at">Profit =</span> <span class="fu">lag</span>(Profit_lead, <span class="at">n =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-80"><a href="factor-models.html#cb511-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-81"><a href="factor-models.html#cb511-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb511-82"><a href="factor-models.html#cb511-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-83"><a href="factor-models.html#cb511-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Investment Growth</span></span>
<span id="cb511-84"><a href="factor-models.html#cb511-84" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb511-85"><a href="factor-models.html#cb511-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb511-86"><a href="factor-models.html#cb511-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb511-87"><a href="factor-models.html#cb511-87" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb511-88"><a href="factor-models.html#cb511-88" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb511-89"><a href="factor-models.html#cb511-89" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb511-90"><a href="factor-models.html#cb511-90" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb511-91"><a href="factor-models.html#cb511-91" aria-hidden="true" tabindex="-1"></a>         <span class="at">Invest_lead =</span> (<span class="fu">lag</span>(Total_Assets_t, <span class="at">n =</span><span class="dv">1</span>) <span class="sc">-</span> <span class="fu">lag</span>(Total_Assets_t, <span class="at">n =</span> <span class="dv">12</span>))<span class="sc">/</span><span class="fu">lag</span>(Total_Assets_t, <span class="at">n =</span> <span class="dv">12</span>),</span>
<span id="cb511-92"><a href="factor-models.html#cb511-92" aria-hidden="true" tabindex="-1"></a>         <span class="at">Invest =</span> <span class="fu">lag</span>(Invest_lead, <span class="at">n =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-93"><a href="factor-models.html#cb511-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-94"><a href="factor-models.html#cb511-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb511-95"><a href="factor-models.html#cb511-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-96"><a href="factor-models.html#cb511-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Value</span></span>
<span id="cb511-97"><a href="factor-models.html#cb511-97" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Value <span class="sc">%&gt;%</span> </span>
<span id="cb511-98"><a href="factor-models.html#cb511-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-99"><a href="factor-models.html#cb511-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb511-100"><a href="factor-models.html#cb511-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb511-101"><a href="factor-models.html#cb511-101" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb511-102"><a href="factor-models.html#cb511-102" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb511-103"><a href="factor-models.html#cb511-103" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb511-104"><a href="factor-models.html#cb511-104" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb511-105"><a href="factor-models.html#cb511-105" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb511-106"><a href="factor-models.html#cb511-106" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb511-107"><a href="factor-models.html#cb511-107" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on B2M (Low, Neutral, High)</span></span>
<span id="cb511-108"><a href="factor-models.html#cb511-108" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(B2M, </span>
<span id="cb511-109"><a href="factor-models.html#cb511-109" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(B2M, </span>
<span id="cb511-110"><a href="factor-models.html#cb511-110" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb511-111"><a href="factor-models.html#cb511-111" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb511-112"><a href="factor-models.html#cb511-112" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb511-113"><a href="factor-models.html#cb511-113" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb511-114"><a href="factor-models.html#cb511-114" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb511-115"><a href="factor-models.html#cb511-115" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb511-116"><a href="factor-models.html#cb511-116" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb511-117"><a href="factor-models.html#cb511-117" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb511-118"><a href="factor-models.html#cb511-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb511-119"><a href="factor-models.html#cb511-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-120"><a href="factor-models.html#cb511-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Old Value</span></span>
<span id="cb511-121"><a href="factor-models.html#cb511-121" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Value_old <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Value_old <span class="sc">%&gt;%</span> </span>
<span id="cb511-122"><a href="factor-models.html#cb511-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-123"><a href="factor-models.html#cb511-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb511-124"><a href="factor-models.html#cb511-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb511-125"><a href="factor-models.html#cb511-125" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb511-126"><a href="factor-models.html#cb511-126" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb511-127"><a href="factor-models.html#cb511-127" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb511-128"><a href="factor-models.html#cb511-128" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb511-129"><a href="factor-models.html#cb511-129" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb511-130"><a href="factor-models.html#cb511-130" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb511-131"><a href="factor-models.html#cb511-131" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on B2M (Low, Neutral, High)</span></span>
<span id="cb511-132"><a href="factor-models.html#cb511-132" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(B2M_old, </span>
<span id="cb511-133"><a href="factor-models.html#cb511-133" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(B2M_old, </span>
<span id="cb511-134"><a href="factor-models.html#cb511-134" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb511-135"><a href="factor-models.html#cb511-135" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb511-136"><a href="factor-models.html#cb511-136" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb511-137"><a href="factor-models.html#cb511-137" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb511-138"><a href="factor-models.html#cb511-138" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value_old_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb511-139"><a href="factor-models.html#cb511-139" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb511-140"><a href="factor-models.html#cb511-140" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb511-141"><a href="factor-models.html#cb511-141" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb511-142"><a href="factor-models.html#cb511-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb511-143"><a href="factor-models.html#cb511-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-144"><a href="factor-models.html#cb511-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Operating Profitability</span></span>
<span id="cb511-145"><a href="factor-models.html#cb511-145" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Profit <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Profit <span class="sc">%&gt;%</span> </span>
<span id="cb511-146"><a href="factor-models.html#cb511-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-147"><a href="factor-models.html#cb511-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb511-148"><a href="factor-models.html#cb511-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb511-149"><a href="factor-models.html#cb511-149" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb511-150"><a href="factor-models.html#cb511-150" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb511-151"><a href="factor-models.html#cb511-151" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb511-152"><a href="factor-models.html#cb511-152" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb511-153"><a href="factor-models.html#cb511-153" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb511-154"><a href="factor-models.html#cb511-154" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb511-155"><a href="factor-models.html#cb511-155" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on Oper Profit (Low, Neutral, High)</span></span>
<span id="cb511-156"><a href="factor-models.html#cb511-156" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Profit, </span>
<span id="cb511-157"><a href="factor-models.html#cb511-157" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Profit, </span>
<span id="cb511-158"><a href="factor-models.html#cb511-158" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb511-159"><a href="factor-models.html#cb511-159" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb511-160"><a href="factor-models.html#cb511-160" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb511-161"><a href="factor-models.html#cb511-161" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb511-162"><a href="factor-models.html#cb511-162" aria-hidden="true" tabindex="-1"></a>         <span class="at">Profit_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb511-163"><a href="factor-models.html#cb511-163" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb511-164"><a href="factor-models.html#cb511-164" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb511-165"><a href="factor-models.html#cb511-165" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb511-166"><a href="factor-models.html#cb511-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb511-167"><a href="factor-models.html#cb511-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-168"><a href="factor-models.html#cb511-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Investment Growth</span></span>
<span id="cb511-169"><a href="factor-models.html#cb511-169" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Invest <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Invest <span class="sc">%&gt;%</span> </span>
<span id="cb511-170"><a href="factor-models.html#cb511-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-171"><a href="factor-models.html#cb511-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb511-172"><a href="factor-models.html#cb511-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb511-173"><a href="factor-models.html#cb511-173" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb511-174"><a href="factor-models.html#cb511-174" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb511-175"><a href="factor-models.html#cb511-175" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb511-176"><a href="factor-models.html#cb511-176" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb511-177"><a href="factor-models.html#cb511-177" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb511-178"><a href="factor-models.html#cb511-178" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb511-179"><a href="factor-models.html#cb511-179" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on Investment Growth (Low, Neutral, High)</span></span>
<span id="cb511-180"><a href="factor-models.html#cb511-180" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">ntile</span>(Total_Assets_t, <span class="dv">10</span>),</span>
<span id="cb511-181"><a href="factor-models.html#cb511-181" aria-hidden="true" tabindex="-1"></a>         <span class="at">Invest_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb511-182"><a href="factor-models.html#cb511-182" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb511-183"><a href="factor-models.html#cb511-183" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb511-184"><a href="factor-models.html#cb511-184" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb511-185"><a href="factor-models.html#cb511-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb511-186"><a href="factor-models.html#cb511-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-187"><a href="factor-models.html#cb511-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-188"><a href="factor-models.html#cb511-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Value</span></span>
<span id="cb511-189"><a href="factor-models.html#cb511-189" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Value <span class="sc">%&gt;%</span> </span>
<span id="cb511-190"><a href="factor-models.html#cb511-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-191"><a href="factor-models.html#cb511-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Value =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb511-192"><a href="factor-models.html#cb511-192" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Value =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-193"><a href="factor-models.html#cb511-193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Value_Ranks, EW_Ret_mean_t_Size_Value,EW_Ret_sd_t_Size_Value) <span class="sc">%&gt;%</span> </span>
<span id="cb511-194"><a href="factor-models.html#cb511-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-195"><a href="factor-models.html#cb511-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-196"><a href="factor-models.html#cb511-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-197"><a href="factor-models.html#cb511-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-198"><a href="factor-models.html#cb511-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">High_Size =</span> <span class="fu">ifelse</span>(Value_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value), <span class="dv">0</span>),</span>
<span id="cb511-199"><a href="factor-models.html#cb511-199" aria-hidden="true" tabindex="-1"></a>         <span class="at">Low_Size =</span> <span class="fu">ifelse</span>(Value_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-200"><a href="factor-models.html#cb511-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-201"><a href="factor-models.html#cb511-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, High_Size, Low_Size) <span class="sc">%&gt;%</span> </span>
<span id="cb511-202"><a href="factor-models.html#cb511-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-203"><a href="factor-models.html#cb511-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-204"><a href="factor-models.html#cb511-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HML =</span> <span class="fu">sum</span>(High_Size) <span class="sc">-</span> <span class="fu">sum</span>(Low_Size)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-205"><a href="factor-models.html#cb511-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, HML) <span class="sc">%&gt;%</span> </span>
<span id="cb511-206"><a href="factor-models.html#cb511-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb511-207"><a href="factor-models.html#cb511-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-208"><a href="factor-models.html#cb511-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Old Value</span></span>
<span id="cb511-209"><a href="factor-models.html#cb511-209" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML_old <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Value_old <span class="sc">%&gt;%</span> </span>
<span id="cb511-210"><a href="factor-models.html#cb511-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks, Value_old_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-211"><a href="factor-models.html#cb511-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Value_old =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb511-212"><a href="factor-models.html#cb511-212" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Value_old =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-213"><a href="factor-models.html#cb511-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Value_old_Ranks, EW_Ret_mean_t_Size_Value_old,EW_Ret_sd_t_Size_Value_old) <span class="sc">%&gt;%</span> </span>
<span id="cb511-214"><a href="factor-models.html#cb511-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-215"><a href="factor-models.html#cb511-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-216"><a href="factor-models.html#cb511-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Value_old_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-217"><a href="factor-models.html#cb511-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Value_old_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-218"><a href="factor-models.html#cb511-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">High_Size =</span> <span class="fu">ifelse</span>(Value_old_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value_old), <span class="dv">0</span>),</span>
<span id="cb511-219"><a href="factor-models.html#cb511-219" aria-hidden="true" tabindex="-1"></a>         <span class="at">Low_Size =</span> <span class="fu">ifelse</span>(Value_old_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value_old), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-220"><a href="factor-models.html#cb511-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-221"><a href="factor-models.html#cb511-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, High_Size, Low_Size) <span class="sc">%&gt;%</span> </span>
<span id="cb511-222"><a href="factor-models.html#cb511-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-223"><a href="factor-models.html#cb511-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-224"><a href="factor-models.html#cb511-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HML_old =</span> <span class="fu">sum</span>(High_Size) <span class="sc">-</span> <span class="fu">sum</span>(Low_Size)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-225"><a href="factor-models.html#cb511-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, HML_old) <span class="sc">%&gt;%</span> </span>
<span id="cb511-226"><a href="factor-models.html#cb511-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb511-227"><a href="factor-models.html#cb511-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-228"><a href="factor-models.html#cb511-228" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Operating Profitability</span></span>
<span id="cb511-229"><a href="factor-models.html#cb511-229" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_RMW <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Profit <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Size_Ranks, Profit_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-230"><a href="factor-models.html#cb511-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Profit =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb511-231"><a href="factor-models.html#cb511-231" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Profit =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-232"><a href="factor-models.html#cb511-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Profit_Ranks, EW_Ret_mean_t_Size_Profit,EW_Ret_sd_t_Size_Profit) <span class="sc">%&gt;%</span> </span>
<span id="cb511-233"><a href="factor-models.html#cb511-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-234"><a href="factor-models.html#cb511-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-235"><a href="factor-models.html#cb511-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Profit_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-236"><a href="factor-models.html#cb511-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Profit_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-237"><a href="factor-models.html#cb511-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Robust_Size =</span> <span class="fu">ifelse</span>(Profit_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Profit), <span class="dv">0</span>),</span>
<span id="cb511-238"><a href="factor-models.html#cb511-238" aria-hidden="true" tabindex="-1"></a>         <span class="at">Weak_Size =</span> <span class="fu">ifelse</span>(Profit_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Profit), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-239"><a href="factor-models.html#cb511-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-240"><a href="factor-models.html#cb511-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Robust_Size, Weak_Size) <span class="sc">%&gt;%</span> </span>
<span id="cb511-241"><a href="factor-models.html#cb511-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-242"><a href="factor-models.html#cb511-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-243"><a href="factor-models.html#cb511-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RMW =</span> <span class="fu">sum</span>(Robust_Size) <span class="sc">-</span> <span class="fu">sum</span>(Weak_Size)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-244"><a href="factor-models.html#cb511-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, RMW) <span class="sc">%&gt;%</span> </span>
<span id="cb511-245"><a href="factor-models.html#cb511-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb511-246"><a href="factor-models.html#cb511-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-247"><a href="factor-models.html#cb511-247" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Investment Growth</span></span>
<span id="cb511-248"><a href="factor-models.html#cb511-248" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_CMA <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Invest <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Date_t, Size_Ranks, Invest_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-249"><a href="factor-models.html#cb511-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Invest =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb511-250"><a href="factor-models.html#cb511-250" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Invest =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-251"><a href="factor-models.html#cb511-251" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Invest_Ranks, EW_Ret_mean_t_Size_Invest,EW_Ret_sd_t_Size_Invest) <span class="sc">%&gt;%</span> </span>
<span id="cb511-252"><a href="factor-models.html#cb511-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-253"><a href="factor-models.html#cb511-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-254"><a href="factor-models.html#cb511-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Invest_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-255"><a href="factor-models.html#cb511-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Invest_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-256"><a href="factor-models.html#cb511-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Aggressive_Ranks =</span> <span class="fu">ifelse</span>(Invest_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Invest), <span class="dv">0</span>),</span>
<span id="cb511-257"><a href="factor-models.html#cb511-257" aria-hidden="true" tabindex="-1"></a>         <span class="at">Conservative_Ranks =</span> <span class="fu">ifelse</span>(Invest_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Invest), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-258"><a href="factor-models.html#cb511-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-259"><a href="factor-models.html#cb511-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Aggressive_Ranks, Conservative_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb511-260"><a href="factor-models.html#cb511-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb511-261"><a href="factor-models.html#cb511-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb511-262"><a href="factor-models.html#cb511-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CMA =</span> <span class="fu">sum</span>(Conservative_Ranks) <span class="sc">-</span> <span class="fu">sum</span>(Aggressive_Ranks)) <span class="sc">%&gt;%</span> </span>
<span id="cb511-263"><a href="factor-models.html#cb511-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, CMA) <span class="sc">%&gt;%</span> </span>
<span id="cb511-264"><a href="factor-models.html#cb511-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb511-265"><a href="factor-models.html#cb511-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-266"><a href="factor-models.html#cb511-266" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the three individual factors </span></span>
<span id="cb511-267"><a href="factor-models.html#cb511-267" aria-hidden="true" tabindex="-1"></a><span class="do">## Create three xts objects</span></span>
<span id="cb511-268"><a href="factor-models.html#cb511-268" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_HML[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_HML<span class="sc">$</span>Date_t))</span>
<span id="cb511-269"><a href="factor-models.html#cb511-269" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML_old_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_HML_old[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_HML_old<span class="sc">$</span>Date_t))</span>
<span id="cb511-270"><a href="factor-models.html#cb511-270" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_RMW_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_Size_RMW[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_Size_RMW<span class="sc">$</span>Date_t))</span>
<span id="cb511-271"><a href="factor-models.html#cb511-271" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Size_CMA_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_CMA[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_CMA<span class="sc">$</span>Date_t))</span>
<span id="cb511-272"><a href="factor-models.html#cb511-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-273"><a href="factor-models.html#cb511-273" aria-hidden="true" tabindex="-1"></a>Factors <span class="ot">&lt;-</span> <span class="fu">merge.xts</span>(SMB<span class="sc">$</span>SMB, CH_data_EW_Ret_HML_ts, CH_data_EW_Ret_Size_RMW_ts, CH_data_EW_Ret_Size_CMA_ts)</span>
<span id="cb511-274"><a href="factor-models.html#cb511-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-275"><a href="factor-models.html#cb511-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-276"><a href="factor-models.html#cb511-276" aria-hidden="true" tabindex="-1"></a><span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">na.omit</span>(Factors[<span class="st">&quot;1991-02-28/2020-12-31&quot;</span>])) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>index ,<span class="at">y =</span> value ,<span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb511-277"><a href="factor-models.html#cb511-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>( <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb511-278"><a href="factor-models.html#cb511-278" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Size, Value, Profitability and Investment Growth Strategy&quot;</span>) <span class="sc">+</span> </span>
<span id="cb511-279"><a href="factor-models.html#cb511-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb511-280"><a href="factor-models.html#cb511-280" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb511-281"><a href="factor-models.html#cb511-281" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb511-282"><a href="factor-models.html#cb511-282" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb511-283"><a href="factor-models.html#cb511-283" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb511-284"><a href="factor-models.html#cb511-284" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb511-285"><a href="factor-models.html#cb511-285" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb511-286"><a href="factor-models.html#cb511-286" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb511-287"><a href="factor-models.html#cb511-287" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb511-288"><a href="factor-models.html#cb511-288" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-288-1.png" width="672" /></p>
<p>As we can see, the Profitability factor appears to be the strongest anomaly of the factors under consideration. The value factor also shows significant, positive, albeit less pronounced, returns for the period under consideration. On the other hand, both the Investment as well as the size factor appear to be no material anomaly in the Swiss market from the observational time horizon.</p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb512-1"><a href="factor-models.html#cb512-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the three performance metrics</span></span>
<span id="cb512-2"><a href="factor-models.html#cb512-2" aria-hidden="true" tabindex="-1"></a>Annualised_Mean_Return <span class="ot">&lt;-</span> <span class="fu">Return.annualized</span>(Factors)</span>
<span id="cb512-3"><a href="factor-models.html#cb512-3" aria-hidden="true" tabindex="-1"></a>Annualised_SD <span class="ot">&lt;-</span> <span class="fu">sd.annualized</span>(Factors)</span>
<span id="cb512-4"><a href="factor-models.html#cb512-4" aria-hidden="true" tabindex="-1"></a>Sharpe_Ratio <span class="ot">&lt;-</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD</span>
<span id="cb512-5"><a href="factor-models.html#cb512-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb512-6"><a href="factor-models.html#cb512-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Put it together </span></span>
<span id="cb512-7"><a href="factor-models.html#cb512-7" aria-hidden="true" tabindex="-1"></a>df_factors <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio))</span>
<span id="cb512-8"><a href="factor-models.html#cb512-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(df_factors) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Annualised Return&quot;</span>, <span class="st">&quot;Standard Deviation&quot;</span>, <span class="st">&quot;Sharpe Ratio&quot;</span>)</span>
<span id="cb512-9"><a href="factor-models.html#cb512-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb512-10"><a href="factor-models.html#cb512-10" aria-hidden="true" tabindex="-1"></a>df_factors</span></code></pre></div>
<pre><code>##                            SMB        HML        RMW         CMA
## Annualised Return  -0.04904802 0.03323681 0.05414061 -0.03316582
## Standard Deviation  0.10969154 0.12861379 0.10801873  0.19626799
## Sharpe Ratio       -0.44714498 0.25842341 0.50121499 -0.16898234</code></pre>
</div>
<div id="up-minus-down" class="section level4" number="8.5.5.3">
<h4><span class="header-section-number">8.5.5.3</span> Up Minus Down</h4>
<p>Lastly, we will show you the performance of the Momentum factor, or UMD. We will create the factor based on both the Jegadeesh and Titman (1995) approach (the original approach of their paper) as well as the more static approach used by Carharrt (1996).</p>
<p>We will first create the approach of Carharrt (1996).</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb514-1"><a href="factor-models.html#cb514-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the old datasets for check up</span></span>
<span id="cb514-2"><a href="factor-models.html#cb514-2" aria-hidden="true" tabindex="-1"></a>Prices_Adj <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_01.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb514-3"><a href="factor-models.html#cb514-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-4"><a href="factor-models.html#cb514-4" aria-hidden="true" tabindex="-1"></a>Prices_Unadj_check <span class="ot">&lt;-</span> Prices_Adj <span class="sc">%&gt;%</span></span>
<span id="cb514-5"><a href="factor-models.html#cb514-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(Ticker,value,NESN<span class="sc">:</span>X692395) <span class="sc">%&gt;%</span> </span>
<span id="cb514-6"><a href="factor-models.html#cb514-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_t =</span> lubridate<span class="sc">::</span><span class="fu">ceiling_date</span>(<span class="fu">dmy</span>(Date), <span class="st">&quot;month&quot;</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb514-7"><a href="factor-models.html#cb514-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Date)</span>
<span id="cb514-8"><a href="factor-models.html#cb514-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-9"><a href="factor-models.html#cb514-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Prices_Unadj_check) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Close_Real&quot;</span>, <span class="st">&quot;Date_t&quot;</span>)</span>
<span id="cb514-10"><a href="factor-models.html#cb514-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-11"><a href="factor-models.html#cb514-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get only selected companies</span></span>
<span id="cb514-12"><a href="factor-models.html#cb514-12" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb514-13"><a href="factor-models.html#cb514-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-14"><a href="factor-models.html#cb514-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb514-15"><a href="factor-models.html#cb514-15" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb514-16"><a href="factor-models.html#cb514-16" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb514-17"><a href="factor-models.html#cb514-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-18"><a href="factor-models.html#cb514-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb514-19"><a href="factor-models.html#cb514-19" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb514-20"><a href="factor-models.html#cb514-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb514-21"><a href="factor-models.html#cb514-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Close, Num_Shares, Total_Eq_t, Gross_Inc_t, Operating_Exp_t, Interest_Exp_t, Total_Assets_t) <span class="sc">%&gt;%</span> </span>
<span id="cb514-22"><a href="factor-models.html#cb514-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Total_Eq_t =</span> Total_Eq_t,</span>
<span id="cb514-23"><a href="factor-models.html#cb514-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">Num_Shares =</span> Num_Shares, </span>
<span id="cb514-24"><a href="factor-models.html#cb514-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t)) <span class="sc">%&gt;%</span> </span>
<span id="cb514-25"><a href="factor-models.html#cb514-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb514-26"><a href="factor-models.html#cb514-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Close =</span> <span class="fu">lag</span>(Close, <span class="at">n=</span><span class="dv">1</span>), </span>
<span id="cb514-27"><a href="factor-models.html#cb514-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">Total_Eq_t =</span> <span class="fu">lag</span>(Total_Eq_t, <span class="dv">1</span>), </span>
<span id="cb514-28"><a href="factor-models.html#cb514-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">Num_Shares =</span> <span class="fu">lag</span>(Num_Shares, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb514-29"><a href="factor-models.html#cb514-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb514-30"><a href="factor-models.html#cb514-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-31"><a href="factor-models.html#cb514-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-32"><a href="factor-models.html#cb514-32" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont_check <span class="ot">&lt;-</span> <span class="fu">left_join</span>(CH_data_total_mont, Prices_Unadj_check, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span> <span class="ot">=</span> <span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Date_t&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>))</span>
<span id="cb514-33"><a href="factor-models.html#cb514-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-34"><a href="factor-models.html#cb514-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb514-35"><a href="factor-models.html#cb514-35" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Size <span class="ot">&lt;-</span> CH_data_total_mont_check <span class="sc">%&gt;%</span> </span>
<span id="cb514-36"><a href="factor-models.html#cb514-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb514-37"><a href="factor-models.html#cb514-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb514-38"><a href="factor-models.html#cb514-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>),</span>
<span id="cb514-39"><a href="factor-models.html#cb514-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj_old =</span> (Close_Real <span class="sc">-</span> <span class="fu">lag</span>(Close_Real, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Close_Real,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb514-40"><a href="factor-models.html#cb514-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb514-41"><a href="factor-models.html#cb514-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb514-42"><a href="factor-models.html#cb514-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb514-43"><a href="factor-models.html#cb514-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="dv">1</span>), </span>
<span id="cb514-44"><a href="factor-models.html#cb514-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb514-45"><a href="factor-models.html#cb514-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb514-46"><a href="factor-models.html#cb514-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb514-47"><a href="factor-models.html#cb514-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-48"><a href="factor-models.html#cb514-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-49"><a href="factor-models.html#cb514-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Momentum</span></span>
<span id="cb514-50"><a href="factor-models.html#cb514-50" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Mom <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb514-51"><a href="factor-models.html#cb514-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb514-52"><a href="factor-models.html#cb514-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb514-53"><a href="factor-models.html#cb514-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb514-54"><a href="factor-models.html#cb514-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb514-55"><a href="factor-models.html#cb514-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb514-56"><a href="factor-models.html#cb514-56" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the Cumulative Returns (Momentum) characteristic</span></span>
<span id="cb514-57"><a href="factor-models.html#cb514-57" aria-hidden="true" tabindex="-1"></a>         <span class="at">Log_Ret_Adj =</span> <span class="fu">lag</span>(<span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span>Ret_Adj), <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb514-58"><a href="factor-models.html#cb514-58" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sum_Ret =</span> <span class="fu">roll_sum</span>(Log_Ret_Adj, <span class="dv">6</span>),</span>
<span id="cb514-59"><a href="factor-models.html#cb514-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">Cum_Ret =</span> <span class="fu">exp</span>(Sum_Ret) <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb514-60"><a href="factor-models.html#cb514-60" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb514-61"><a href="factor-models.html#cb514-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb514-62"><a href="factor-models.html#cb514-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb514-63"><a href="factor-models.html#cb514-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-64"><a href="factor-models.html#cb514-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Momentum</span></span>
<span id="cb514-65"><a href="factor-models.html#cb514-65" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Mom <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Mom <span class="sc">%&gt;%</span> </span>
<span id="cb514-66"><a href="factor-models.html#cb514-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb514-67"><a href="factor-models.html#cb514-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb514-68"><a href="factor-models.html#cb514-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb514-69"><a href="factor-models.html#cb514-69" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb514-70"><a href="factor-models.html#cb514-70" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb514-71"><a href="factor-models.html#cb514-71" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb514-72"><a href="factor-models.html#cb514-72" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb514-73"><a href="factor-models.html#cb514-73" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb514-74"><a href="factor-models.html#cb514-74" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb514-75"><a href="factor-models.html#cb514-75" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on B2M (Low, Neutral, High)</span></span>
<span id="cb514-76"><a href="factor-models.html#cb514-76" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Cum_Ret, </span>
<span id="cb514-77"><a href="factor-models.html#cb514-77" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Cum_Ret, </span>
<span id="cb514-78"><a href="factor-models.html#cb514-78" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb514-79"><a href="factor-models.html#cb514-79" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb514-80"><a href="factor-models.html#cb514-80" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb514-81"><a href="factor-models.html#cb514-81" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb514-82"><a href="factor-models.html#cb514-82" aria-hidden="true" tabindex="-1"></a>         <span class="at">Mom_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb514-83"><a href="factor-models.html#cb514-83" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb514-84"><a href="factor-models.html#cb514-84" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb514-85"><a href="factor-models.html#cb514-85" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb514-86"><a href="factor-models.html#cb514-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb514-87"><a href="factor-models.html#cb514-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-88"><a href="factor-models.html#cb514-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Momentum</span></span>
<span id="cb514-89"><a href="factor-models.html#cb514-89" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_Mom <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Mom <span class="sc">%&gt;%</span> </span>
<span id="cb514-90"><a href="factor-models.html#cb514-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks, Mom_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb514-91"><a href="factor-models.html#cb514-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Mom =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb514-92"><a href="factor-models.html#cb514-92" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Mom =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb514-93"><a href="factor-models.html#cb514-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Mom_Ranks, EW_Ret_mean_t_Size_Mom,EW_Ret_sd_t_Size_Mom) <span class="sc">%&gt;%</span> </span>
<span id="cb514-94"><a href="factor-models.html#cb514-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb514-95"><a href="factor-models.html#cb514-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb514-96"><a href="factor-models.html#cb514-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Mom_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb514-97"><a href="factor-models.html#cb514-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Mom_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb514-98"><a href="factor-models.html#cb514-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Up_Size =</span> <span class="fu">ifelse</span>(Mom_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Mom), <span class="dv">0</span>),</span>
<span id="cb514-99"><a href="factor-models.html#cb514-99" aria-hidden="true" tabindex="-1"></a>         <span class="at">Down_Size =</span> <span class="fu">ifelse</span>(Mom_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Mom), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb514-100"><a href="factor-models.html#cb514-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb514-101"><a href="factor-models.html#cb514-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Up_Size, Down_Size) <span class="sc">%&gt;%</span> </span>
<span id="cb514-102"><a href="factor-models.html#cb514-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb514-103"><a href="factor-models.html#cb514-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb514-104"><a href="factor-models.html#cb514-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">MOM =</span> <span class="fu">sum</span>(Up_Size) <span class="sc">-</span> <span class="fu">sum</span>(Down_Size)) <span class="sc">%&gt;%</span> </span>
<span id="cb514-105"><a href="factor-models.html#cb514-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, MOM) <span class="sc">%&gt;%</span> </span>
<span id="cb514-106"><a href="factor-models.html#cb514-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb514-107"><a href="factor-models.html#cb514-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-108"><a href="factor-models.html#cb514-108" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CH_data_EW_Ret_Mom) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Momentum_Car&quot;</span>)</span>
<span id="cb514-109"><a href="factor-models.html#cb514-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-110"><a href="factor-models.html#cb514-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the three individual factors </span></span>
<span id="cb514-111"><a href="factor-models.html#cb514-111" aria-hidden="true" tabindex="-1"></a><span class="do">## Create the xts objects</span></span>
<span id="cb514-112"><a href="factor-models.html#cb514-112" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_MOM_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_Mom[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_Mom<span class="sc">$</span>Date_t))</span></code></pre></div>
<p>Now, we will replicate the approach of Jegadeesh and Titman (1995).</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb515-1"><a href="factor-models.html#cb515-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb515-2"><a href="factor-models.html#cb515-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb515-3"><a href="factor-models.html#cb515-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb515-4"><a href="factor-models.html#cb515-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb515-5"><a href="factor-models.html#cb515-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb515-6"><a href="factor-models.html#cb515-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-7"><a href="factor-models.html#cb515-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb515-8"><a href="factor-models.html#cb515-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb515-9"><a href="factor-models.html#cb515-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb515-10"><a href="factor-models.html#cb515-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close,  Num_Shares, Close) <span class="sc">%&gt;%</span> </span>
<span id="cb515-11"><a href="factor-models.html#cb515-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t), </span>
<span id="cb515-12"><a href="factor-models.html#cb515-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_t =</span> <span class="fu">as.yearmon</span>(Date_t)) </span>
<span id="cb515-13"><a href="factor-models.html#cb515-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-14"><a href="factor-models.html#cb515-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb515-15"><a href="factor-models.html#cb515-15" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb515-16"><a href="factor-models.html#cb515-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb515-17"><a href="factor-models.html#cb515-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Num_Shares, Close) <span class="sc">%&gt;%</span> </span>
<span id="cb515-18"><a href="factor-models.html#cb515-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb515-19"><a href="factor-models.html#cb515-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb515-20"><a href="factor-models.html#cb515-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb515-21"><a href="factor-models.html#cb515-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb515-22"><a href="factor-models.html#cb515-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb515-23"><a href="factor-models.html#cb515-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="dv">1</span>), </span>
<span id="cb515-24"><a href="factor-models.html#cb515-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb515-25"><a href="factor-models.html#cb515-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb515-26"><a href="factor-models.html#cb515-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb515-27"><a href="factor-models.html#cb515-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-28"><a href="factor-models.html#cb515-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the lagged values to ensure that we have a HPR of 6 periods! </span></span>
<span id="cb515-29"><a href="factor-models.html#cb515-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we go 6 periods behind and take the cum ret from period -6 to period -1 to obtain the HPR from period -5 to 0. </span></span>
<span id="cb515-30"><a href="factor-models.html#cb515-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-31"><a href="factor-models.html#cb515-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Idea: If we do it like this, we account for gaps in the data. E.g. if two observational periods were on Aug 1990 and then on Aug 1991, the gap would be 12 periods. Thus, this would not constitute a HPR of 6 periods, but 12. In order to ensure we only ever get HPR of 6 periods, we need to create the indicator which shows how many periods (in months) two dates are apart from one another. This must equal 6 and not more! </span></span>
<span id="cb515-32"><a href="factor-models.html#cb515-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-33"><a href="factor-models.html#cb515-33" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_lag <span class="ot">&lt;-</span> CH_data_total_monthly_sub <span class="sc">%&gt;%</span> </span>
<span id="cb515-34"><a href="factor-models.html#cb515-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb515-35"><a href="factor-models.html#cb515-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lag6 =</span> <span class="fu">round</span>(<span class="dv">12</span><span class="sc">*</span>(Date_t <span class="sc">-</span> <span class="fu">lag</span>(Date_t, <span class="at">n=</span><span class="dv">5</span>)))<span class="sc">/</span><span class="dv">5</span>)</span>
<span id="cb515-36"><a href="factor-models.html#cb515-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-37"><a href="factor-models.html#cb515-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the adjustred returns to form the PF on</span></span>
<span id="cb515-38"><a href="factor-models.html#cb515-38" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret <span class="ot">&lt;-</span> CH_data_total_monthly_sub_lag <span class="sc">%&gt;%</span> </span>
<span id="cb515-39"><a href="factor-models.html#cb515-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb515-40"><a href="factor-models.html#cb515-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb515-41"><a href="factor-models.html#cb515-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb515-42"><a href="factor-models.html#cb515-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb515-43"><a href="factor-models.html#cb515-43" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the Cumulative Returns (Momentum) characteristic</span></span>
<span id="cb515-44"><a href="factor-models.html#cb515-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">Log_Ret_Adj =</span> <span class="fu">lag</span>(<span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span>Ret_Adj), <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb515-45"><a href="factor-models.html#cb515-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">Sum_Ret =</span> <span class="fu">roll_sum</span>(Log_Ret_Adj, <span class="dv">6</span>),</span>
<span id="cb515-46"><a href="factor-models.html#cb515-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">Cum_Ret =</span> <span class="fu">exp</span>(Sum_Ret) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb515-47"><a href="factor-models.html#cb515-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb515-48"><a href="factor-models.html#cb515-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb515-49"><a href="factor-models.html#cb515-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-50"><a href="factor-models.html#cb515-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Momentum</span></span>
<span id="cb515-51"><a href="factor-models.html#cb515-51" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_lag <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret <span class="sc">%&gt;%</span> </span>
<span id="cb515-52"><a href="factor-models.html#cb515-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb515-53"><a href="factor-models.html#cb515-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb515-54"><a href="factor-models.html#cb515-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb515-55"><a href="factor-models.html#cb515-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb515-56"><a href="factor-models.html#cb515-56" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb515-57"><a href="factor-models.html#cb515-57" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb515-58"><a href="factor-models.html#cb515-58" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb515-59"><a href="factor-models.html#cb515-59" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb515-60"><a href="factor-models.html#cb515-60" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb515-61"><a href="factor-models.html#cb515-61" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on B2M (Low, Neutral, High)</span></span>
<span id="cb515-62"><a href="factor-models.html#cb515-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Cum_Ret, </span>
<span id="cb515-63"><a href="factor-models.html#cb515-63" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Cum_Ret, </span>
<span id="cb515-64"><a href="factor-models.html#cb515-64" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb515-65"><a href="factor-models.html#cb515-65" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb515-66"><a href="factor-models.html#cb515-66" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb515-67"><a href="factor-models.html#cb515-67" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb515-68"><a href="factor-models.html#cb515-68" aria-hidden="true" tabindex="-1"></a>         <span class="at">Mom_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb515-69"><a href="factor-models.html#cb515-69" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb515-70"><a href="factor-models.html#cb515-70" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb515-71"><a href="factor-models.html#cb515-71" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb515-72"><a href="factor-models.html#cb515-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb515-73"><a href="factor-models.html#cb515-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-74"><a href="factor-models.html#cb515-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only certain columns</span></span>
<span id="cb515-75"><a href="factor-models.html#cb515-75" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_2_lag <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_lag <span class="sc">%&gt;%</span> </span>
<span id="cb515-76"><a href="factor-models.html#cb515-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Mom_Ranks, Size_Ranks)</span>
<span id="cb515-77"><a href="factor-models.html#cb515-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-78"><a href="factor-models.html#cb515-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Momentum</span></span>
<span id="cb515-79"><a href="factor-models.html#cb515-79" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_tot <span class="ot">&lt;-</span> CH_data_total_monthly_sub_lag <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb515-80"><a href="factor-models.html#cb515-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(., lag6 <span class="sc">==</span> <span class="dv">1</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb515-81"><a href="factor-models.html#cb515-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(CH_data_total_monthly_sub_rank_2_lag, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span><span class="ot">=</span><span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Date_t&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb515-82"><a href="factor-models.html#cb515-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Ticker,Date_t,Ret_Adj,Mom_Ranks, Size_Ranks) <span class="sc">%&gt;%</span></span>
<span id="cb515-83"><a href="factor-models.html#cb515-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Ticker,Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb515-84"><a href="factor-models.html#cb515-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Date_t,Mom_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb515-85"><a href="factor-models.html#cb515-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">momr =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb515-86"><a href="factor-models.html#cb515-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Mom_Ranks,Size_Ranks, momr) <span class="sc">%&gt;%</span> </span>
<span id="cb515-87"><a href="factor-models.html#cb515-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()  <span class="sc">%&gt;%</span> </span>
<span id="cb515-88"><a href="factor-models.html#cb515-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb515-89"><a href="factor-models.html#cb515-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Date_t,Size_Ranks, Mom_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb515-90"><a href="factor-models.html#cb515-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Date_t, Mom_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb515-91"><a href="factor-models.html#cb515-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Up_Size =</span> <span class="fu">ifelse</span>(Mom_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(momr), <span class="dv">0</span>),</span>
<span id="cb515-92"><a href="factor-models.html#cb515-92" aria-hidden="true" tabindex="-1"></a>           <span class="at">Down_Size =</span> <span class="fu">ifelse</span>(Mom_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(momr), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb515-93"><a href="factor-models.html#cb515-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb515-94"><a href="factor-models.html#cb515-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t, Up_Size, Down_Size) <span class="sc">%&gt;%</span> </span>
<span id="cb515-95"><a href="factor-models.html#cb515-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb515-96"><a href="factor-models.html#cb515-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb515-97"><a href="factor-models.html#cb515-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">MOM =</span> <span class="fu">sum</span>(Up_Size, <span class="at">na.rm =</span> T) <span class="sc">-</span> <span class="fu">sum</span>(Down_Size, <span class="at">na.rm =</span> T), </span>
<span id="cb515-98"><a href="factor-models.html#cb515-98" aria-hidden="true" tabindex="-1"></a>           <span class="at">Date_t =</span> lubridate<span class="sc">::</span><span class="fu">ceiling_date</span>(<span class="fu">my</span>(Date_t), <span class="st">&quot;month&quot;</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb515-99"><a href="factor-models.html#cb515-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t, MOM) <span class="sc">%&gt;%</span> </span>
<span id="cb515-100"><a href="factor-models.html#cb515-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>()</span>
<span id="cb515-101"><a href="factor-models.html#cb515-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-102"><a href="factor-models.html#cb515-102" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CH_data_total_monthly_sub_rank_tot) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Momentum_JT&quot;</span>)</span>
<span id="cb515-103"><a href="factor-models.html#cb515-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb515-104"><a href="factor-models.html#cb515-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the three individual factors </span></span>
<span id="cb515-105"><a href="factor-models.html#cb515-105" aria-hidden="true" tabindex="-1"></a><span class="do">## Create the xts objects</span></span>
<span id="cb515-106"><a href="factor-models.html#cb515-106" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_MOM_JT_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_total_monthly_sub_rank_tot[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_total_monthly_sub_rank_tot<span class="sc">$</span>Date_t))</span></code></pre></div>
<p>Now, we can combine both approaches and see the differences in cumulative returns.</p>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb516-1"><a href="factor-models.html#cb516-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a merged xts object</span></span>
<span id="cb516-2"><a href="factor-models.html#cb516-2" aria-hidden="true" tabindex="-1"></a>Factors <span class="ot">&lt;-</span> <span class="fu">merge.xts</span>(CH_data_EW_Ret_MOM_ts, CH_data_EW_Ret_MOM_JT_ts)</span>
<span id="cb516-3"><a href="factor-models.html#cb516-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb516-4"><a href="factor-models.html#cb516-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the relationship</span></span>
<span id="cb516-5"><a href="factor-models.html#cb516-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">na.omit</span>(Factors[<span class="st">&quot;1991-02-28/2020-12-31&quot;</span>])) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>index ,<span class="at">y =</span> value ,<span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb516-6"><a href="factor-models.html#cb516-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>( <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb516-7"><a href="factor-models.html#cb516-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Momentum Strategies&quot;</span>) <span class="sc">+</span> </span>
<span id="cb516-8"><a href="factor-models.html#cb516-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb516-9"><a href="factor-models.html#cb516-9" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb516-10"><a href="factor-models.html#cb516-10" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb516-11"><a href="factor-models.html#cb516-11" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb516-12"><a href="factor-models.html#cb516-12" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb516-13"><a href="factor-models.html#cb516-13" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb516-14"><a href="factor-models.html#cb516-14" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb516-15"><a href="factor-models.html#cb516-15" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb516-16"><a href="factor-models.html#cb516-16" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb516-17"><a href="factor-models.html#cb516-17" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-292-1.png" width="672" /></p>
<p>As we can see, there are slight differences in the cumulative return structures of both strategies, whereas it appears as if the factor construction of Jegadeesh and Titman (JT) delivers, on average, higher cumulative returns, especially after 2012.</p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb517"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb517-1"><a href="factor-models.html#cb517-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the three performance metrics</span></span>
<span id="cb517-2"><a href="factor-models.html#cb517-2" aria-hidden="true" tabindex="-1"></a>Annualised_Mean_Return <span class="ot">&lt;-</span> <span class="fu">Return.annualized</span>(Factors)</span>
<span id="cb517-3"><a href="factor-models.html#cb517-3" aria-hidden="true" tabindex="-1"></a>Annualised_SD <span class="ot">&lt;-</span> <span class="fu">sd.annualized</span>(Factors)</span>
<span id="cb517-4"><a href="factor-models.html#cb517-4" aria-hidden="true" tabindex="-1"></a>Sharpe_Ratio <span class="ot">&lt;-</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD</span>
<span id="cb517-5"><a href="factor-models.html#cb517-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb517-6"><a href="factor-models.html#cb517-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Put it together </span></span>
<span id="cb517-7"><a href="factor-models.html#cb517-7" aria-hidden="true" tabindex="-1"></a>df_MOM <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio))</span>
<span id="cb517-8"><a href="factor-models.html#cb517-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(df_MOM) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Annualised Return&quot;</span>, <span class="st">&quot;Standard Deviation&quot;</span>, <span class="st">&quot;Sharpe Ratio&quot;</span>)</span>
<span id="cb517-9"><a href="factor-models.html#cb517-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb517-10"><a href="factor-models.html#cb517-10" aria-hidden="true" tabindex="-1"></a>df_MOM</span></code></pre></div>
<pre><code>##                    Momentum_Car Momentum_JT
## Annualised Return     0.1328486   0.1587250
## Standard Deviation    0.1716447   0.1797972
## Sharpe Ratio          0.7739741   0.8828004</code></pre>
</div>
<div id="betting-against-beta" class="section level4" number="8.5.5.4">
<h4><span class="header-section-number">8.5.5.4</span> Betting Against Beta</h4>
<div class="sourceCode" id="cb519"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb519-1"><a href="factor-models.html#cb519-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s run the experiment for the reduced data frame </span></span>
<span id="cb519-2"><a href="factor-models.html#cb519-2" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb519-3"><a href="factor-models.html#cb519-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb519-4"><a href="factor-models.html#cb519-4" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb519-5"><a href="factor-models.html#cb519-5" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb519-6"><a href="factor-models.html#cb519-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-7"><a href="factor-models.html#cb519-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb519-8"><a href="factor-models.html#cb519-8" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb519-9"><a href="factor-models.html#cb519-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb519-10"><a href="factor-models.html#cb519-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Total_Assets_t)</span>
<span id="cb519-11"><a href="factor-models.html#cb519-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-12"><a href="factor-models.html#cb519-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb519-13"><a href="factor-models.html#cb519-13" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_BAB <span class="ot">&lt;-</span> CH_data_total_mont <span class="sc">%&gt;%</span> </span>
<span id="cb519-14"><a href="factor-models.html#cb519-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb519-15"><a href="factor-models.html#cb519-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb519-16"><a href="factor-models.html#cb519-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb519-17"><a href="factor-models.html#cb519-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb519-18"><a href="factor-models.html#cb519-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb519-19"><a href="factor-models.html#cb519-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb519-20"><a href="factor-models.html#cb519-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="dv">1</span>), </span>
<span id="cb519-21"><a href="factor-models.html#cb519-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb519-22"><a href="factor-models.html#cb519-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb519-23"><a href="factor-models.html#cb519-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb519-24"><a href="factor-models.html#cb519-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-25"><a href="factor-models.html#cb519-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-26"><a href="factor-models.html#cb519-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s also get the data on the Swiss Market Index as well as the risk free rate </span></span>
<span id="cb519-27"><a href="factor-models.html#cb519-27" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A2_dataset_02.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb519-28"><a href="factor-models.html#cb519-28" aria-hidden="true" tabindex="-1"></a>rf_ts <span class="ot">&lt;-</span> rf <span class="sc">%&gt;%</span> </span>
<span id="cb519-29"><a href="factor-models.html#cb519-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>((Date <span class="sc">&gt;=</span> <span class="st">&#39;1989-12-01&#39;</span>) <span class="sc">&amp;</span> (Date <span class="sc">&lt;=</span> <span class="st">&#39;2019-12-31&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb519-30"><a href="factor-models.html#cb519-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rf_annual =</span> SWISS.CONFEDERATION.BOND.<span class="fl">1.</span>YEAR...RED..YIELD <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb519-31"><a href="factor-models.html#cb519-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">rf_monthly =</span>  (<span class="dv">1</span> <span class="sc">+</span> rf_annual)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb519-32"><a href="factor-models.html#cb519-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date, rf_monthly)</span>
<span id="cb519-33"><a href="factor-models.html#cb519-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-34"><a href="factor-models.html#cb519-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb519-35"><a href="factor-models.html#cb519-35" aria-hidden="true" tabindex="-1"></a>SMI <span class="ot">&lt;-</span>  <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A2_dataset_03.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb519-36"><a href="factor-models.html#cb519-36" aria-hidden="true" tabindex="-1"></a>SMI_ts <span class="ot">&lt;-</span> SMI <span class="sc">%&gt;%</span> </span>
<span id="cb519-37"><a href="factor-models.html#cb519-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>((Date <span class="sc">&gt;=</span> <span class="st">&#39;1989-12-01&#39;</span>) <span class="sc">&amp;</span> (Date <span class="sc">&lt;=</span> <span class="st">&#39;2019-12-31&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb519-38"><a href="factor-models.html#cb519-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SMI_ret =</span> (SMI <span class="sc">-</span> <span class="fu">lag</span>(SMI, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(SMI, <span class="dv">1</span>),</span>
<span id="cb519-39"><a href="factor-models.html#cb519-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">rf_monthly =</span> rf_ts<span class="sc">$</span>rf_monthly,</span>
<span id="cb519-40"><a href="factor-models.html#cb519-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">SMI_rf_excess_ret =</span> SMI_ret <span class="sc">-</span> rf_monthly) </span>
<span id="cb519-41"><a href="factor-models.html#cb519-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-42"><a href="factor-models.html#cb519-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, let&#39;s calculate the excess returns</span></span>
<span id="cb519-43"><a href="factor-models.html#cb519-43" aria-hidden="true" tabindex="-1"></a>SMI_rf_ts_ret <span class="ot">&lt;-</span> SMI_ts_ret <span class="sc">-</span> rf_ts_monthly</span>
<span id="cb519-44"><a href="factor-models.html#cb519-44" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_excess_ret_BAB <span class="ot">&lt;-</span> <span class="fu">left_join</span>(SMI_ts, CH_data_total_monthly_sub_BAB, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Date&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb519-45"><a href="factor-models.html#cb519-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Excess_Ret_Adj =</span> Ret_Adj <span class="sc">-</span> rf_monthly)</span>
<span id="cb519-46"><a href="factor-models.html#cb519-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb519-47"><a href="factor-models.html#cb519-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on this, we can now have rolling regressions of the correlation as well as the standard deviations. </span></span>
<span id="cb519-48"><a href="factor-models.html#cb519-48" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_weighted_BAB <span class="ot">&lt;-</span> CH_data_total_monthly_sub_excess_ret_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb519-49"><a href="factor-models.html#cb519-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb519-50"><a href="factor-models.html#cb519-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sd_roll_1_year =</span> <span class="fu">roll_sd</span>(Excess_Ret_Adj, <span class="at">width =</span> <span class="dv">12</span>), </span>
<span id="cb519-51"><a href="factor-models.html#cb519-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">corr_roll_5_year =</span> <span class="fu">roll_cor</span>(Excess_Ret_Adj, SMI_rf_excess_ret, <span class="at">width =</span> <span class="dv">60</span>), </span>
<span id="cb519-52"><a href="factor-models.html#cb519-52" aria-hidden="true" tabindex="-1"></a>         <span class="at">sd_roll_1_year_Market =</span> <span class="fu">roll_sd</span>(SMI_rf_excess_ret, <span class="at">width =</span> <span class="dv">12</span>), </span>
<span id="cb519-53"><a href="factor-models.html#cb519-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">Beta_Est_raw =</span> sd_roll_1_year<span class="sc">/</span>sd_roll_1_year_Market<span class="sc">*</span>corr_roll_5_year,</span>
<span id="cb519-54"><a href="factor-models.html#cb519-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">Beta_Est_Adj =</span> Beta_Est_raw<span class="sc">*</span><span class="fl">0.6</span> <span class="sc">+</span> <span class="fl">0.4</span><span class="sc">*</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb519-55"><a href="factor-models.html#cb519-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb519-56"><a href="factor-models.html#cb519-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="sc">!</span><span class="fu">is.na</span>(Beta_Est_Adj)) <span class="sc">%&gt;%</span></span>
<span id="cb519-57"><a href="factor-models.html#cb519-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb519-58"><a href="factor-models.html#cb519-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranks_beta =</span> <span class="fu">rank</span>(Beta_Est_Adj), </span>
<span id="cb519-59"><a href="factor-models.html#cb519-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean_rank_beta =</span> <span class="fu">mean</span>(ranks_beta, <span class="at">na.rm =</span> T), </span>
<span id="cb519-60"><a href="factor-models.html#cb519-60" aria-hidden="true" tabindex="-1"></a>         <span class="at">portfolio_indicator_BAB =</span><span class="fu">ifelse</span>(ranks_beta <span class="sc">&gt;</span> mean_rank_beta, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb519-61"><a href="factor-models.html#cb519-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb519-62"><a href="factor-models.html#cb519-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, portfolio_indicator_BAB) <span class="sc">%&gt;%</span> </span>
<span id="cb519-63"><a href="factor-models.html#cb519-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">abs_dev =</span> <span class="fu">abs</span>(ranks_beta <span class="sc">-</span> mean_rank_beta), </span>
<span id="cb519-64"><a href="factor-models.html#cb519-64" aria-hidden="true" tabindex="-1"></a>         <span class="at">sum_abs_dev =</span> <span class="fu">sum</span>(abs_dev, <span class="at">na.rm =</span> T), </span>
<span id="cb519-65"><a href="factor-models.html#cb519-65" aria-hidden="true" tabindex="-1"></a>         <span class="at">k =</span> <span class="dv">2</span> <span class="sc">/</span> sum_abs_dev, </span>
<span id="cb519-66"><a href="factor-models.html#cb519-66" aria-hidden="true" tabindex="-1"></a>         <span class="at">weights_BAB =</span> k<span class="sc">*</span>(ranks_beta <span class="sc">-</span> mean_rank_beta), </span>
<span id="cb519-67"><a href="factor-models.html#cb519-67" aria-hidden="true" tabindex="-1"></a>         <span class="at">Beta_Est_Weight_Adj =</span> Beta_Est_Adj <span class="sc">*</span> weights_BAB) <span class="sc">%&gt;%</span> </span>
<span id="cb519-68"><a href="factor-models.html#cb519-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb519-69"><a href="factor-models.html#cb519-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-70"><a href="factor-models.html#cb519-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rankings</span></span>
<span id="cb519-71"><a href="factor-models.html#cb519-71" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_rank_BAB <span class="ot">&lt;-</span> CH_data_total_monthly_weighted_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb519-72"><a href="factor-models.html#cb519-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb519-73"><a href="factor-models.html#cb519-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Decile =</span> <span class="fu">ntile</span>(Beta_Est_Weight_Adj, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb519-74"><a href="factor-models.html#cb519-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb519-75"><a href="factor-models.html#cb519-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-76"><a href="factor-models.html#cb519-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mean returns Decile</span></span>
<span id="cb519-77"><a href="factor-models.html#cb519-77" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_BAB <span class="ot">&lt;-</span> CH_data_total_monthly_rank_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb519-78"><a href="factor-models.html#cb519-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb519-79"><a href="factor-models.html#cb519-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(Beta_Est_Weight_Adj)<span class="sc">*</span><span class="fu">sum</span>(weights_BAB<span class="sc">*</span>Excess_Ret_Adj)) <span class="sc">%&gt;%</span> </span>
<span id="cb519-80"><a href="factor-models.html#cb519-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date, Decile, EW_Ret_mean_t) <span class="sc">%&gt;%</span> </span>
<span id="cb519-81"><a href="factor-models.html#cb519-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb519-82"><a href="factor-models.html#cb519-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb519-83"><a href="factor-models.html#cb519-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date, Decile) <span class="sc">%&gt;%</span> </span>
<span id="cb519-84"><a href="factor-models.html#cb519-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="at">key =</span> Decile, <span class="at">value =</span> EW_Ret_mean_t) <span class="sc">%&gt;%</span> </span>
<span id="cb519-85"><a href="factor-models.html#cb519-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BAB =</span> <span class="st">`</span><span class="at">1</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">2</span><span class="st">`</span>,</span>
<span id="cb519-86"><a href="factor-models.html#cb519-86" aria-hidden="true" tabindex="-1"></a>         <span class="at">BAB_cr =</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span>BAB))</span>
<span id="cb519-87"><a href="factor-models.html#cb519-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb519-88"><a href="factor-models.html#cb519-88" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_BAB <span class="sc">%&gt;%</span> </span>
<span id="cb519-89"><a href="factor-models.html#cb519-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb519-90"><a href="factor-models.html#cb519-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span><span class="fu">as.Date</span>(Date),<span class="at">y =</span> BAB_cr), <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">&quot;goldenrod&quot;</span>) <span class="sc">+</span></span>
<span id="cb519-91"><a href="factor-models.html#cb519-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;BAB Strategy with long formatted dataset&quot;</span>) <span class="sc">+</span> </span>
<span id="cb519-92"><a href="factor-models.html#cb519-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb519-93"><a href="factor-models.html#cb519-93" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb519-94"><a href="factor-models.html#cb519-94" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb519-95"><a href="factor-models.html#cb519-95" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb519-96"><a href="factor-models.html#cb519-96" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb519-97"><a href="factor-models.html#cb519-97" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb519-98"><a href="factor-models.html#cb519-98" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb519-99"><a href="factor-models.html#cb519-99" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb519-100"><a href="factor-models.html#cb519-100" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb519-101"><a href="factor-models.html#cb519-101" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-294-1.png" width="672" /></p>
<p>Finally, let’s calculate the summary statistics</p>
<div class="sourceCode" id="cb520"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb520-1"><a href="factor-models.html#cb520-1" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_BAB_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_BAB<span class="sc">$</span>BAB, <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_BAB<span class="sc">$</span>Date))</span>
<span id="cb520-2"><a href="factor-models.html#cb520-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb520-3"><a href="factor-models.html#cb520-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the three performance metrics</span></span>
<span id="cb520-4"><a href="factor-models.html#cb520-4" aria-hidden="true" tabindex="-1"></a>Annualised_Mean_Return <span class="ot">&lt;-</span> <span class="fu">Return.annualized</span>(CH_data_EW_Ret_BAB_ts)</span>
<span id="cb520-5"><a href="factor-models.html#cb520-5" aria-hidden="true" tabindex="-1"></a>Annualised_SD <span class="ot">&lt;-</span> <span class="fu">sd.annualized</span>(CH_data_EW_Ret_BAB_ts)</span>
<span id="cb520-6"><a href="factor-models.html#cb520-6" aria-hidden="true" tabindex="-1"></a>Sharpe_Ratio <span class="ot">&lt;-</span> Annualised_Mean_Return<span class="sc">/</span>Annualised_SD</span>
<span id="cb520-7"><a href="factor-models.html#cb520-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb520-8"><a href="factor-models.html#cb520-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Put it together </span></span>
<span id="cb520-9"><a href="factor-models.html#cb520-9" aria-hidden="true" tabindex="-1"></a>df_BAB<span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(Annualised_Mean_Return, Annualised_SD, Sharpe_Ratio))</span>
<span id="cb520-10"><a href="factor-models.html#cb520-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(df_BAB) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Annualised Return&quot;</span>, <span class="st">&quot;Standard Deviation&quot;</span>, <span class="st">&quot;Sharpe Ratio&quot;</span>)</span>
<span id="cb520-11"><a href="factor-models.html#cb520-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_BAB) <span class="ot">&lt;-</span> <span class="st">&quot;BAB&quot;</span></span>
<span id="cb520-12"><a href="factor-models.html#cb520-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb520-13"><a href="factor-models.html#cb520-13" aria-hidden="true" tabindex="-1"></a>df_BAB</span></code></pre></div>
<pre><code>##                           BAB
## Annualised Return  0.03227748
## Standard Deviation 0.15029547
## Sharpe Ratio       0.21476018</code></pre>
</div>
</div>
<div id="the-importance-of-data-selection" class="section level3" number="8.5.6">
<h3><span class="header-section-number">8.5.6</span> The importance of data selection</h3>
<p>We have now seen how to calculate five of the most widespread factors in asset management. Lastly, we deem it necessary to show you the importance of data accessibility. This follows the fact that identical databases provide different data based on the sub-section of the respective database. Since the data is different, the exactly identical approach to construct the factor at hand will, inadvertedly, lead to different end results. This should hightlight both the discrepancy of data availability and stress the need to always thoroughly double-check and cross-reference your data in order to circumvent the issue of incoherent data mining.</p>
<p>To do so, we retrieved data to calculate the Value factor from Thomson Reuters Datastream as well as Bloomberg, two of the largest data providers. We calculate the Value factor in an identical way and plot both cumulative returns to show the (substantial) differences when using different sets of data.</p>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb522-1"><a href="factor-models.html#cb522-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the old dataset for book value</span></span>
<span id="cb522-2"><a href="factor-models.html#cb522-2" aria-hidden="true" tabindex="-1"></a>Book <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_02.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb522-3"><a href="factor-models.html#cb522-3" aria-hidden="true" tabindex="-1"></a>Book_check <span class="ot">&lt;-</span> Book <span class="sc">%&gt;%</span></span>
<span id="cb522-4"><a href="factor-models.html#cb522-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(Ticker,value,NESN<span class="sc">:</span>X692395) <span class="sc">%&gt;%</span> </span>
<span id="cb522-5"><a href="factor-models.html#cb522-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_t =</span> lubridate<span class="sc">::</span><span class="fu">ceiling_date</span>(<span class="fu">dmy</span>(Date), <span class="st">&quot;month&quot;</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb522-6"><a href="factor-models.html#cb522-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Date)</span>
<span id="cb522-7"><a href="factor-models.html#cb522-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-8"><a href="factor-models.html#cb522-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Book_check) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Total_Eq_Real&quot;</span>, <span class="st">&quot;Date_t&quot;</span>)</span>
<span id="cb522-9"><a href="factor-models.html#cb522-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-10"><a href="factor-models.html#cb522-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Only sub select the companies under consideration</span></span>
<span id="cb522-11"><a href="factor-models.html#cb522-11" aria-hidden="true" tabindex="-1"></a>tic_sub <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">names</span>(<span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/Master UZH/Data/A4_dataset_04.txt&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)))</span>
<span id="cb522-12"><a href="factor-models.html#cb522-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-13"><a href="factor-models.html#cb522-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get 347 companies</span></span>
<span id="cb522-14"><a href="factor-models.html#cb522-14" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Desktop/CH_data_total_monthly.csv&quot;</span>, <span class="at">header =</span> T, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb522-15"><a href="factor-models.html#cb522-15" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_clean <span class="ot">&lt;-</span> CH_data_total_monthly[<span class="sc">!</span><span class="fu">duplicated</span>(CH_data_total_monthly[<span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;Ticker&quot;</span>)]),]</span>
<span id="cb522-16"><a href="factor-models.html#cb522-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-17"><a href="factor-models.html#cb522-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Only get the respective columns</span></span>
<span id="cb522-18"><a href="factor-models.html#cb522-18" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont <span class="ot">&lt;-</span> CH_data_total_monthly_clean <span class="sc">%&gt;%</span> </span>
<span id="cb522-19"><a href="factor-models.html#cb522-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Ticker <span class="sc">%in%</span> tic_sub) <span class="sc">%&gt;%</span> </span>
<span id="cb522-20"><a href="factor-models.html#cb522-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, Ticker, Adj_Close, Close, Num_Shares, Total_Eq_t, Gross_Inc_t, Operating_Exp_t, Interest_Exp_t, Total_Assets_t, Total_Liab_t) <span class="sc">%&gt;%</span> </span>
<span id="cb522-21"><a href="factor-models.html#cb522-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Total_Eq_t =</span> Total_Assets_t <span class="sc">-</span> Total_Liab_t,</span>
<span id="cb522-22"><a href="factor-models.html#cb522-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">Num_Shares =</span> Num_Shares, </span>
<span id="cb522-23"><a href="factor-models.html#cb522-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date_t =</span> <span class="fu">as.Date</span>(Date_t)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-24"><a href="factor-models.html#cb522-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb522-25"><a href="factor-models.html#cb522-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Close =</span> <span class="fu">lag</span>(Close, <span class="at">n=</span><span class="dv">1</span>),</span>
<span id="cb522-26"><a href="factor-models.html#cb522-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">Num_Shares =</span> <span class="fu">lag</span>(Num_Shares, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-27"><a href="factor-models.html#cb522-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb522-28"><a href="factor-models.html#cb522-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-29"><a href="factor-models.html#cb522-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-30"><a href="factor-models.html#cb522-30" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont_check <span class="ot">&lt;-</span> <span class="fu">left_join</span>(CH_data_total_mont, Book_check, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Ticker&quot;</span> <span class="ot">=</span> <span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Date_t&quot;</span> <span class="ot">=</span> <span class="st">&quot;Date_t&quot;</span>))</span>
<span id="cb522-31"><a href="factor-models.html#cb522-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-32"><a href="factor-models.html#cb522-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Control for extreme values</span></span>
<span id="cb522-33"><a href="factor-models.html#cb522-33" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_Size <span class="ot">&lt;-</span> CH_data_total_mont_check <span class="sc">%&gt;%</span> </span>
<span id="cb522-34"><a href="factor-models.html#cb522-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t)  <span class="sc">%&gt;%</span> </span>
<span id="cb522-35"><a href="factor-models.html#cb522-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb522-36"><a href="factor-models.html#cb522-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ret_Adj =</span> (Adj_Close <span class="sc">-</span> <span class="fu">lag</span>(Adj_Close, <span class="dv">1</span>))<span class="sc">/</span><span class="fu">lag</span>(Adj_Close,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-37"><a href="factor-models.html#cb522-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-38"><a href="factor-models.html#cb522-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-39"><a href="factor-models.html#cb522-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb522-40"><a href="factor-models.html#cb522-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Extreme_Values =</span> <span class="fu">quantile</span>(Ret_Adj, <span class="at">p =</span> <span class="dv">1</span>), </span>
<span id="cb522-41"><a href="factor-models.html#cb522-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">Extreme_Indicator =</span> <span class="fu">ifelse</span>(Ret_Adj <span class="sc">&lt;=</span> Extreme_Values, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb522-42"><a href="factor-models.html#cb522-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ret_Adj =</span> Ret_Adj <span class="sc">*</span> Extreme_Indicator) <span class="sc">%&gt;%</span> </span>
<span id="cb522-43"><a href="factor-models.html#cb522-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb522-44"><a href="factor-models.html#cb522-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-45"><a href="factor-models.html#cb522-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size Value TR</span></span>
<span id="cb522-46"><a href="factor-models.html#cb522-46" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb522-47"><a href="factor-models.html#cb522-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb522-48"><a href="factor-models.html#cb522-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb522-49"><a href="factor-models.html#cb522-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb522-50"><a href="factor-models.html#cb522-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb522-51"><a href="factor-models.html#cb522-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb522-52"><a href="factor-models.html#cb522-52" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb522-53"><a href="factor-models.html#cb522-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">Total_Eq_t =</span> Total_Assets_t <span class="sc">-</span> Total_Liab_t,</span>
<span id="cb522-54"><a href="factor-models.html#cb522-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">B2M =</span> <span class="fu">lag</span>(Total_Eq_t, <span class="at">n =</span> <span class="dv">6</span>) <span class="sc">/</span> Market_Cap) <span class="sc">%&gt;%</span> </span>
<span id="cb522-55"><a href="factor-models.html#cb522-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-56"><a href="factor-models.html#cb522-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb522-57"><a href="factor-models.html#cb522-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-58"><a href="factor-models.html#cb522-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the variables for Size and Value BL</span></span>
<span id="cb522-59"><a href="factor-models.html#cb522-59" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_cumret_Size_Value_old <span class="ot">&lt;-</span> CH_data_total_monthly_sub_Size <span class="sc">%&gt;%</span> </span>
<span id="cb522-60"><a href="factor-models.html#cb522-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb522-61"><a href="factor-models.html#cb522-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create the Market Cap (Size) characteristic</span></span>
<span id="cb522-62"><a href="factor-models.html#cb522-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">Shares_Out_lagged =</span> <span class="fu">lag</span>(Num_Shares, <span class="at">n =</span> <span class="dv">1</span>), </span>
<span id="cb522-63"><a href="factor-models.html#cb522-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">Price_close_lagged =</span> <span class="fu">lag</span>(Close, <span class="at">n =</span> <span class="dv">1</span>),</span>
<span id="cb522-64"><a href="factor-models.html#cb522-64" aria-hidden="true" tabindex="-1"></a>         <span class="at">Market_Cap =</span> Shares_Out_lagged <span class="sc">*</span> Price_close_lagged, </span>
<span id="cb522-65"><a href="factor-models.html#cb522-65" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create the B2M (Value) characteristic</span></span>
<span id="cb522-66"><a href="factor-models.html#cb522-66" aria-hidden="true" tabindex="-1"></a>         <span class="at">B2M_old =</span> <span class="fu">lag</span>(Total_Eq_Real, <span class="at">n =</span> <span class="dv">6</span>) <span class="sc">/</span> Market_Cap) <span class="sc">%&gt;%</span> </span>
<span id="cb522-67"><a href="factor-models.html#cb522-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-68"><a href="factor-models.html#cb522-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb522-69"><a href="factor-models.html#cb522-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-70"><a href="factor-models.html#cb522-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Value TR</span></span>
<span id="cb522-71"><a href="factor-models.html#cb522-71" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Value <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Value <span class="sc">%&gt;%</span> </span>
<span id="cb522-72"><a href="factor-models.html#cb522-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb522-73"><a href="factor-models.html#cb522-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb522-74"><a href="factor-models.html#cb522-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb522-75"><a href="factor-models.html#cb522-75" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb522-76"><a href="factor-models.html#cb522-76" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb522-77"><a href="factor-models.html#cb522-77" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb522-78"><a href="factor-models.html#cb522-78" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb522-79"><a href="factor-models.html#cb522-79" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb522-80"><a href="factor-models.html#cb522-80" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb522-81"><a href="factor-models.html#cb522-81" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on B2M (Low, Neutral, High)</span></span>
<span id="cb522-82"><a href="factor-models.html#cb522-82" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(B2M, </span>
<span id="cb522-83"><a href="factor-models.html#cb522-83" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(B2M, </span>
<span id="cb522-84"><a href="factor-models.html#cb522-84" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb522-85"><a href="factor-models.html#cb522-85" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb522-86"><a href="factor-models.html#cb522-86" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb522-87"><a href="factor-models.html#cb522-87" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb522-88"><a href="factor-models.html#cb522-88" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb522-89"><a href="factor-models.html#cb522-89" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb522-90"><a href="factor-models.html#cb522-90" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb522-91"><a href="factor-models.html#cb522-91" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb522-92"><a href="factor-models.html#cb522-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb522-93"><a href="factor-models.html#cb522-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-94"><a href="factor-models.html#cb522-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign Rankings for Size and Value BL</span></span>
<span id="cb522-95"><a href="factor-models.html#cb522-95" aria-hidden="true" tabindex="-1"></a>CH_data_total_monthly_sub_rank_Size_Value_old <span class="ot">&lt;-</span> CH_data_total_monthly_sub_cumret_Size_Value_old <span class="sc">%&gt;%</span> </span>
<span id="cb522-96"><a href="factor-models.html#cb522-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb522-97"><a href="factor-models.html#cb522-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we form the groups (ranks)</span></span>
<span id="cb522-98"><a href="factor-models.html#cb522-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Create Small and Big Rank</span></span>
<span id="cb522-99"><a href="factor-models.html#cb522-99" aria-hidden="true" tabindex="-1"></a>          <span class="at">Size_Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(Market_Cap, </span>
<span id="cb522-100"><a href="factor-models.html#cb522-100" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(Market_Cap, </span>
<span id="cb522-101"><a href="factor-models.html#cb522-101" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb522-102"><a href="factor-models.html#cb522-102" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb522-103"><a href="factor-models.html#cb522-103" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb522-104"><a href="factor-models.html#cb522-104" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb522-105"><a href="factor-models.html#cb522-105" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Create Terciles based on B2M (Low, Neutral, High)</span></span>
<span id="cb522-106"><a href="factor-models.html#cb522-106" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ranks =</span> <span class="fu">as.numeric</span>(<span class="fu">cut</span>(B2M_old, </span>
<span id="cb522-107"><a href="factor-models.html#cb522-107" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> <span class="fu">quantile</span>(B2M_old, </span>
<span id="cb522-108"><a href="factor-models.html#cb522-108" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">probs=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">11</span>), </span>
<span id="cb522-109"><a href="factor-models.html#cb522-109" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb522-110"><a href="factor-models.html#cb522-110" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="dv">4</span>), </span>
<span id="cb522-111"><a href="factor-models.html#cb522-111" aria-hidden="true" tabindex="-1"></a>               <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb522-112"><a href="factor-models.html#cb522-112" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value_old_Ranks =</span> <span class="fu">ifelse</span>(Ranks <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>, </span>
<span id="cb522-113"><a href="factor-models.html#cb522-113" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> Ranks <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="dv">2</span>, </span>
<span id="cb522-114"><a href="factor-models.html#cb522-114" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(Ranks <span class="sc">&gt;</span> <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">0</span>)))</span>
<span id="cb522-115"><a href="factor-models.html#cb522-115" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb522-116"><a href="factor-models.html#cb522-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb522-117"><a href="factor-models.html#cb522-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-118"><a href="factor-models.html#cb522-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Value TR</span></span>
<span id="cb522-119"><a href="factor-models.html#cb522-119" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Value <span class="sc">%&gt;%</span> </span>
<span id="cb522-120"><a href="factor-models.html#cb522-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb522-121"><a href="factor-models.html#cb522-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Value =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb522-122"><a href="factor-models.html#cb522-122" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Value =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-123"><a href="factor-models.html#cb522-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Value_Ranks, EW_Ret_mean_t_Size_Value,EW_Ret_sd_t_Size_Value) <span class="sc">%&gt;%</span> </span>
<span id="cb522-124"><a href="factor-models.html#cb522-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-125"><a href="factor-models.html#cb522-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-126"><a href="factor-models.html#cb522-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb522-127"><a href="factor-models.html#cb522-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Value_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb522-128"><a href="factor-models.html#cb522-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">High_Size =</span> <span class="fu">ifelse</span>(Value_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value), <span class="dv">0</span>),</span>
<span id="cb522-129"><a href="factor-models.html#cb522-129" aria-hidden="true" tabindex="-1"></a>         <span class="at">Low_Size =</span> <span class="fu">ifelse</span>(Value_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-130"><a href="factor-models.html#cb522-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-131"><a href="factor-models.html#cb522-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, High_Size, Low_Size) <span class="sc">%&gt;%</span> </span>
<span id="cb522-132"><a href="factor-models.html#cb522-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-133"><a href="factor-models.html#cb522-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb522-134"><a href="factor-models.html#cb522-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HML =</span> <span class="fu">sum</span>(High_Size) <span class="sc">-</span> <span class="fu">sum</span>(Low_Size)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-135"><a href="factor-models.html#cb522-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, HML) <span class="sc">%&gt;%</span> </span>
<span id="cb522-136"><a href="factor-models.html#cb522-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb522-137"><a href="factor-models.html#cb522-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-138"><a href="factor-models.html#cb522-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the average returns per group for Size and Value BL</span></span>
<span id="cb522-139"><a href="factor-models.html#cb522-139" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML_old <span class="ot">&lt;-</span> CH_data_total_monthly_sub_rank_Size_Value_old <span class="sc">%&gt;%</span> </span>
<span id="cb522-140"><a href="factor-models.html#cb522-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Size_Ranks, Value_old_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb522-141"><a href="factor-models.html#cb522-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EW_Ret_mean_t_Size_Value_old =</span> <span class="fu">mean</span>(Ret_Adj, <span class="at">na.rm =</span> T), </span>
<span id="cb522-142"><a href="factor-models.html#cb522-142" aria-hidden="true" tabindex="-1"></a>         <span class="at">EW_Ret_sd_t_Size_Value_old =</span> <span class="fu">sd</span>(Ret_Adj, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-143"><a href="factor-models.html#cb522-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date_t,Size_Ranks, Value_old_Ranks, EW_Ret_mean_t_Size_Value_old,EW_Ret_sd_t_Size_Value_old) <span class="sc">%&gt;%</span> </span>
<span id="cb522-144"><a href="factor-models.html#cb522-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-145"><a href="factor-models.html#cb522-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-146"><a href="factor-models.html#cb522-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Date_t,Size_Ranks, Value_old_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb522-147"><a href="factor-models.html#cb522-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t, Value_old_Ranks) <span class="sc">%&gt;%</span> </span>
<span id="cb522-148"><a href="factor-models.html#cb522-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">High_Size =</span> <span class="fu">ifelse</span>(Value_old_Ranks <span class="sc">==</span> <span class="dv">3</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value_old), <span class="dv">0</span>),</span>
<span id="cb522-149"><a href="factor-models.html#cb522-149" aria-hidden="true" tabindex="-1"></a>         <span class="at">Low_Size =</span> <span class="fu">ifelse</span>(Value_old_Ranks <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">mean</span>(EW_Ret_mean_t_Size_Value_old), <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-150"><a href="factor-models.html#cb522-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-151"><a href="factor-models.html#cb522-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, High_Size, Low_Size) <span class="sc">%&gt;%</span> </span>
<span id="cb522-152"><a href="factor-models.html#cb522-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb522-153"><a href="factor-models.html#cb522-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date_t) <span class="sc">%&gt;%</span> </span>
<span id="cb522-154"><a href="factor-models.html#cb522-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HML_old =</span> <span class="fu">sum</span>(High_Size) <span class="sc">-</span> <span class="fu">sum</span>(Low_Size)) <span class="sc">%&gt;%</span> </span>
<span id="cb522-155"><a href="factor-models.html#cb522-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date_t, HML_old) <span class="sc">%&gt;%</span> </span>
<span id="cb522-156"><a href="factor-models.html#cb522-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb522-157"><a href="factor-models.html#cb522-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-158"><a href="factor-models.html#cb522-158" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CH_data_EW_Ret_HML) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;HML_TR&quot;</span>)</span>
<span id="cb522-159"><a href="factor-models.html#cb522-159" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CH_data_EW_Ret_HML_old) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Date_t&quot;</span>, <span class="st">&quot;HML_BL&quot;</span>)</span>
<span id="cb522-160"><a href="factor-models.html#cb522-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-161"><a href="factor-models.html#cb522-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the three individual factors </span></span>
<span id="cb522-162"><a href="factor-models.html#cb522-162" aria-hidden="true" tabindex="-1"></a><span class="do">## Create three xts objects</span></span>
<span id="cb522-163"><a href="factor-models.html#cb522-163" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML_TR_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_HML[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_HML<span class="sc">$</span>Date_t))</span>
<span id="cb522-164"><a href="factor-models.html#cb522-164" aria-hidden="true" tabindex="-1"></a>CH_data_EW_Ret_HML_BL_ts <span class="ot">&lt;-</span> <span class="fu">xts</span>(CH_data_EW_Ret_HML_old[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">order.by =</span> <span class="fu">as.Date</span>(CH_data_EW_Ret_HML_old<span class="sc">$</span>Date_t))</span>
<span id="cb522-165"><a href="factor-models.html#cb522-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-166"><a href="factor-models.html#cb522-166" aria-hidden="true" tabindex="-1"></a>Factors <span class="ot">&lt;-</span> <span class="fu">merge.xts</span>(CH_data_EW_Ret_HML_TR_ts, CH_data_EW_Ret_HML_BL_ts)</span>
<span id="cb522-167"><a href="factor-models.html#cb522-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb522-168"><a href="factor-models.html#cb522-168" aria-hidden="true" tabindex="-1"></a><span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">na.omit</span>(Factors[<span class="st">&quot;1991-02-28/2020-12-31&quot;</span>])) <span class="sc">%&gt;%</span> <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>index ,<span class="at">y =</span> value ,<span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb522-169"><a href="factor-models.html#cb522-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>( <span class="at">size =</span> <span class="fl">0.5</span> ) <span class="sc">+</span></span>
<span id="cb522-170"><a href="factor-models.html#cb522-170" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">&quot;Value strategy based on different databases (Bloomberg vs. Reuters)&quot;</span>) <span class="sc">+</span> </span>
<span id="cb522-171"><a href="factor-models.html#cb522-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Cumulative Returns&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb522-172"><a href="factor-models.html#cb522-172" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">plot.title=</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>, <span class="at">color=</span><span class="st">&quot;grey26&quot;</span>,</span>
<span id="cb522-173"><a href="factor-models.html#cb522-173" aria-hidden="true" tabindex="-1"></a><span class="at">hjust=</span><span class="fl">0.5</span>,</span>
<span id="cb522-174"><a href="factor-models.html#cb522-174" aria-hidden="true" tabindex="-1"></a><span class="at">lineheight=</span><span class="fl">1.2</span>), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>),</span>
<span id="cb522-175"><a href="factor-models.html#cb522-175" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>),</span>
<span id="cb522-176"><a href="factor-models.html#cb522-176" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb522-177"><a href="factor-models.html#cb522-177" aria-hidden="true" tabindex="-1"></a><span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb522-178"><a href="factor-models.html#cb522-178" aria-hidden="true" tabindex="-1"></a><span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="st">&quot;#f7f7f7&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f7f7f7&quot;</span>), <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb522-179"><a href="factor-models.html#cb522-179" aria-hidden="true" tabindex="-1"></a><span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;grey26&quot;</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb522-180"><a href="factor-models.html#cb522-180" aria-hidden="true" tabindex="-1"></a><span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-296-1.png" width="672" /></p>
<p>As we can see, although both appear to be correlated and follow the same paths throughout time, we can see that the data provided from Bloomberg (BL) delivers substantially larger factor returns than the data from Thompson Reuters. Let’s look at where these differences arise.</p>
<div class="sourceCode" id="cb523"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb523-1"><a href="factor-models.html#cb523-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s check why the two HML differentiate that much </span></span>
<span id="cb523-2"><a href="factor-models.html#cb523-2" aria-hidden="true" tabindex="-1"></a>CH_data_total_mont_check <span class="sc">%&gt;%</span> </span>
<span id="cb523-3"><a href="factor-models.html#cb523-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Total_Eq_t =</span> Total_Eq_t<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb523-4"><a href="factor-models.html#cb523-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Ticker, Date_t, Total_Eq_t, Total_Eq_Real) <span class="sc">%&gt;%</span> </span>
<span id="cb523-5"><a href="factor-models.html#cb523-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Diff_Equity =</span> <span class="fu">round</span>(Total_Eq_t <span class="sc">-</span> Total_Eq_Real,<span class="dv">3</span>),</span>
<span id="cb523-6"><a href="factor-models.html#cb523-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">Diff_Equity_Ratio =</span> <span class="fu">round</span>(Diff_Equity <span class="sc">/</span> ((Total_Eq_t <span class="sc">+</span> Total_Eq_Real)<span class="sc">/</span><span class="dv">2</span>),<span class="dv">3</span>),</span>
<span id="cb523-7"><a href="factor-models.html#cb523-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">Same_identifier =</span> <span class="fu">ifelse</span>(Total_Eq_t <span class="sc">==</span> Total_Eq_Real, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb523-8"><a href="factor-models.html#cb523-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Same_identifier <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb523-9"><a href="factor-models.html#cb523-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># As we can see, there are 16&#39;040 observations where the Total Equity value is different from one another </span></span>
<span id="cb523-10"><a href="factor-models.html#cb523-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>( <span class="fu">abs</span>(Diff_Equity_Ratio) <span class="sc">&gt;</span> <span class="fl">0.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb523-11"><a href="factor-models.html#cb523-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we now only consider large discrepancies (more than 10% deviation), we obtain 2&#39;255 observations </span></span>
<span id="cb523-12"><a href="factor-models.html#cb523-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="fu">abs</span>(Diff_Equity_Ratio) <span class="sc">&gt;</span> <span class="fl">0.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb523-13"><a href="factor-models.html#cb523-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we only consider the companies which have at at least one point in time a deviation of more than 10%, we would get 51 companies with a deviation of </span></span>
<span id="cb523-14"><a href="factor-models.html#cb523-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># more than 10%!</span></span>
<span id="cb523-15"><a href="factor-models.html#cb523-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Ticker) <span class="sc">%&gt;%</span> </span>
<span id="cb523-16"><a href="factor-models.html#cb523-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb523-17"><a href="factor-models.html#cb523-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Ticker)</span></code></pre></div>
<pre><code>## # A tibble: 115 × 1
##    Ticker
##    &lt;chr&gt; 
##  1 ABBN  
##  2 ACUN  
##  3 ADEN  
##  4 ADVN  
##  5 ADXN  
##  6 AEVS  
##  7 AIRE  
##  8 AIRN  
##  9 ALCN  
## 10 ALPH  
## # … with 105 more rows</code></pre>
<p>If we look at the HML factor, we understand that discrepancies can either arise in the Book Value or Market Capitalisation, whereas the Market Capitalisation consists of the Number of Shares as well as the unadjusted Share price. Although we don’t show it here, the Market Capitalisation data is very similar for both data providers, which implies that the discrepancies in returns arise based on the company Book Value. If we drill down on this metric, we can observe that for 16’400 observations the Book Value (Total Equity) is different depending on the database. Let’s now assume that the cumulative return discrepancies are mainly caused by large differences (e.g. &gt;10%) in Book Value. If we consider this, then we understand that 2’255 observations have a discrepancy of more than 10% for the book value, and that, overall, 115 companies show to have a deviation of more than 10% for the book value at least at one observational period. This is striking, as it shows that, even for two of the most mainstream data providers there appears to be large differences in data availability and calculation of basic accounting numbers such as a company’s book value.</p>
<p>Consequently, we can highlight the importance of cross-referencing and double checks with this simple exercise. Therefore, it is advisable to always stick to at least two calculation as well as database options when constructing factors. Based on that, you can then decide which strategy appears more reasonable for the task at hand.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="portfolio-theory-mean-variance-optimisation-and-the-capm.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/NikolasAnic/Advanced_Empirical_Finance_UZH_2022/edit/master/07-Factor_Models.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/NikolasAnic/Advanced_Empirical_Finance_UZH_2022/blob/master/07-Factor_Models.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
